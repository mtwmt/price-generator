import{a as pt,b,c as me,d as ce,e as ke,f as Be,g as $,h as O}from"./chunk-DXQWX5F5.js";import{a as ct}from"./chunk-6TUJNKHX.js";import{A as de,a as Ue,b as Fe,e as Q,f as k,g as He,h as B,j as ae,l as se,n as le,t as et,u as tt,v as it,y as Pe}from"./chunk-GSUG76OK.js";import{$ as C,$a as G,Ab as Ye,Ac as ue,Bb as d,C as ge,Cb as A,Db as D,Eb as we,Gb as J,Ha as T,Hb as Z,Ib as ee,M as F,Ma as ne,Mb as We,Nb as ve,O as K,Ob as be,Oc as rt,Qb as ye,R as W,Rb as Je,Tc as at,Ub as w,Vb as te,W as x,Xa as m,Xb as j,Ya as c,Yb as P,Yc as st,Zc as lt,_c as Ne,aa as g,ab as Y,bb as p,c as z,cb as a,cd as dt,db as s,eb as h,ed as qe,fb as oe,fd as ut,gb as re,gd as mt,ha as v,hb as Oe,hd as R,ic as Ae,id as V,j as Ce,k as N,kb as he,kc as Ze,lb as E,lc as De,m as Se,mb as Ge,nb as f,nc as M,ob as Ke,p as U,pb as u,uc as nt,va as H,vc as Te,ya as l,yb as xe,yc as ot,zb as X,zc as Me}from"./chunk-GDEVK5MX.js";import{a as Xe,b as Qe,g as S}from"./chunk-OXVY4BEJ.js";var pe=(()=>{let n=class n{constructor(){this.http=x(Fe),this.authService=x(B),this.apiUrl=`${k.portalApiUrl}/api/portal/user/donations`}submitDonation(i){return this.withAuth(o=>this.http.post(this.apiUrl,i,{headers:o}))}getMyDonations(){return this.withAuth(i=>this.http.get(`${this.apiUrl}/my`,{headers:i}))}withdrawDonation(i){return this.withAuth(o=>this.http.delete(`${this.apiUrl}/${i}`,{headers:o}))}markAsExpired(){return this.withAuth(i=>this.http.post(`${this.apiUrl}/mark-expired`,{},{headers:i}))}getProofSignedUrl(i){return this.withAuth(o=>this.http.get(`${this.apiUrl}/proof-url/${encodeURIComponent(i)}`,{headers:o}))}withAuth(i){return N(this.authService.getIdToken()).pipe(F(o=>{if(!o)return Se(()=>new Error("\u672A\u767B\u5165\u6216\u7121\u6CD5\u53D6\u5F97\u9A57\u8B49 Token"));let r=new Ue({Authorization:`Bearer ${o}`,"x-platform-key":"quotation"});return i(r)}))}};n.\u0275fac=function(o){return new(o||n)},n.\u0275prov=W({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var Dt=(e,n)=>({"border-warning bg-warning/10":e,"border-error bg-error/10":n}),Ut=(e,n)=>({"text-warning":e,"text-error":n});function Ft(e,n){if(e&1){let t=E();a(0,"div",9)(1,"input",11),ee("ngModelChange",function(o){C(t);let r=u();return Z(r.editingName,o)||(r.editingName=o),g(o)}),f("keyup.enter",function(){C(t);let o=u();return g(o.saveEditing())})("keyup.escape",function(){C(t);let o=u();return g(o.cancelEditing())}),s(),a(2,"button",12),f("click",function(){C(t);let o=u();return g(o.saveEditing())}),h(3,"lucide-icon",3),s(),a(4,"button",13),f("click",function(){C(t);let o=u();return g(o.cancelEditing())}),h(5,"lucide-icon",3),s()()}if(e&2){let t=u();l(),J("ngModel",t.editingName),l(2),p("img",t.Check)("size",16),l(2),p("img",t.X)("size",16)}}function Pt(e,n){e&1&&(a(0,"span",14),d(1,"\u7BA1\u7406\u54E1"),s())}function Tt(e,n){e&1&&(a(0,"span",15),d(1,"\u8D0A\u52A9\u6703\u54E1"),s())}function Mt(e,n){e&1&&(a(0,"span",16),d(1,"\u514D\u8CBB\u6703\u54E1"),s())}function Nt(e,n){if(e&1&&(a(0,"div",10),d(1),a(2,"span"),m(3,Pt,2,0,"span",14)(4,Tt,2,0,"span",15)(5,Mt,2,0,"span",16),s()()),e&2){let t=u();l(),D(" ",t.userDisplayName()," "),l(2),c(t.isAdmin()?3:t.isPremium()?4:5)}}function qt(e,n){if(e&1&&(a(0,"div",5),h(1,"lucide-icon",6),a(2,"div")(3,"div",8),d(4,"Email"),s(),a(5,"div",17),d(6),s()()()),e&2){let t=u();l(),p("img",t.Mail)("size",20),l(5),A(t.userEmail())}}function kt(e,n){if(e&1&&(a(0,"div",5),h(1,"lucide-icon",6),a(2,"div")(3,"div",8),d(4,"\u8A3B\u518A\u6642\u9593"),s(),a(5,"div",17),d(6),s()()()),e&2){let t=u();l(),p("img",t.Clock)("size",20),l(5),A(t.formattedCreatedAt())}}function Bt(e,n){if(e&1&&(a(0,"div",20),d(1," \u6703\u54E1\u5373\u5C07\u5230\u671F "),s(),a(2,"div",17),d(3),s()),e&2){let t=u(3);l(3),we(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil(),"\uFF08\u5269\u9918 ",t.daysUntilExpiry()," \u5929\uFF09 ")}}function Rt(e,n){if(e&1&&(a(0,"div",21),d(1,"\u6703\u54E1\u5DF2\u5230\u671F"),s(),a(2,"div",17),d(3),s()),e&2){let t=u(3);l(3),D(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil()," ")}}function Vt(e,n){if(e&1&&(a(0,"div",18),h(1,"lucide-icon",19),a(2,"div"),m(3,Bt,4,2)(4,Rt,4,1),s()()),e&2){let t=u(2);p("ngClass",We(5,Dt,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),l(),p("img",t.Calendar)("size",20)("ngClass",We(8,Ut,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),l(2),c(t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0?3:4)}}function Lt(e,n){if(e&1&&(a(0,"span",8),d(1),s()),e&2){let t=u(3);l(),D(" (\u5269\u9918 ",t.daysUntilExpiry()," \u5929) ")}}function It(e,n){if(e&1&&(a(0,"div",5),h(1,"lucide-icon",6),a(2,"div")(3,"div",8),d(4,"\u6703\u54E1\u5230\u671F\u65E5"),s(),a(5,"div",17),d(6),m(7,Lt,2,1,"span",8),s()()()),e&2){let t=u(2);l(),p("img",t.Calendar)("size",20),l(5),D(" ",t.formattedPremiumUntil()," "),l(),c(t.daysUntilExpiry()!==null?7:-1)}}function zt(e,n){if(e&1&&m(0,Vt,5,11,"div",18)(1,It,8,4,"div",5),e&2){let t=u();c(t.showExpiryWarning()?0:1)}}var Ct=(()=>{let n=class n{constructor(){this.userDisplayName=P.required(),this.userEmail=P(null),this.isPremium=P(!1),this.isAdmin=P(!1),this.formattedCreatedAt=P(null),this.formattedPremiumUntil=P(null),this.daysUntilExpiry=P(null),this.showExpiryWarning=P(!1),this.displayNameChange=j(),this.isEditing=v(!1),this.editingName=v(""),this.Crown=ue,this.User=qe,this.Mail=rt,this.Calendar=nt,this.Clock=Me,this.Pencil=at,this.Check=Te,this.X=mt}startEditing(){this.editingName.set(this.userDisplayName()),this.isEditing.set(!0)}cancelEditing(){this.isEditing.set(!1),this.editingName.set("")}saveEditing(){let i=this.editingName().trim();i&&i!==this.userDisplayName()&&this.displayNameChange.emit(i),this.isEditing.set(!1)}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-profile"]],inputs:{userDisplayName:[1,"userDisplayName"],userEmail:[1,"userEmail"],isPremium:[1,"isPremium"],isAdmin:[1,"isAdmin"],formattedCreatedAt:[1,"formattedCreatedAt"],formattedPremiumUntil:[1,"formattedPremiumUntil"],daysUntilExpiry:[1,"daysUntilExpiry"],showExpiryWarning:[1,"showExpiryWarning"]},outputs:{displayNameChange:"displayNameChange"},decls:16,vars:8,consts:[[1,"card","bg-base-100","shadow-sm","mb-6"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4","mt-4"],[1,"flex","items-center","gap-3"],[1,"text-base-content/70",3,"img","size"],[1,"flex-1"],[1,"text-sm","text-base-content/70"],[1,"flex","items-center","gap-2","mt-1"],[1,"font-medium","flex","items-center","gap-2"],["type","text","maxlength","50",1,"input","input-bordered","input-sm","flex-1","max-w-xs",3,"ngModelChange","keyup.enter","keyup.escape","ngModel"],["title","\u4FDD\u5B58",1,"btn","btn-success","btn-sm","btn-square",3,"click"],["title","\u53D6\u6D88",1,"btn","btn-ghost","btn-sm","btn-square",3,"click"],[1,"badge","badge-soft","badge-error","badge-sm"],[1,"badge","badge-soft","badge-warning","badge-sm"],[1,"badge","badge-soft","badge-sm"],[1,"font-medium"],[1,"flex","items-center","gap-3","p-3","rounded-lg","border",3,"ngClass"],[3,"img","size","ngClass"],[1,"text-sm","text-warning","font-semibold"],[1,"text-sm","text-error","font-semibold"]],template:function(o,r){o&1&&(a(0,"div",0)(1,"div",1)(2,"h2",2),h(3,"lucide-icon",3),d(4," \u6703\u54E1\u8CC7\u8A0A "),s(),a(5,"div",4)(6,"div",5),h(7,"lucide-icon",6),a(8,"div",7)(9,"div",8),d(10,"\u4F7F\u7528\u8005\u540D\u7A31"),s(),m(11,Ft,6,5,"div",9)(12,Nt,6,2,"div",10),s()(),m(13,qt,7,3,"div",5),m(14,kt,7,3,"div",5),m(15,zt,2,1),s()()()),o&2&&(l(3),p("img",r.User)("size",24),l(4),p("img",r.User)("size",20),l(4),c(r.isEditing()?11:12),l(2),c(r.userEmail()?13:-1),l(),c(r.formattedCreatedAt()?14:-1),l(),c(r.formattedPremiumUntil()?15:-1))},dependencies:[M,Ae,de,ae,se,Pe,le,V,R],encapsulation:2});let e=n;return e})();var gt=(()=>{let n=class n{constructor(){this.toastService=x(Q),this.submitDonation=j(),this.donationProof=v(null),this.donationNote=v(""),this.Crown=ue,this.Upload=dt}handleDonationProof(i){if(i.length===0)return;let o=i[0],r=new FileReader;r.onload=()=>{let _=r.result;this.donationProof.set(_)},r.onerror=()=>{this.toastService.error("\u6A94\u6848\u8B80\u53D6\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66")},r.readAsDataURL(o)}onSubmit(){let i=!!this.donationProof(),o=!!this.donationNote().trim();if(!i&&!o){this.toastService.error("\u8ACB\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u6216\u586B\u5BEB\u5099\u8A3B");return}this.submitDonation.emit({proof:this.donationProof()||"",note:this.donationNote()}),this.donationProof.set(null),this.donationNote.set("")}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-donation-form"]],outputs:{submitDonation:"submitDonation"},decls:27,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"text-base-content/70"],[1,"divider"],[1,"form-control"],[1,"label"],[1,"label-text","font-medium"],[3,"fileSelected","label","supportedFormats","accept","previewUrl"],[1,"form-control","mt-4"],["placeholder","\u8ACB\u8F38\u5165\u5099\u8A3B\uFF0C\u4F8B\u5982\uFF1A\u8F49\u5E33\u5E33\u865F\u5F8C\u4E94\u78BC\u3001\u8D0A\u52A9\u65E5\u671F\u7B49...","maxlength","500",1,"textarea","textarea-bordered","h-24","w-full",3,"ngModelChange","ngModel"],[1,"label","flex","justify-between"],[1,"label-text-alt"],[1,"card-actions","justify-end","mt-4"],["type","button",1,"btn","btn-warning","gap-2",3,"click","disabled"]],template:function(o,r){o&1&&(a(0,"div",0)(1,"div",1)(2,"h2",2),h(3,"lucide-icon",3),d(4," \u5347\u7D1A\u70BA\u8D0A\u52A9\u6703\u54E1 "),s(),a(5,"p",4),d(6," \u611F\u8B1D\u60A8\u7684\u652F\u6301\uFF01\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u5F8C\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\u4E26\u5347\u7D1A\u60A8\u7684\u6703\u54E1\u7B49\u7D1A\u3002 "),s(),h(7,"div",5),a(8,"div",6)(9,"label",7)(10,"span",8),d(11,"\u8D0A\u52A9\u6191\u8B49"),s()(),a(12,"app-file-upload",9),f("fileSelected",function(y){return r.handleDonationProof(y)}),s()(),a(13,"div",10)(14,"label",7)(15,"span",8),d(16,"\u5099\u8A3B"),s()(),a(17,"textarea",11),ee("ngModelChange",function(y){return Z(r.donationNote,y)||(r.donationNote=y),y}),s(),a(18,"label",12)(19,"span",13),d(20,"\u63D0\u4F9B\u66F4\u591A\u8CC7\u8A0A\u6709\u52A9\u65BC\u6211\u5011\u66F4\u5FEB\u5B8C\u6210\u5BE9\u6838"),s(),a(21,"span",13),d(22),s()()(),a(23,"div",14)(24,"button",15),f("click",function(){return r.onSubmit()}),h(25,"lucide-icon",3),d(26," \u63D0\u4EA4\u8D0A\u52A9\u7533\u8ACB "),s()()()()),o&2&&(l(3),p("img",r.Crown)("size",24),l(9),p("label","\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\uFF08\u8F49\u5E33\u622A\u5716\u6216\u6536\u64DA\uFF09")("supportedFormats","\u652F\u63F4 PNG\u3001JPG\u3001GIF")("accept","image/gif, image/jpeg, image/png")("previewUrl",r.donationProof()),l(5),J("ngModel",r.donationNote),l(5),D("",r.donationNote().length," / 500"),l(2),p("disabled",!r.donationProof()&&!r.donationNote().trim()),l(),p("img",r.Upload)("size",18))},dependencies:[M,de,ae,se,Pe,le,V,R,ct],encapsulation:2});let e=n;return e})();var Ve=(()=>{let n=class n{constructor(){this.http=x(Fe),this.authService=x(B),this.apiUrl=`${k.portalApiUrl}/api/portal/admin`}withAuth(i){return N(this.authService.getIdToken()).pipe(F(o=>{if(!o)return Se(()=>new Error("\u672A\u767B\u5165\u6216\u7121\u6CD5\u53D6\u5F97\u9A57\u8B49 Token"));let r=new Ue({Authorization:`Bearer ${o}`,"x-platform-key":"quotation"});return i(r)}))}getAllUsers(i){let o=i?`${this.apiUrl}/users?limit=${i}`:`${this.apiUrl}/users`;return this.withAuth(r=>this.http.get(o,{headers:r}))}getPendingDonations(){return this.withAuth(i=>this.http.get(`${this.apiUrl}/donations/pending`,{headers:i}))}getProcessedDonations(){return this.withAuth(i=>this.http.get(`${this.apiUrl}/donations/processed`,{headers:i}))}approveDonation(i){return this.withAuth(o=>this.http.post(`${this.apiUrl}/donations/${i}/approve`,{},{headers:o}))}rejectDonation(i){return this.withAuth(o=>this.http.post(`${this.apiUrl}/donations/${i}/reject`,{},{headers:o}))}resetDonationStatus(i){return this.withAuth(o=>this.http.post(`${this.apiUrl}/donations/${i}/reset`,{},{headers:o}))}updateUserRole(i,o,r){return this.withAuth(_=>this.http.patch(`${this.apiUrl}/users/${i}/role`,{role:o,premiumUntil:r},{headers:_}))}deleteUser(i){return this.withAuth(o=>this.http.delete(`${this.apiUrl}/users/${i}`,{headers:o}))}};n.\u0275fac=function(o){return new(o||n)},n.\u0275prov=W({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var jt={users:[],searchQuery:"",loading:!1,updating:!1,error:null},Le=me({providedIn:"root"},Be(jt),ce(({users:e,searchQuery:n})=>({totalUsers:w(()=>e().length),hasUsers:w(()=>e().length>0),filteredUsers:w(()=>{let t=n().toLowerCase().trim();return t?e().filter(i=>i.displayName?.toLowerCase().includes(t)||i.email?.toLowerCase().includes(t)):e()})})),ke((e,n=x(Ve),t=x(Q))=>({loadUsers:$(z(K(()=>b(e,{loading:!0,error:null})),F(i=>n.getAllUsers(i!=null&&typeof i=="number"?i:void 0).pipe(O({next:o=>{let r=He.mapMany(o.data);b(e,{users:r,loading:!1})},error:o=>{b(e,{error:o.message||"\u8F09\u5165\u4F7F\u7528\u8005\u5217\u8868\u5931\u6557",loading:!1}),t.error("\u8F09\u5165\u4F7F\u7528\u8005\u5217\u8868\u5931\u6557")}}))))),updateUserRole:$(z(K(()=>b(e,{updating:!0,error:null})),F(({uid:i,role:o,premiumUntil:r})=>n.updateUserRole(i,o,r).pipe(F(()=>(b(e,{updating:!1}),t.success("\u4F7F\u7528\u8005\u6B0A\u9650\u5DF2\u66F4\u65B0"),n.getAllUsers().pipe(ge(()=>Ce)))),O({next:_=>{let y=He.mapMany(_.data);b(e,{users:y})},error:_=>{b(e,{error:_.message||"\u66F4\u65B0\u4F7F\u7528\u8005\u6B0A\u9650\u5931\u6557",updating:!1}),t.error("\u66F4\u65B0\u4F7F\u7528\u8005\u6B0A\u9650\u5931\u6557")}}))))),deleteUser:$(z(K(()=>b(e,{updating:!0,error:null})),F(i=>n.deleteUser(i).pipe(O({next:()=>{let o=e.users().filter(r=>r.uid!==i);b(e,{users:o,updating:!1}),t.success("\u4F7F\u7528\u8005\u5DF2\u522A\u9664")},error:o=>{b(e,{error:o.message||"\u522A\u9664\u4F7F\u7528\u8005\u5931\u6557",updating:!1}),t.error("\u522A\u9664\u4F7F\u7528\u8005\u5931\u6557")}}))))),clearError(){b(e,{error:null})},setSearchQuery(i){b(e,{searchQuery:i})}})));function ie(e){if(e==null||e==="")return null;let n;return e instanceof Date?n=e:typeof e=="number"?n=new Date(e):typeof e=="string"?!isNaN(Number(e))&&e.trim()!==""?n=new Date(Number(e)):n=new Date(e):typeof e.toDate=="function"?n=e.toDate():n=new Date(e),isNaN(n.getTime())?null:n}function _e(e){let n=ie(e);return n?n.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})+" "+n.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!1}):"-"}function Ee(e,n=new Date){let t=ie(e);if(!t)return null;let i=t.getTime()-n.getTime();return Math.ceil(i/(1e3*60*60*24))}function $t(e,n){if(e&1&&h(0,"img",5),e&2){let t=u();p("src",t.user().photoURL,H)("alt",t.user().displayName)}}function Ot(e,n){if(e&1){let t=E();a(0,"div",8)(1,"label",9)(2,"span",10),d(3,"\u8D0A\u52A9\u5230\u671F\u65E5"),s()(),a(4,"input",18),ee("ngModelChange",function(o){C(t);let r=u();return Z(r.premiumUntilDate,o)||(r.premiumUntilDate=o),g(o)}),s(),a(5,"label",9)(6,"span",19),d(7,"\u8A2D\u5B9A\u8D0A\u52A9\u6703\u54E1\u7684\u6709\u6548\u671F\u9650"),s()()()}if(e&2){let t=u();l(4),J("ngModel",t.premiumUntilDate)}}var Ie=(()=>{let n=class n{constructor(){this.user=P.required(),this.save=j(),this.cancel=j(),this.selectedRole=v("free"),this.premiumUntilDate=v(""),te(()=>{let o=this.user().platforms.quotation;if(this.selectedRole.set(o?.role||"free"),o?.premiumUntil){let r=ie(o.premiumUntil);r?this.premiumUntilDate.set(r.toISOString().split("T")[0]):this.premiumUntilDate.set("")}else this.premiumUntilDate.set("")})}handleCancel(){this.cancel.emit()}handleSave(){let i={role:this.selectedRole()};if(this.selectedRole()==="premium"&&this.premiumUntilDate()){let o=new Date(this.premiumUntilDate());i.premiumUntil=o.getTime()}else i.premiumUntil=null;this.save.emit(i)}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-edit-form"]],inputs:{user:[1,"user"]},outputs:{save:"save",cancel:"cancel"},decls:29,vars:5,consts:[[1,"font-bold","text-lg","mb-4"],[1,"mb-4","p-4","bg-base-200","rounded-lg"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-12","h-12","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"text-sm","text-base-content/60"],[1,"form-control","mb-4"],[1,"label"],[1,"label-text","font-medium"],[1,"select","select-bordered",3,"ngModelChange","ngModel"],["value","free"],["value","premium"],["value","admin"],[1,"flex","justify-end","gap-2","mt-6"],["type","button",1,"btn","btn-ghost",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","date",1,"input","input-bordered",3,"ngModelChange","ngModel"],[1,"label-text-alt"]],template:function(o,r){o&1&&(a(0,"h3",0),d(1,"\u7DE8\u8F2F\u4F7F\u7528\u8005\u6B0A\u9650"),s(),a(2,"div",1)(3,"div",2)(4,"div",3)(5,"div",4),m(6,$t,1,2,"img",5),s()(),a(7,"div")(8,"div",6),d(9),s(),a(10,"div",7),d(11),s()()()(),a(12,"div",8)(13,"label",9)(14,"span",10),d(15,"\u89D2\u8272"),s()(),a(16,"select",11),ee("ngModelChange",function(y){return Z(r.selectedRole,y)||(r.selectedRole=y),y}),a(17,"option",12),d(18,"\u514D\u8CBB\u6703\u54E1"),s(),a(19,"option",13),d(20,"\u8D0A\u52A9\u6703\u54E1"),s(),a(21,"option",14),d(22,"\u7BA1\u7406\u54E1"),s()()(),m(23,Ot,8,1,"div",8),a(24,"div",15)(25,"button",16),f("click",function(){return r.handleCancel()}),d(26," \u53D6\u6D88 "),s(),a(27,"button",17),f("click",function(){return r.handleSave()}),d(28," \u5132\u5B58 "),s()()),o&2&&(l(6),c(r.user().photoURL?6:-1),l(3),A(r.user().displayName||"\u672A\u547D\u540D"),l(2),A(r.user().email),l(5),J("ngModel",r.selectedRole),l(7),c(r.selectedRole()==="premium"?23:-1))},dependencies:[M,de,tt,it,ae,et,se,le],encapsulation:2});let e=n;return e})();function ht(e){return{free:"\u514D\u8CBB\u6703\u54E1",premium:"\u8D0A\u52A9\u6703\u54E1",admin:"\u7BA1\u7406\u54E1"}[e]||e}function xt(e){return{free:"badge-ghost",premium:"badge-warning",admin:"badge-error"}[e]||"badge-ghost"}function Kt(e){let n=e.platforms.quotation,t=n?.role||"free",i=n?.premiumUntil,o=Ee(i);return{user:e,displayName:e.displayName||"Unknown",email:e.email||"No Email",uidShort:e.uid.substring(0,8),role:t,roleDisplayName:ht(t),roleBadgeClass:xt(t),premiumUntilFormatted:i?_e(i):null,daysUntilExpiry:o,isExpired:t==="premium"&&o!==null&&o<0,createdAtFormatted:e.createdAt?_e(e.createdAt):"-"}}function vt(e){return e.map(Kt)}var Wt=(e,n)=>n.user.uid;function Ht(e,n){e&1&&h(0,"span",7)}function Xt(e,n){if(e&1&&h(0,"lucide-icon",5),e&2){let t=u();p("img",t.RefreshCw)("size",16)}}function Qt(e,n){e&1&&(a(0,"div",11),h(1,"span",14),s())}function Gt(e,n){if(e&1&&(a(0,"div",12),h(1,"lucide-icon",15),a(2,"p"),d(3,"\u76EE\u524D\u6C92\u6709\u4F7F\u7528\u8005\u8CC7\u6599"),s()()),e&2){let t=u();l(),p("img",t.Users)("size",48)}}function Yt(e,n){if(e&1&&h(0,"img",24),e&2){let t=u().$implicit;p("src",t.user.photoURL,H)("alt",t.displayName)}}function Jt(e,n){if(e&1&&(a(0,"span",26),h(1,"lucide-icon",5),d(2," \u8D0A\u52A9\u6703\u54E1\uFF08\u5DF2\u904E\u671F\uFF09 "),s()),e&2){let t=u(3);l(),p("img",t.Crown)("size",12)}}function Zt(e,n){if(e&1&&h(0,"lucide-icon",5),e&2){let t=u(4);p("img",t.Shield)("size",12)}}function ei(e,n){if(e&1&&h(0,"lucide-icon",5),e&2){let t=u(4);p("img",t.Crown)("size",12)}}function ti(e,n){if(e&1&&(a(0,"span",26),m(1,Zt,1,2,"lucide-icon",5)(2,ei,1,2,"lucide-icon",5),d(3),s()),e&2){let t=u().$implicit;Ye(t.roleBadgeClass),l(),c(t.role==="admin"?1:t.role==="premium"?2:-1),l(2),D(" ",t.roleDisplayName," ")}}function ii(e,n){if(e&1&&(a(0,"div",33),d(1),s()),e&2){let t=u(2).$implicit;X("text-error",t.daysUntilExpiry<7)("text-warning",t.daysUntilExpiry>=7&&t.daysUntilExpiry<30),l(),D(" (\u5269\u9918 ",t.daysUntilExpiry," \u5929) ")}}function ni(e,n){if(e&1&&(a(0,"div")(1,"div"),d(2),s(),m(3,ii,2,5,"div",32),s()),e&2){let t=u().$implicit;l(2),A(t.premiumUntilFormatted),l(),c(t.daysUntilExpiry!==null&&t.daysUntilExpiry>0?3:-1)}}function oi(e,n){e&1&&(a(0,"span",28),d(1,"-"),s())}function ri(e,n){if(e&1){let t=E();a(0,"button",34),f("click",function(){C(t);let o=u().$implicit,r=u(2);return g(r.confirmDelete(o.user))}),d(1," \u522A\u9664 "),s()}}function ai(e,n){if(e&1){let t=E();a(0,"tr")(1,"td")(2,"div",21)(3,"div",22)(4,"div",23),m(5,Yt,1,2,"img",24),s()(),a(6,"div")(7,"div",25),d(8),s()()()(),a(9,"td"),d(10),s(),a(11,"td"),m(12,Jt,3,2,"span",26)(13,ti,4,4,"span",27),s(),a(14,"td"),m(15,ni,4,2,"div")(16,oi,2,0,"span",28),s(),a(17,"td"),d(18),s(),a(19,"td")(20,"div",29)(21,"button",30),f("click",function(){let o=C(t).$implicit,r=u(2);return g(r.startEdit(o.user))}),d(22," \u7DE8\u8F2F "),s(),m(23,ri,2,0,"button",31),s()()()}if(e&2){let t=n.$implicit;l(5),c(t.user.photoURL?5:-1),l(3),D(" ",t.displayName," "),l(2),A(t.email),l(2),c(t.isExpired?12:13),l(3),c(t.premiumUntilFormatted?15:16),l(3),A(t.createdAtFormatted),l(5),c(t.role==="free"?23:-1)}}function si(e,n){if(e&1){let t=E();a(0,"div",16)(1,"table",17)(2,"thead")(3,"tr")(4,"th"),d(5,"\u4F7F\u7528\u8005"),s(),a(6,"th"),d(7,"Email"),s(),a(8,"th",18),d(9,"\u89D2\u8272"),s(),a(10,"th",19),d(11,"\u8D0A\u52A9\u5230\u671F\u65E5"),s(),a(12,"th",19),d(13,"\u8A3B\u518A\u6642\u9593"),s(),a(14,"th",19),d(15,"\u64CD\u4F5C"),s()()(),a(16,"tbody"),G(17,ai,24,7,"tr",null,Wt),s()()(),a(19,"app-pagination",20),f("pageChange",function(o){C(t);let r=u();return g(r.onPageChange(o))})("pageSizeChange",function(o){C(t);let r=u();return g(r.onPageSizeChange(o))}),s()}if(e&2){let t=u();l(17),Y(t.paginatedUsersDisplay()),l(2),p("totalItems",t.totalUsers())("pageSize",t.pageSize())("currentPage",t.currentPage())}}function li(e,n){if(e&1){let t=E();a(0,"dialog",13)(1,"div",35)(2,"app-user-edit-form",36),f("save",function(o){C(t);let r=u();return g(r.handleSave(o))})("cancel",function(){C(t);let o=u();return g(o.cancelEdit())}),s()(),a(3,"form",37),f("click",function(){C(t);let o=u();return g(o.cancelEdit())}),a(4,"button"),d(5,"close"),s()()()}if(e&2){let t=u();l(2),p("user",t.editingUser())}}var bt=(()=>{let n=class n{constructor(){this.usersStore=x(Le),this.Users=ut,this.Crown=ue,this.Shield=Ne,this.Search=lt,this.RefreshCw=st,this.currentPage=v(1),this.pageSize=v(10),this.editingUser=v(null),this.totalUsers=w(()=>this.usersStore.filteredUsers().length),this.hasUsers=w(()=>this.usersStore.users().length>0),this.paginatedUsersDisplay=w(()=>{let i=this.usersStore.filteredUsers(),o=this.currentPage(),r=this.pageSize(),_=(o-1)*r,y=_+r;return vt(i.slice(_,y))})}ngOnInit(){this.usersStore.hasUsers()||this.usersStore.loadUsers()}onRefresh(){this.usersStore.loadUsers()}onPageChange(i){this.currentPage.set(i)}onPageSizeChange(i){this.pageSize.set(i),this.currentPage.set(1)}onSearchChange(i){this.usersStore.setSearchQuery(i),this.currentPage.set(1)}startEdit(i){this.editingUser.set(i)}cancelEdit(){this.editingUser.set(null)}handleSave(i){let o=this.editingUser();o&&(this.usersStore.updateUserRole({uid:o.uid,role:i.role,premiumUntil:i.premiumUntil??null}),this.cancelEdit())}confirmDelete(i){let o=i.displayName||i.email||i.uid;confirm(`\u78BA\u5B9A\u8981\u522A\u9664\u4F7F\u7528\u8005\u300C${o}\u300D\u55CE\uFF1F\u6B64\u64CD\u4F5C\u7121\u6CD5\u5FA9\u539F\u3002`)&&this.usersStore.deleteUser(i.uid)}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-list"]],decls:17,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"flex","flex-wrap","items-center","justify-between","gap-3","mb-4"],[1,"flex","items-center","gap-2"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],["type","button","title","\u91CD\u65B0\u6574\u7406",1,"btn","btn-sm","btn-ghost","btn-square",3,"click","disabled"],[1,"loading","loading-spinner","loading-sm"],[1,"input","input-sm","input-bordered","flex","items-center","gap-2"],[1,"opacity-50",3,"img","size"],["type","search","placeholder","\u641C\u5C0B\u540D\u7A31\u6216 Email...",1,"grow",3,"input","value"],[1,"flex","justify-center","py-8"],[1,"text-center","py-8","text-base-content/60"],[1,"modal","modal-open"],[1,"loading","loading-spinner","loading-lg"],[1,"mx-auto","mb-2","opacity-30",3,"img","size"],[1,"overflow-x-auto"],[1,"table","table-zebra"],[1,"w-28"],[1,"w-32"],[3,"pageChange","pageSizeChange","totalItems","pageSize","currentPage"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-10","h-10","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"badge","badge-soft","gap-1","whitespace-nowrap"],[1,"badge","badge-soft","gap-1","whitespace-nowrap",3,"class"],[1,"text-base-content/40"],[1,"join"],["type","button",1,"btn","btn-sm","btn-ghost","join-item",3,"click"],["type","button",1,"btn","btn-sm","btn-ghost","text-error","join-item"],[1,"text-xs",3,"text-error","text-warning"],[1,"text-xs"],["type","button",1,"btn","btn-sm","btn-ghost","text-error","join-item",3,"click"],[1,"modal-box"],[3,"save","cancel","user"],["method","dialog",1,"modal-backdrop",3,"click"]],template:function(o,r){o&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"h2",4),h(5,"lucide-icon",5),d(6," \u4F7F\u7528\u8005\u7BA1\u7406 "),s(),a(7,"button",6),f("click",function(){return r.onRefresh()}),m(8,Ht,1,0,"span",7)(9,Xt,1,2,"lucide-icon",5),s()(),a(10,"label",8),h(11,"lucide-icon",9),a(12,"input",10),f("input",function(y){return r.onSearchChange(y.target.value)}),s()()(),m(13,Qt,2,0,"div",11)(14,Gt,4,2,"div",12)(15,si,20,3),s()(),m(16,li,6,1,"dialog",13)),o&2&&(l(5),p("img",r.Users)("size",24),l(2),X("btn-disabled",r.usersStore.loading()),p("disabled",r.usersStore.loading()),l(),c(r.usersStore.loading()?8:9),l(3),p("img",r.Search)("size",16),l(),p("value",r.usersStore.searchQuery()),l(),c(r.usersStore.loading()?13:r.hasUsers()?15:14),l(3),c(r.editingUser()?16:-1))},dependencies:[M,V,R,pt,Ie],encapsulation:2});let e=n;return e})();function di(e,n){e&1&&(oe(0,"div",3),Oe(1,"span",9),re())}function ui(e,n){if(e&1&&Oe(0,"img",4),e&2){let t=u(2);Ge("src",t.resolvedUrl(),H)}}function mi(e,n){e&1&&(oe(0,"p",5),d(1,"\u7121\u6CD5\u8F09\u5165\u6191\u8B49\u5716\u7247"),re())}function ci(e,n){if(e&1){let t=E();oe(0,"dialog",0)(1,"div",1)(2,"h3",2),d(3),re(),m(4,di,2,0,"div",3)(5,ui,1,1,"img",4)(6,mi,2,0,"p",5),oe(7,"div",6)(8,"button",7),Ke("click",function(){C(t);let o=u();return g(o.onClose())}),d(9,"\u95DC\u9589"),re()()(),oe(10,"div",8),Ke("click",function(o){C(t);let r=u();return g(r.onBackdropClick(o))}),re()()}if(e&2){let t=u();l(3),A(t.title()),l(),c(t.loading()?4:t.resolvedUrl()?5:6)}}var ze=(()=>{let n=class n{constructor(){this.donationApi=x(pe),this.isOpen=P(!1),this.proofKey=P(""),this.title=P("\u8D0A\u52A9\u6191\u8B49"),this.close=j(),this.resolvedUrl=v(""),this.loading=v(!1),te(()=>{let i=this.proofKey();this.isOpen()&&i&&(i.startsWith("data:image")?this.resolvedUrl.set(i):this.loadSignedUrl(i))})}loadSignedUrl(i){return S(this,null,function*(){this.loading.set(!0);try{let o=yield U(this.donationApi.getProofSignedUrl(i)),r=`${k.portalApiUrl}/api/portal/user`;this.resolvedUrl.set(`${r}${o.url}`)}catch{console.error("[ProofModal] Failed to load signed URL"),this.resolvedUrl.set("")}finally{this.loading.set(!1)}})}onClose(){this.resolvedUrl.set(""),this.close.emit()}onBackdropClick(i){i.target===i.currentTarget&&this.onClose()}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-proof-modal"]],inputs:{isOpen:[1,"isOpen"],proofKey:[1,"proofKey"],title:[1,"title"]},outputs:{close:"close"},decls:1,vars:1,consts:[[1,"modal","modal-open"],[1,"modal-box"],[1,"font-bold","text-lg","mb-4"],[1,"flex","justify-center","py-8"],["alt","\u6191\u8B49","loading","lazy",1,"w-full","rounded-lg",3,"src"],[1,"text-center","text-base-content/50","py-8"],[1,"modal-action"],[1,"btn",3,"click"],[1,"modal-backdrop",3,"click"],[1,"loading","loading-spinner","loading-lg"]],template:function(o,r){o&1&&m(0,ci,11,2,"dialog",0),o&2&&c(r.isOpen()?0:-1)},dependencies:[M],encapsulation:2});let e=n;return e})();var fe=class{static mapMany(n){return n.map(t=>this.mapOne(t))}static mapOne(n){let t=n.proof||"",i=t.startsWith("data:image");return{id:n.id,uid:n.uid,userDisplayName:n.userDisplayName||"\u672A\u77E5\u4F7F\u7528\u8005",userEmail:n.userEmail||"-",proof:i?t:"",proofKey:i?void 0:t||void 0,note:(n.note||"").replace(/\\n/g,`
`),status:n.status,createdAt:n.createdAt,updatedAt:n.updatedAt,reviewedBy:n.reviewedBy||void 0,reviewedAt:n.reviewedAt||void 0}}};var yt=(()=>{let n=class n{constructor(){this.NOTIFICATION_URL=k.googleSheets.notificationUrl}sendSponsorApprovalEmail(i,o){return S(this,null,function*(){if(!this.NOTIFICATION_URL){console.warn("GAS Web App URL not configured, skipping email notification");return}try{let r=yield fetch(this.NOTIFICATION_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"sendApprovalEmail",email:i,userName:o})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);console.log("Sponsor approval email sent successfully")}catch(r){console.error("Failed to send sponsor approval email:",r)}})}};n.\u0275fac=function(o){return new(o||n)},n.\u0275prov=W({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var je=me({providedIn:"root"},ce(()=>{let e=x(B);return{userData:w(()=>e.userData()),userDisplayName:w(()=>e.userDisplayName()),userEmail:w(()=>e.userEmail()),isPremium:w(()=>e.isPremium()),isAdmin:w(()=>e.isAdmin()),formattedCreatedAt:w(()=>{let n=e.userData()?.createdAt;return n?_e(n):null}),formattedPremiumUntil:w(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;return n?_e(n):null}),daysUntilExpiry:w(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;return Ee(n)}),showExpiryWarning:w(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;if(!n)return!1;let t=Ee(n);return t!==null&&t<=7}),currentRole:w(()=>e.userData()?.platforms.quotation?.role||"free")}}));var $e=(()=>{let n=class n{constructor(){this.donationApi=x(pe),this.adminApi=x(Ve),this.notificationService=x(yt),this.profileStore=x(je)}createOrUpdateRequest(i,o,r,_,y,I=!1){return S(this,null,function*(){try{if(this.profileStore.isAdmin())throw new Error("\u7BA1\u7406\u54E1\u4E0D\u9700\u8981\u7533\u8ACB\u8D0A\u52A9\uFF0C\u60A8\u5DF2\u64C1\u6709\u6240\u6709\u6B0A\u9650");yield U(this.donationApi.submitDonation({note:y,proof:_}))}catch(q){throw console.error("Failed to create or update donation request:",q),q}})}getPendingRequests(){return S(this,null,function*(){try{let i=yield U(this.adminApi.getPendingDonations());return fe.mapMany(i.data)}catch(i){throw console.error("Failed to get pending requests:",i),i}})}getMyRequests(i){return S(this,null,function*(){try{let o=yield U(this.donationApi.getMyDonations());return fe.mapMany(o.data)}catch(o){throw console.error("Failed to get my requests:",o),o}})}approveRequest(i,o,r,_,y){return S(this,null,function*(){try{yield U(this.adminApi.approveDonation(i));let I=720*60*60*1e3,q=Date.now()+I;yield U(this.adminApi.updateUserRole(r,"premium",q)),yield this.notificationService.sendSponsorApprovalEmail(_,y)}catch(I){throw console.error("Failed to approve request:",I),I}})}rejectRequest(i,o,r){return S(this,null,function*(){try{yield U(this.adminApi.rejectDonation(i)),yield U(this.adminApi.updateUserRole(r,"free",null))}catch(_){throw console.error("Failed to reject request:",_),_}})}withdrawRequest(i,o){return S(this,null,function*(){try{yield U(this.donationApi.withdrawDonation(i))}catch(r){throw console.error("Failed to withdraw request:",r),r}})}getProcessedRequests(){return S(this,null,function*(){try{let i=yield U(this.adminApi.getProcessedDonations());return fe.mapMany(i.data)}catch(i){throw console.error("Failed to get processed requests:",i),i}})}resetRequestStatus(i){return S(this,null,function*(){try{yield U(this.adminApi.resetDonationStatus(i))}catch(o){throw console.error("Failed to reset request status:",o),o}})}markAsExpired(i){return S(this,null,function*(){try{yield U(this.donationApi.markAsExpired())}catch(o){throw console.error("Failed to mark as expired:",o),o}})}};n.\u0275fac=function(o){return new(o||n)},n.\u0275prov=W({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var Et=(e,n)=>n.id;function pi(e,n){if(e&1&&(a(0,"span",8),d(1),s()),e&2){let t=u();l(),A(t.pendingRequests().length)}}function _i(e,n){e&1&&h(0,"app-user-list")}function fi(e,n){if(e&1&&(a(0,"span",8),d(1),s()),e&2){let t=u(2);l(),A(t.pendingRequests().length)}}function Ci(e,n){e&1&&(a(0,"div",12),h(1,"span",14),s())}function gi(e,n){if(e&1){let t=E();a(0,"tr")(1,"td"),d(2),be(3,"date"),s(),a(4,"td")(5,"div",16),d(6),s(),a(7,"div",17),d(8),s()(),a(9,"td")(10,"button",18),f("click",function(){let o=C(t).$implicit,r=u(4);return g(r.openProofModal(o.proofKey||o.proof))}),d(11," \u67E5\u770B\u6191\u8B49 "),s()(),a(12,"td",19),d(13),s(),a(14,"td")(15,"div",20)(16,"button",21),f("click",function(){let o=C(t).$implicit,r=u(4);return g(r.approveRequest(o))}),d(17," \u6838\u51C6 "),s(),a(18,"button",22),f("click",function(){let o=C(t).$implicit,r=u(4);return g(r.rejectRequest(o))}),d(19," \u62D2\u7D55 "),s()()()()}if(e&2){let t=n.$implicit,i=u(4);l(2),D(" ",ye(3,6,t.createdAt,"yyyy/MM/dd HH:mm")," "),l(4),A(t.userDisplayName),l(2),D(" ",t.userEmail," "),l(5),D(" ",t.note||"-"," "),l(3),p("disabled",i.processing()),l(2),p("disabled",i.processing())}}function hi(e,n){e&1&&(a(0,"tr")(1,"td",23),d(2," \u76EE\u524D\u6C92\u6709\u5F85\u5BE9\u6838\u7684\u7533\u8ACB "),s()())}function xi(e,n){if(e&1&&(a(0,"div",13)(1,"table",15)(2,"thead")(3,"tr")(4,"th"),d(5,"\u7533\u8ACB\u6642\u9593"),s(),a(6,"th"),d(7,"\u4F7F\u7528\u8005"),s(),a(8,"th"),d(9,"\u6191\u8B49"),s(),a(10,"th"),d(11,"\u5099\u8A3B"),s(),a(12,"th"),d(13,"\u64CD\u4F5C"),s()()(),a(14,"tbody"),G(15,gi,20,9,"tr",null,Et),m(17,hi,3,0,"tr"),s()()()),e&2){let t=u(3);l(15),Y(t.pendingRequests()),l(2),c(t.pendingRequests().length===0?17:-1)}}function vi(e,n){if(e&1&&m(0,Ci,2,0,"div",12)(1,xi,18,1,"div",13),e&2){let t=u(2);c(t.donationLoading()?0:1)}}function bi(e,n){e&1&&(a(0,"div",12),h(1,"span",14),s())}function yi(e,n){e&1&&(a(0,"span",24),d(1,"\u5DF2\u6838\u51C6"),s())}function Ei(e,n){e&1&&(a(0,"span",25),d(1,"\u5DF2\u904E\u671F"),s())}function Si(e,n){e&1&&(a(0,"span",26),d(1,"\u5DF2\u53D6\u6D88"),s())}function wi(e,n){e&1&&(a(0,"span",27),d(1,"\u5DF2\u62D2\u7D55"),s())}function Ai(e,n){if(e&1){let t=E();a(0,"button",31),f("click",function(){C(t);let o=u().$implicit,r=u(4);return g(r.startEditFromRequest(o))}),d(1," \u7DE8\u8F2F "),s()}}function Di(e,n){if(e&1){let t=E();a(0,"button",32),f("click",function(){C(t);let o=u().$implicit,r=u(4);return g(r.resetRequest(o))}),d(1," \u91CD\u65B0\u5BE9\u6838 "),s()}if(e&2){let t=u(5);p("disabled",t.processing())}}function Ui(e,n){e&1&&(a(0,"span",17),d(1,"-"),s())}function Fi(e,n){if(e&1){let t=E();a(0,"tr")(1,"td"),d(2),be(3,"date"),s(),a(4,"td")(5,"div",16),d(6),s(),a(7,"div",17),d(8),s()(),a(9,"td"),m(10,yi,2,0,"span",24)(11,Ei,2,0,"span",25)(12,Si,2,0,"span",26)(13,wi,2,0,"span",27),s(),a(14,"td")(15,"button",18),f("click",function(){let o=C(t).$implicit,r=u(4);return g(r.openProofModal(o.proofKey||o.proof))}),d(16," \u67E5\u770B\u6191\u8B49 "),s()(),a(17,"td",19),d(18),s(),a(19,"td")(20,"div",28),m(21,Ai,2,0,"button",29),m(22,Di,2,1,"button",30)(23,Ui,2,0,"span",17),s()()()}if(e&2){let t=n.$implicit;l(2),D(" ",ye(3,7,t.updatedAt,"yyyy/MM/dd HH:mm")," "),l(4),A(t.userDisplayName),l(2),D(" ",t.userEmail," "),l(2),c(t.status==="approved"?10:t.status==="expired"?11:t.reviewedBy===t.uid?12:13),l(8),D(" ",t.note||"-"," "),l(3),c(t.status==="approved"?21:-1),l(),c((t.status==="approved"||t.status==="rejected")&&t.reviewedBy!==t.uid?22:23)}}function Pi(e,n){e&1&&(a(0,"tr")(1,"td",33),d(2," \u76EE\u524D\u6C92\u6709\u5DF2\u8655\u7406\u7684\u7533\u8ACB "),s()())}function Ti(e,n){if(e&1&&(a(0,"div",13)(1,"table",15)(2,"thead")(3,"tr")(4,"th"),d(5,"\u5BE9\u6838\u6642\u9593"),s(),a(6,"th"),d(7,"\u4F7F\u7528\u8005"),s(),a(8,"th"),d(9,"\u72C0\u614B"),s(),a(10,"th"),d(11,"\u6191\u8B49"),s(),a(12,"th"),d(13,"\u5099\u8A3B"),s(),a(14,"th"),d(15,"\u64CD\u4F5C"),s()()(),a(16,"tbody"),G(17,Fi,24,10,"tr",null,Et),m(19,Pi,3,0,"tr"),s()()()),e&2){let t=u(3);l(17),Y(t.processedRequests()),l(2),c(t.processedRequests().length===0?19:-1)}}function Mi(e,n){if(e&1&&m(0,bi,2,0,"div",12)(1,Ti,20,1,"div",13),e&2){let t=u(2);c(t.donationLoading()?0:1)}}function Ni(e,n){if(e&1){let t=E();a(0,"div",11)(1,"a",7),f("click",function(){C(t);let o=u();return g(o.switchDonationTab("pending"))}),d(2," \u5F85\u5BE9\u6838 "),m(3,fi,2,1,"span",8),s(),a(4,"a",7),f("click",function(){C(t);let o=u();return g(o.switchDonationTab("history"))}),d(5," \u5DF2\u8655\u7406 "),s()(),m(6,vi,2,1)(7,Mi,2,1)}if(e&2){let t=u();l(),X("tab-active",t.donationTab()==="pending"),l(2),c(t.pendingRequests().length>0?3:-1),l(),X("tab-active",t.donationTab()==="history"),l(2),c(t.donationTab()==="pending"?6:7)}}function qi(e,n){if(e&1){let t=E();a(0,"dialog",10)(1,"div",34)(2,"app-user-edit-form",35),f("save",function(o){C(t);let r=u();return g(r.handleSaveEdit(o))})("cancel",function(){C(t);let o=u();return g(o.cancelEdit())}),s()(),a(3,"form",36),f("click",function(){C(t);let o=u();return g(o.cancelEdit())}),a(4,"button"),d(5,"close"),s()()()}if(e&2){let t=u();l(2),p("user",t.editingUser())}}var St=(()=>{let n=class n{constructor(){this.donationService=x($e),this.toastService=x(Q),this.authService=x(B),this.usersStore=x(Le),this.pendingRequests=v([]),this.processedRequests=v([]),this.activeTab=v("users"),this.donationTab=v("pending"),this.donationLoading=v(!1),this.isProofModalOpen=v(!1),this.selectedProofKey=v(""),this.processing=v(!1),this.editingUser=v(null),this.Shield=Ne}switchTab(i){this.activeTab.set(i),i==="donations"&&this.loadPendingRequests()}switchDonationTab(i){this.donationTab.set(i),i==="pending"?this.loadPendingRequests():this.loadProcessedRequests()}loadPendingRequests(){return S(this,null,function*(){this.donationLoading.set(!0);try{let i=yield this.donationService.getPendingRequests();this.pendingRequests.set(i)}catch(i){console.error("Failed to load pending requests:",i),this.toastService.error("\u8F09\u5165\u7533\u8ACB\u5931\u6557")}finally{this.donationLoading.set(!1)}})}loadProcessedRequests(){return S(this,null,function*(){this.donationLoading.set(!0);try{let i=yield this.donationService.getProcessedRequests();this.processedRequests.set(i)}catch(i){console.error("Failed to load processed requests:",i),this.toastService.error("\u8F09\u5165\u6B77\u53F2\u7D00\u9304\u5931\u6557")}finally{this.donationLoading.set(!1)}})}openProofModal(i){this.selectedProofKey.set(i),this.isProofModalOpen.set(!0)}closeProofModal(){this.isProofModalOpen.set(!1),this.selectedProofKey.set("")}approveRequest(i){return S(this,null,function*(){if(!this.processing()&&confirm(`\u78BA\u5B9A\u8981\u6838\u51C6 ${i.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`)){this.processing.set(!0);try{let o=this.authService.currentUser();if(!o)return;yield this.donationService.approveRequest(i.id,o.uid,i.uid,i.userEmail,i.userDisplayName),this.toastService.success("\u5DF2\u6838\u51C6\u7533\u8ACB"),yield this.loadPendingRequests(),this.usersStore.loadUsers()}catch(o){console.error("Failed to approve request:",o),this.toastService.error("\u6838\u51C6\u5931\u6557")}finally{this.processing.set(!1)}}})}rejectRequest(i){return S(this,null,function*(){if(!this.processing()&&confirm(`\u78BA\u5B9A\u8981\u62D2\u7D55 ${i.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`)){this.processing.set(!0);try{let o=this.authService.currentUser();if(!o)return;yield this.donationService.rejectRequest(i.id,o.uid,i.uid),this.toastService.success("\u5DF2\u62D2\u7D55\u7533\u8ACB"),yield this.loadPendingRequests(),this.usersStore.loadUsers()}catch(o){console.error("Failed to reject request:",o),this.toastService.error("\u62D2\u7D55\u5931\u6557")}finally{this.processing.set(!1)}}})}resetRequest(i){return S(this,null,function*(){if(!this.processing()&&confirm(`\u78BA\u5B9A\u8981\u91CD\u65B0\u5BE9\u6838 ${i.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`)){this.processing.set(!0);try{yield this.donationService.resetRequestStatus(i.id),this.toastService.success("\u5DF2\u91CD\u65B0\u958B\u653E\u5BE9\u6838"),yield this.loadProcessedRequests(),yield this.loadPendingRequests()}catch(o){console.error("Failed to reset request:",o),this.toastService.error("\u91CD\u65B0\u5BE9\u6838\u5931\u6557")}finally{this.processing.set(!1)}}})}startEditFromRequest(i){let r=this.usersStore.users().find(_=>_.uid===i.uid);r?this.editingUser.set(r):(this.usersStore.loadUsers(),this.toastService.info("\u8F09\u5165\u4F7F\u7528\u8005\u8CC7\u6599\u4E2D..."))}handleSaveEdit(i){let o=this.editingUser();o&&(this.usersStore.updateUserRole({uid:o.uid,role:i.role,premiumUntil:i.premiumUntil??null}),this.cancelEdit(),setTimeout(()=>{this.loadPendingRequests(),this.loadProcessedRequests()},500))}cancelEdit(){this.editingUser.set(null)}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-admin-panel"]],decls:17,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"flex","items-center","justify-between","mb-6"],[1,"flex","items-center","gap-2"],[1,"text-primary",3,"img","size"],[1,"card-title"],[1,"tabs","tabs-boxed"],[1,"tab",3,"click"],[1,"badge","badge-sm","badge-error","ml-1"],[3,"close","isOpen","proofKey"],[1,"modal","modal-open"],[1,"tabs","tabs-boxed","mb-4"],[1,"flex","justify-center","items-center","py-12"],[1,"overflow-x-auto"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"table"],[1,"font-bold"],[1,"text-xs","opacity-50"],[1,"btn","btn-ghost","btn-xs","whitespace-nowrap",3,"click"],[1,"max-w-xs","whitespace-pre-wrap","text-xs"],[1,"join"],[1,"btn","btn-success","btn-xs","join-item",3,"click","disabled"],[1,"btn","btn-error","btn-xs","join-item",3,"click","disabled"],["colspan","5",1,"text-center","py-8","text-base-content/50"],[1,"badge","badge-success","whitespace-nowrap"],[1,"badge","badge-warning","whitespace-nowrap"],[1,"badge","badge-ghost","whitespace-nowrap"],[1,"badge","badge-error","whitespace-nowrap"],[1,"flex","gap-1"],[1,"btn","btn-ghost","btn-xs"],[1,"btn","btn-warning","btn-outline","btn-xs",3,"disabled"],[1,"btn","btn-ghost","btn-xs",3,"click"],[1,"btn","btn-warning","btn-outline","btn-xs",3,"click","disabled"],["colspan","6",1,"text-center","py-8","text-base-content/50"],[1,"modal-box"],[3,"save","cancel","user"],["method","dialog",1,"modal-backdrop",3,"click"]],template:function(o,r){o&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),h(4,"lucide-icon",4),a(5,"h2",5),d(6,"\u7BA1\u7406\u54E1\u9762\u677F"),s()(),a(7,"div",6)(8,"a",7),f("click",function(){return r.switchTab("users")}),d(9," \u4F7F\u7528\u8005\u7BA1\u7406 "),s(),a(10,"a",7),f("click",function(){return r.switchTab("donations")}),d(11," \u8D0A\u52A9\u5BE9\u6838 "),m(12,pi,2,1,"span",8),s()()(),m(13,_i,1,0,"app-user-list")(14,Ni,8,6),s()(),a(15,"app-proof-modal",9),f("close",function(){return r.closeProofModal()}),s(),m(16,qi,6,1,"dialog",10)),o&2&&(l(4),p("img",r.Shield)("size",24),l(4),X("tab-active",r.activeTab()==="users"),l(2),X("tab-active",r.activeTab()==="donations"),l(2),c(r.pendingRequests().length>0?12:-1),l(),c(r.activeTab()==="users"?13:14),l(2),p("isOpen",r.isProofModalOpen())("proofKey",r.selectedProofKey()),l(),c(r.editingUser()?16:-1))},dependencies:[M,V,R,bt,ze,Ie,De],encapsulation:2});let e=n;return e})();var wt={myRequests:[],loading:!1,submitting:!1,error:null},At=me({providedIn:"root"},Be(wt),ce(({myRequests:e})=>({hasPendingRequest:w(()=>e().some(n=>n.status==="pending")),pendingRequest:w(()=>e().find(n=>n.status==="pending")),hasRequests:w(()=>e().length>0)})),ke((e,n=x($e),t=x(Q))=>({loadMyRequests:$(z(K(()=>b(e,{loading:!0,error:null})),F(i=>N(n.getMyRequests(i)).pipe(O({next:o=>b(e,{myRequests:o,loading:!1}),error:o=>{b(e,{error:o.message||"\u8F09\u5165\u7533\u8ACB\u5931\u6557",loading:!1})}}))))),submitRequest:$(z(K(()=>b(e,{submitting:!0,error:null})),F(({uid:i,displayName:o,email:r,proof:_,note:y,isPremium:I})=>N(n.createOrUpdateRequest(i,o,r,_,y,I)).pipe(F(()=>(b(e,{submitting:!1}),t.success("\u8D0A\u52A9\u7533\u8ACB\u5DF2\u9001\u51FA\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\uFF01"),N(n.getMyRequests(i)).pipe(ge(()=>Ce)))),O({next:q=>b(e,{myRequests:q}),error:q=>{b(e,{error:q.message||"\u7533\u8ACB\u9001\u51FA\u5931\u6557",submitting:!1}),t.error(q.message||"\u7533\u8ACB\u9001\u51FA\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}}))))),withdrawRequest:$(z(K(()=>b(e,{submitting:!0,error:null})),F(({requestId:i,uid:o})=>N(n.withdrawRequest(i,o)).pipe(F(()=>(b(e,{submitting:!1}),t.success("\u5DF2\u64A4\u56DE\u7533\u8ACB"),N(n.getMyRequests(o)).pipe(ge(()=>Ce)))),O({next:r=>b(e,{myRequests:r}),error:r=>{b(e,{error:r.message||"\u64A4\u56DE\u5931\u6557",submitting:!1}),t.error("\u64A4\u56DE\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}}))))),markAsExpired:$(z(F(({uid:i,premiumUntil:o,role:r})=>{let _=ie(o);return _&&_<new Date&&r==="free"?N(n.markAsExpired(i)).pipe(O({next:()=>{},error:y=>{console.error("Failed to mark as expired:",y)}})):N(Promise.resolve())}))),initForUser(i,o){if(o)return;this.loadMyRequests(i.uid);let r=i.platforms?.quotation;if(r?.premiumUntil){let _=ie(r.premiumUntil);_&&this.markAsExpired({uid:i.uid,premiumUntil:_,role:r.role||"free"})}},clearError(){b(e,{error:null})},reset(){b(e,wt)}})));var ki=(e,n,t,i)=>({request:e,requestId:n,status:"pending",icon:t,iconColor:"text-info",borderColor:"border-info",titleColor:"text-info",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u6B63\u5728\u5BE9\u6838\u4E2D",timeLabel:"\u63D0\u4EA4\u6642\u9593",time:i,message:"\u8ACB\u8010\u5FC3\u7B49\u5019\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u8655\u7406\u60A8\u7684\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"pendingProofPreview"}),Bi=(e,n,t,i)=>({request:e,requestId:n,status:"cancelled",icon:t,iconColor:"text-base-content/50",borderColor:"border-base-content/20",titleColor:"text-base-content/70",title:"\u60A8\u5DF2\u53D6\u6D88\u7533\u8ACB",timeLabel:"\u53D6\u6D88\u6642\u9593",time:i,message:"\u60A8\u53EF\u4EE5\u96A8\u6642\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"cancelledProofPreview"}),Ri=(e,n,t,i)=>({request:e,requestId:n,status:"rejected",icon:t,iconColor:"text-error",borderColor:"border-error",titleColor:"text-error",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u5DF2\u88AB\u62D2\u7D55",timeLabel:"\u5BE9\u6838\u6642\u9593",time:i,message:"\u60A8\u53EF\u4EE5\u4FEE\u6539\u6191\u8B49\u6216\u5099\u8A3B\u5F8C\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"rejectedProofPreview"}),Vi=(e,n,t,i)=>({request:e,requestId:n,status:"expired",icon:t,iconColor:"text-warning",borderColor:"border-warning",titleColor:"text-warning",title:"\u60A8\u7684\u8D0A\u52A9\u5DF2\u5230\u671F",timeLabel:"\u5230\u671F\u6642\u9593",time:i,message:"\u611F\u8B1D\u60A8\u904E\u53BB\u7684\u652F\u6301\uFF01\u60A8\u53EF\u4EE5\u91CD\u65B0\u7533\u8ACB\u7E8C\u7D04\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u7684\u8D0A\u52A9\u8CC7\u6599",modalId:"expiredProofPreview"}),Li=(e,n)=>n.id;function Ii(e,n){if(e&1&&(a(0,"div",2)(1,"div",4),h(2,"lucide-icon",5),a(3,"h2",6),d(4,"\u8ACB\u5148\u767B\u5165"),s(),a(5,"p"),d(6,"\u767B\u5165\u5F8C\u5373\u53EF\u67E5\u770B\u6703\u54E1\u8CC7\u8A0A"),s()()()),e&2){let t=u();l(2),p("img",t.User)("size",48)}}function zi(e,n){e&1&&he(0)}function ji(e,n){if(e&1&&ne(0,zi,1,0,"ng-container",11),e&2){let t=u().$implicit,i=u(3),o=xe(4);p("ngTemplateOutlet",o)("ngTemplateOutletContext",ve(2,ki,t,t.id,i.Clock,t.createdAt))}}function $i(e,n){e&1&&he(0)}function Oi(e,n){if(e&1&&ne(0,$i,1,0,"ng-container",11),e&2){let t=u(2).$implicit,i=u(3),o=xe(4);p("ngTemplateOutlet",o)("ngTemplateOutletContext",ve(2,Bi,t,t.id,i.CircleX,t.updatedAt))}}function Ki(e,n){e&1&&he(0)}function Wi(e,n){if(e&1&&ne(0,Ki,1,0,"ng-container",11),e&2){let t=u(2).$implicit,i=u(3),o=xe(4);p("ngTemplateOutlet",o)("ngTemplateOutletContext",ve(2,Ri,t,t.id,i.CircleX,t.updatedAt))}}function Hi(e,n){if(e&1&&m(0,Oi,1,7,"ng-container")(1,Wi,1,7,"ng-container"),e&2){let t,i=u().$implicit,o=u(3);c(i.reviewedBy===((t=o.authService.currentUser())==null?null:t.uid)?0:1)}}function Xi(e,n){e&1&&he(0)}function Qi(e,n){if(e&1&&ne(0,Xi,1,0,"ng-container",11),e&2){let t=u().$implicit,i=u(3),o=xe(4);p("ngTemplateOutlet",o)("ngTemplateOutletContext",ve(2,Vi,t,t.id,i.Clock,t.updatedAt))}}function Gi(e,n){if(e&1&&m(0,ji,1,7,"ng-container")(1,Hi,2,1)(2,Qi,1,7,"ng-container"),e&2){let t=n.$implicit;c(t.status==="pending"?0:t.status==="rejected"?1:t.status==="expired"?2:-1)}}function Yi(e,n){if(e&1&&G(0,Gi,3,1,null,null,Li),e&2){let t=u(2);Y(t.donationsStore.myRequests())}}function Ji(e,n){if(e&1){let t=E();a(0,"div",9)(1,"app-donation-form",12),f("submitDonation",function(o){C(t);let r=u(2);return g(r.handleDonationSubmit(o))}),s()()}}function Zi(e,n){if(e&1&&(a(0,"div",10),h(1,"lucide-icon",13),a(2,"div")(3,"h3",14),d(4,"\u611F\u8B1D\u60A8\u7684\u8D0A\u52A9\uFF01"),s(),a(5,"div",15),d(6,"\u60A8\u5DF2\u7D93\u662F\u8D0A\u52A9\u6703\u54E1\uFF0C\u4EAB\u6709\u6240\u6709\u9032\u968E\u529F\u80FD\u3002"),s()()()),e&2){let t=u(2);l(),p("img",t.Check)("size",24)}}function en(e,n){e&1&&h(0,"app-admin-panel")}function tn(e,n){if(e&1){let t=E();a(0,"h1",7),d(1,"\u6703\u54E1\u4E2D\u5FC3"),s(),a(2,"app-user-profile",8),f("displayNameChange",function(o){C(t);let r=u();return g(r.handleDisplayNameChange(o))}),s(),m(3,Yi,2,0),m(4,Ji,2,0,"div",9),m(5,Zi,7,2,"div",10),m(6,en,1,0,"app-admin-panel")}if(e&2){let t=u();l(2),p("userDisplayName",t.profileStore.userDisplayName())("userEmail",t.profileStore.userEmail())("isPremium",t.profileStore.isPremium())("isAdmin",t.profileStore.isAdmin())("formattedCreatedAt",t.profileStore.formattedCreatedAt())("formattedPremiumUntil",t.profileStore.formattedPremiumUntil())("daysUntilExpiry",t.profileStore.daysUntilExpiry())("showExpiryWarning",t.profileStore.showExpiryWarning()),l(),c(!t.profileStore.isPremium()&&!t.profileStore.isAdmin()&&t.donationsStore.myRequests().length>0?3:-1),l(),c(!t.profileStore.isPremium()&&!t.profileStore.isAdmin()?4:-1),l(),c(t.profileStore.isPremium()?5:-1),l(),c(t.profileStore.isAdmin()?6:-1)}}function nn(e,n){if(e&1&&(d(0),be(1,"date")),e&2){let t=u(),i=t.timeLabel,o=t.time;we(" ",i,"\uFF1A",ye(1,2,o,"yyyy/MM/dd HH:mm")," ")}}function on(e,n){if(e&1){let t=E();a(0,"div",24)(1,"button",25),f("click",function(){C(t);let o=u().requestId,r=u();return g(r.handleWithdraw(o))}),d(2," \u64A4\u56DE\u7533\u8ACB "),s()()}}function rn(e,n){if(e&1){let t=E();a(0,"img",32),f("click",function(){C(t);let o=u(3).request,r=u();return g(r.openProofModal(o.proofKey||o.proof))}),s()}if(e&2){let t=u(3).request,i=u();p("src",i.getResolvedProofUrl(t),H)}}function an(e,n){e&1&&(a(0,"div",31),h(1,"span",33),s())}function sn(e,n){if(e&1&&(a(0,"div")(1,"label",28)(2,"span",29),d(3,"\u8D0A\u52A9\u6191\u8B49"),s()(),m(4,rn,1,1,"img",30)(5,an,2,0,"div",31),s()),e&2){let t=u(2).request,i=u();l(4),c(i.getResolvedProofUrl(t)?4:5)}}function ln(e,n){if(e&1&&(a(0,"div")(1,"label",28)(2,"span",29),d(3,"\u5099\u8A3B"),s()(),a(4,"div",34)(5,"p",35),d(6),s()()()),e&2){let t=u(2).request;l(6),A(t.note)}}function dn(e,n){if(e&1&&(a(0,"div",26),d(1),s(),a(2,"div",27),m(3,sn,6,1,"div"),m(4,ln,7,1,"div"),s()),e&2){let t=u(),i=t.request,o=t.sectionTitle;l(),A(o),l(2),c(i.proof||i.proofKey?3:-1),l(),c(i.note?4:-1)}}function un(e,n){if(e&1&&(a(0,"div",16)(1,"div",17)(2,"div",18),h(3,"lucide-icon",19),a(4,"div",20)(5,"h3",21),d(6),s(),a(7,"p",22),m(8,nn,2,5),s(),a(9,"p",23),d(10),s(),m(11,on,3,0,"div",24),s()(),m(12,dn,5,3),s()()),e&2){let t=n.status,i=n.icon,o=n.iconColor,r=n.borderColor,_=n.titleColor,y=n.title,I=n.time,q=n.message;p("ngClass",r),l(3),p("img",i)("size",32)("ngClass",o),l(2),p("ngClass",_),l(),A(y),l(2),c(I?8:-1),l(2),A(q),l(),c(t==="pending"?11:-1),l(),c(t!=="cancelled"?12:-1)}}var wr=(()=>{let n=class n{constructor(){this.authService=x(B),this.donationsStore=x(At),this.profileStore=x(je),this.donationApi=x(pe),this.resolvedProofUrls=v({}),this.isProofModalOpen=v(!1),this.selectedProofKey=v(""),this.User=qe,this.Check=Te,this.Clock=Me,this.CircleX=ot,te(()=>{let i=this.profileStore.userData(),o=this.profileStore.isPremium(),r=this.profileStore.isAdmin();i&&!r&&this.donationsStore.initForUser(i,o)}),te(()=>{let i=this.donationsStore.myRequests();for(let o of i)o.proofKey&&!this.resolvedProofUrls()[o.proofKey]&&this.resolveProofUrl(o.proofKey)})}handleDonationSubmit(i){let o=this.authService.currentUser(),r=this.profileStore.userData();!o||!r||this.donationsStore.submitRequest({uid:o.uid,displayName:r.displayName||o.email||"Unknown",email:r.email||"No Email",proof:i.proof,note:i.note,isPremium:this.profileStore.isPremium()})}handleDisplayNameChange(i){return S(this,null,function*(){try{yield this.authService.updateDisplayName(i)}catch(o){console.error("Failed to update display name:",o)}})}handleWithdraw(i){if(!confirm("\u78BA\u5B9A\u8981\u64A4\u56DE\u7533\u8ACB\u55CE\uFF1F\u64A4\u56DE\u5F8C\u60A8\u53EF\u4EE5\u91CD\u65B0\u63D0\u4EA4\u3002"))return;let o=this.authService.currentUser();o&&this.donationsStore.withdrawRequest({requestId:i,uid:o.uid})}openProofModal(i){this.selectedProofKey.set(i),this.isProofModalOpen.set(!0)}closeProofModal(){this.isProofModalOpen.set(!1),this.selectedProofKey.set("")}getResolvedProofUrl(i){return i.proof?i.proof:i.proofKey&&this.resolvedProofUrls()[i.proofKey]||""}resolveProofUrl(i){return S(this,null,function*(){try{let o=yield U(this.donationApi.getProofSignedUrl(i)),r=`${k.portalApiUrl}/api/portal/user`;this.resolvedProofUrls.update(_=>Qe(Xe({},_),{[i]:`${r}${o.url}`}))}catch{console.error("[Member] Failed to resolve proof URL")}})}};n.\u0275fac=function(o){return new(o||n)},n.\u0275cmp=T({type:n,selectors:[["app-member"]],decls:6,vars:3,consts:[["requestStatusCard",""],[1,"mx-auto","px-4","py-8"],[1,"card","bg-base-100","shadow-sm"],[3,"close","isOpen","proofKey"],[1,"card-body","text-center"],[1,"mx-auto","text-base-content/50",3,"img","size"],[1,"card-title","justify-center"],[1,"text-3xl","font-bold","mb-6"],[3,"displayNameChange","userDisplayName","userEmail","isPremium","isAdmin","formattedCreatedAt","formattedPremiumUntil","daysUntilExpiry","showExpiryWarning"],["id","donation-form"],[1,"alert","alert-success","alert-soft"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[3,"submitDonation"],[3,"img","size"],[1,"font-bold"],[1,"text-sm"],[1,"card","bg-base-100","shadow-sm","border-2","mb-6",3,"ngClass"],[1,"card-body"],[1,"flex","items-start","gap-4"],[1,"flex-shrink-0",3,"img","size","ngClass"],[1,"flex-1"],[1,"card-title",3,"ngClass"],[1,"text-sm","opacity-70","mt-1"],[1,"text-sm","mt-2"],[1,"mt-4"],[1,"btn","btn-outline","btn-warning","btn-sm",3,"click"],[1,"divider"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"label"],[1,"label-text","font-semibold"],["alt","\u8D0A\u52A9\u6191\u8B49",1,"max-w-3xs","w-full","rounded-lg","border","border-base-300","cursor-pointer","hover:opacity-80","transition",3,"src"],[1,"flex","items-center","justify-center","h-32","bg-base-200","rounded-lg"],["alt","\u8D0A\u52A9\u6191\u8B49",1,"max-w-3xs","w-full","rounded-lg","border","border-base-300","cursor-pointer","hover:opacity-80","transition",3,"click","src"],[1,"loading","loading-spinner"],[1,"p-4","bg-base-200","rounded-lg"],[1,"text-sm","whitespace-pre-wrap"]],template:function(o,r){if(o&1){let _=E();a(0,"div",1),m(1,Ii,7,2,"div",2)(2,tn,7,12),s(),ne(3,un,13,10,"ng-template",null,0,Je),a(5,"app-proof-modal",3),f("close",function(){return C(_),g(r.closeProofModal())}),s()}o&2&&(l(),c(r.authService.isAuthenticated()?2:1),l(4),p("isOpen",r.isProofModalOpen())("proofKey",r.selectedProofKey()))},dependencies:[M,Ae,Ze,V,R,Ct,gt,St,ze,De],encapsulation:2});let e=n;return e})();export{wr as MemberComponent};
