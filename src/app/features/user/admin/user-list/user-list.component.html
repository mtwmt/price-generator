<div class="card bg-base-100 shadow-sm">
  <div class="card-body">
    <div class="flex items-center justify-between mb-4">
      <h2 class="card-title flex items-center gap-2">
        <lucide-icon [img]="Users" [size]="24" />
        使用者管理
      </h2>
      <button
        type="button"
        class="btn btn-sm btn-primary"
        (click)="onRefresh()"
        [disabled]="usersStore.loading()"
      >
        @if (usersStore.loading()) {
          <span class="loading loading-spinner loading-sm"></span>
        }
        重新整理
      </button>
    </div>

    @if (usersStore.loading()) {
      <div class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
    } @else if (!hasUsers()) {
      <div class="text-center py-8 text-base-content/60">
        <lucide-icon
          [img]="Users"
          [size]="48"
          class="mx-auto mb-2 opacity-30"
        />
        <p>目前沒有使用者資料</p>
      </div>
    } @else {
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>使用者</th>
              <th>Email</th>
              <th>角色</th>
              <th>贊助到期日</th>
              <th>註冊時間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            @for (item of paginatedUsersDisplay(); track item.user.uid) {
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="avatar">
                      <div
                        class="w-10 h-10 rounded-full bg-primary text-primary-content"
                      >
                        @if (item.user.photoURL) {
                          <img
                            [src]="item.user.photoURL"
                            [alt]="item.displayName"
                            referrerpolicy="no-referrer"
                            class="object-cover"
                          />
                        }
                      </div>
                    </div>
                    <div>
                      <div class="font-medium">
                        {{ item.displayName }}
                      </div>
                      <div class="text-xs text-base-content/60">
                        {{ item.uidShort }}...
                      </div>
                    </div>
                  </div>
                </td>
                <td>{{ item.email }}</td>
                <td>
                  @if (item.isExpired) {
                    <span class="badge badge-soft gap-1 whitespace-nowrap">
                      <lucide-icon [img]="Crown" [size]="12" />
                      贊助會員（已過期）
                    </span>
                  } @else {
                    <span
                      class="badge badge-soft gap-1 whitespace-nowrap"
                      [class]="item.roleBadgeClass"
                    >
                      @if (item.role === 'admin') {
                        <lucide-icon [img]="Shield" [size]="12" />
                      } @else if (item.role === 'premium') {
                        <lucide-icon [img]="Crown" [size]="12" />
                      }
                      {{ item.roleDisplayName }}
                    </span>
                  }
                </td>
                <td>
                  @if (item.premiumUntilFormatted) {
                    <div>
                      <div>{{ item.premiumUntilFormatted }}</div>
                      @if (
                        item.daysUntilExpiry !== null && item.daysUntilExpiry > 0
                      ) {
                        <div
                          class="text-xs"
                          [class.text-error]="item.daysUntilExpiry < 7"
                          [class.text-warning]="
                            item.daysUntilExpiry >= 7 && item.daysUntilExpiry < 30
                          "
                        >
                          (剩餘 {{ item.daysUntilExpiry }} 天)
                        </div>
                      }
                    </div>
                  } @else {
                    <span class="text-base-content/40">-</span>
                  }
                </td>
                <td>{{ item.createdAtFormatted }}</td>
                <td>
                  <div class="join">
                    <button
                      type="button"
                      class="btn btn-sm btn-ghost join-item"
                      (click)="startEdit(item.user)"
                    >
                      編輯
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-ghost text-error join-item"
                      (click)="confirmDelete(item.user)"
                    >
                      刪除
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- 分頁元件 -->
      <app-pagination
        [totalItems]="totalUsers()"
        [pageSize]="pageSize()"
        [currentPage]="currentPage()"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)"
      />
    }
  </div>
</div>

<!-- 編輯使用者 Modal -->
@if (editingUser()) {
  <dialog class="modal modal-open">
    <div class="modal-box">
      <app-user-edit-form
        [user]="editingUser()!"
        (save)="handleSave($event)"
        (cancel)="cancelEdit()"
      />
    </div>
    <form method="dialog" class="modal-backdrop" (click)="cancelEdit()">
      <button>close</button>
    </form>
  </dialog>
}
