<div
  class="bg-base-100 border border-base-300 rounded-lg p-2 md:p-6 shadow-sm text-sm print:p-6"
  style="max-width: 210mm; margin: 0 auto"
>
  <!-- 頂部：LOGO + 標題 -->
  <div
    class="flex justify-between items-start mb-6 pb-4 border-b-2 border-primary"
  >
    <div class="flex items-center gap-3">
      @if (quoterLogo()) {
        <img
          [src]="quoterLogo()"
          class="h-16 object-contain"
          alt="Company Logo"
        />
      }
      <div>
        <div class="text-3xl font-bold text-primary">QUOTATION</div>
        <div class="text-lg text-base-content/70">報價單</div>
      </div>
    </div>
    <!-- <div class="text-right">
      <div class="text-base-content/70 text-xs mb-1">QUOTATION NO.</div>
      <div class="text-lg font-bold text-base-content">
        {{ form().get('startDate')?.value || '' | date: 'yyyyMMdd' }}-001
      </div>
    </div> -->
  </div>

  <!-- 賣方資訊（左）+ 客戶資訊（右）-->
  <div class="grid grid-cols-2 gap-8 mb-6">
    <!-- 賣方資訊 FROM -->
    <div>
      <div class="font-bold text-primary mb-2 uppercase tracking-wider">
        From (報價方)
      </div>
      <div class="bg-base-50 border border-base-200 rounded p-3 space-y-1">
        <div class="font-bold text-base text-base-content">
          {{ form().get('quoterName')?.value || '[公司名稱]' }}
        </div>
        @if (form().get('quoterTaxID')?.value) {
          <div class="text-base-content/70">
            統編：{{ form().get('quoterTaxID')?.value }}
          </div>
        }
        @if (form().get('quoterAddress')?.value) {
          <div class="text-base-content/70">
            {{ form().get('quoterAddress')?.value }}
          </div>
        }
        @if (form().get('quoterPhone')?.value) {
          <div class="text-base-content/70">
            電話：{{ form().get('quoterPhone')?.value }}
          </div>
        }
        @if (form().get('quoterEmail')?.value) {
          <div class="text-base-content/70">
            Email：{{ form().get('quoterEmail')?.value }}
          </div>
        }
      </div>
    </div>

    <!-- 客戶資訊 TO -->
    <div>
      <div class="font-bold text-primary mb-2 uppercase tracking-wider">
        To (客戶)
      </div>
      <div class="bg-primary/5 border border-primary/20 rounded p-3 space-y-1">
        <div class="flex items-center gap-2">
          @if (customerLogo()) {
            <img
              [src]="customerLogo()"
              class="h-8 object-contain"
              alt="Customer Logo"
            />
          }
          <div class="font-bold text-base text-base-content">
            {{ form().get('customerCompany')?.value || '[客戶名稱]' }}
          </div>
        </div>
        @if (form().get('customerTaxID')?.value) {
          <div class="text-base-content/70">
            統編：{{ form().get('customerTaxID')?.value }}
          </div>
        }
        @if (form().get('customerContact')?.value) {
          <div class="text-base-content/70">
            聯絡人：{{ form().get('customerContact')?.value }}
          </div>
        }
        @if (form().get('customerPhone')?.value) {
          <div class="text-base-content/70">
            電話：{{ form().get('customerPhone')?.value }}
          </div>
        }
        @if (form().get('customerEmail')?.value) {
          <div class="text-base-content/70">
            Email：{{ form().get('customerEmail')?.value }}
          </div>
        }
        @if (form().get('customerAddress')?.value) {
          <div class="text-base-content/70">
            {{ form().get('customerAddress')?.value }}
          </div>
        }
      </div>
    </div>
  </div>

  <!-- 日期資訊 -->
  <div class="grid grid-cols-3 gap-4 mb-6 text-sm">
    @if (form().get('startDate')?.value) {
      <div class="flex justify-between border-b border-base-300 pb-1">
        <span class="text-base-content/70">報價日期 (Date)：</span>
        <span class="font-semibold">{{ form().get('startDate')?.value }}</span>
      </div>
    }
    @if (form().get('endDate')?.value) {
      <div class="flex justify-between border-b border-base-300 pb-1">
        <span class="text-base-content/70">有效期限 (Valid Until)：</span>
        <span class="font-semibold">{{ form().get('endDate')?.value }}</span>
      </div>
    }
  </div>

  <!-- 服務項目表格 -->
  <div class="mb-6">
    <table class="w-full border-collapse border-2 border-primary">
      <thead>
        <tr class="bg-primary text-primary-content">
          <th
            class="py-2 px-3 text-center font-bold border-r border-primary-content/30 w-12"
          >
            項次<br /><span class="text-xs font-normal">No.</span>
          </th>
          <th
            class="py-2 px-3 text-left font-bold border-r border-primary-content/30 w-24"
          >
            類別<br /><span class="text-xs font-normal">Category</span>
          </th>
          <th
            class="py-2 px-3 text-left font-bold border-r border-primary-content/30"
          >
            項目描述<br /><span class="text-xs font-normal">Description</span>
          </th>
          <th
            class="py-2 px-3 text-right font-bold border-r border-primary-content/30 w-24"
          >
            單價<br /><span class="text-xs font-normal">Unit Price</span>
          </th>
          <th
            class="py-2 px-3 text-center font-bold border-r border-primary-content/30 w-20"
          >
            數量<br /><span class="text-xs font-normal">Qty</span>
          </th>
          <th class="py-2 px-3 text-right font-bold w-28">
            金額<br /><span class="text-xs font-normal">Amount</span>
          </th>
        </tr>
      </thead>
      <tbody>
        @if (serviceItems().controls.length === 0) {
          <tr>
            <td
              colspan="6"
              class="p-6 text-center text-sm text-base-content/50 border-t border-base-300"
            >
              尚無服務項目
            </td>
          </tr>
        } @else {
          @for (
            item of serviceItems().controls;
            track item.value;
            let idx = $index
          ) {
            <tr class="border-t border-base-300 hover:bg-base-50">
              <td class="p-2 text-center border-r border-base-300">
                {{ idx + 1 }}
              </td>
              <td class="p-2 border-r border-base-300">
                {{ item.value.category || '-' }}
              </td>
              <td class="p-2 border-r border-base-300">
                <div class="font-semibold">{{ item.value.item || '-' }}</div>
                @if (item.value.unit) {
                  <div class="text-xs text-base-content/60">
                    單位：{{ item.value.unit }}
                  </div>
                }
              </td>
              <td class="p-2 text-right border-r border-base-300">
                ${{ item.value.price || 0 | number: '1.0-0' }}
              </td>
              <td class="p-2 text-center border-r border-base-300">
                {{ item.value.count || 0 }}
              </td>
              <td class="p-2 text-right font-semibold">
                ${{ item.value.amount || 0 | number: '1.0-0' }}
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- 金額計算區 + 印章 -->
  <div class="grid grid-cols-2 gap-8 mb-6">
    <!-- 左側：印章 -->
    <div class="flex items-center justify-center">
      @if (stamp()) {
        <img
          [src]="stamp()"
          class="max-w-full max-h-32 object-contain"
          alt="公司章"
        />
      }
    </div>

    <!-- 右側：金額計算 -->
    <div>
      <!-- 小計 -->
      <div
        class="flex justify-between items-center py-2 border-b border-base-300"
      >
        <span class="text-base-content/70">小計 (Subtotal)：</span>
        <span class="font-semibold text-base">
          NT$ {{ form().get('excludingTax')?.value || 0 | number: '1.0-0' }}
        </span>
      </div>

      <!-- 折扣 -->
      @if (form().get('discountValue')?.value > 0) {
        <div
          class="flex justify-between items-center py-2 border-b border-base-300"
        >
          <span class="text-base-content/70">
            折扣 (Discount)
            @if (form().get('discountType')?.value === 'percentage') {
              <span class="text-xs"
                >({{ form().get('discountValue')?.value }}折)</span
              >
            }
            ：
          </span>
          <span class="text-green-600 font-semibold">
            -NT$
            {{ form().get('discountAmount')?.value || 0 | number: '1.0-0' }}
          </span>
        </div>
        <div
          class="flex justify-between items-center py-2 border-b border-base-300"
        >
          <span class="text-base-content/70">折扣後 (After Discount)：</span>
          <span class="font-semibold">
            NT$ {{ form().get('afterDiscount')?.value || 0 | number: '1.0-0' }}
          </span>
        </div>
      }

      <!-- 稅額 -->
      @if (
        !!form().get('taxName')?.value || !!form().get('customTaxName')?.value
      ) {
        <div
          class="flex justify-between items-center py-2 border-b border-base-300"
        >
          <span class="text-base-content/70">
            @if (
              form().get('taxName')?.value === '自訂' &&
              form().get('customTaxName')?.value
            ) {
              {{ form().get('customTaxName')?.value }}
            } @else {
              {{ form().get('taxName')?.value || '稅額' }}
            }
            (Tax)
            @if (form().get('percentage')?.value) {
              <span class="text-xs"
                >({{ form().get('percentage')?.value }}%)</span
              >
            }
            ：
          </span>
          <span class="text-rose-500 font-semibold">
            NT$ {{ form().get('tax')?.value || 0 | number: '1.0-0' }}
          </span>
        </div>
      }

      <!-- 總計 -->
      <div
        class="flex justify-between items-center py-3 mt-2 bg-primary/10 rounded px-3"
      >
        <span class="font-bold text-lg text-primary">總計 (Total)：</span>
        <span class="text-2xl font-bold text-primary">
          NT$ {{ form().get('includingTax')?.value || 0 | number: '1.0-0' }}
        </span>
      </div>
    </div>
  </div>

  <!-- 備註說明 -->
  @if (form().get('desc')?.value) {
    <div class="mb-6 border-t border-base-300 pt-4">
      <h3 class="font-bold text-base-content mb-2 flex items-center gap-2">
        <span class="text-primary">■</span> 備註 (Notes)
      </h3>
      <div
        class="bg-base-50 border border-base-300 rounded p-3 text-base-content whitespace-pre-wrap leading-relaxed"
      >
        {{ form().get('desc')?.value }}
      </div>
    </div>
  }

  <!-- 簽章區 -->
  @if (form().get('isSign')?.value) {
    <div class="border-t-2 border-base-300 pt-4">
      <div class="grid grid-cols-2 gap-6">
        <!-- 報價方簽章 -->
        <div class="border border-base-300 rounded p-4 bg-base-50">
          <div class="font-semibold text-base-content mb-3 text-center">
            報價方簽章 (Quoter Signature)
          </div>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-base-content/60">簽章 (Sign)：</span>
              <span class="border-b border-base-300 w-40"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">日期 (Date)：</span>
              <span class="border-b border-base-300 w-40"></span>
            </div>
          </div>
        </div>

        <!-- 客戶簽章 -->
        <div class="border border-primary/30 rounded p-4 bg-primary/5">
          <div class="font-semibold text-base-content mb-3 text-center">
            客戶簽章確認 (Customer Signature)
          </div>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-base-content/60">簽章 (Sign)：</span>
              <span class="border-b border-base-300 w-40"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">日期 (Date)：</span>
              <span class="border-b border-base-300 w-40"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- 頁尾 -->
  <div
    class="mt-6 pt-4 border-t border-base-300 text-center text-xs text-base-content/50"
  >
    <p>
      本報價單由 {{ form().get('quoterName')?.value || '[公司名稱]' }} 提供
      @if (form().get('quoterPhone')?.value) {
        | 電話：{{ form().get('quoterPhone')?.value }}
      }
      @if (form().get('quoterEmail')?.value) {
        | Email：{{ form().get('quoterEmail')?.value }}
      }
    </p>
  </div>
</div>
