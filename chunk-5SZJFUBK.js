import{c as Le,d as H,e as W,f as Ve,g as G,h as q,i as ve,j as J,k as N,l as Ie,m as B,n as K,o as be}from"./chunk-WM3DW3TB.js";import{a as Qe}from"./chunk-U4BIAJNR.js";import{b as Q,d as Y,f as Z,h as ee,n as Oe,o as je,p as ze,s as Ee,u as te}from"./chunk-TJ2XPEG7.js";import{$ as f,$a as V,$c as Ae,Ab as D,Bb as fe,Db as O,Eb as j,Fb as z,Ha as F,Jb as Me,Kb as ae,Lb as re,Lc as Xe,Ma as X,Nb as se,Ob as ke,Qc as He,R as Pe,Rb as le,Sb as xe,Ub as A,Vb as S,Vc as De,W as w,Xa as c,Ya as m,Zc as Ge,_a as L,aa as x,ab as p,ad as Je,bb as a,bd as Ke,cb as r,cd as T,db as g,dd as M,eb as _e,fb as Ce,fc as ge,gb as qe,ha as E,hc as Re,ic as he,jb as ne,kb as y,kc as U,lb as Ne,mb as C,nb as Te,ob as u,rc as We,sc as ye,va as P,vb as oe,vc as $e,wb as I,wc as Se,xb as Be,xc as ie,ya as d,yb as l,zb as v}from"./chunk-H6CE5KK2.js";import{a as pe,h}from"./chunk-FJYW2LMB.js";var ct=(e,o)=>({"border-warning bg-warning/10":e,"border-error bg-error/10":o}),mt=(e,o)=>({"text-warning":e,"text-error":o});function pt(e,o){if(e&1){let t=y();a(0,"div",9)(1,"input",11),z("ngModelChange",function(i){f(t);let s=u();return j(s.editingName,i)||(s.editingName=i),x(i)}),C("keyup.enter",function(){f(t);let i=u();return x(i.saveEditing())})("keyup.escape",function(){f(t);let i=u();return x(i.cancelEditing())}),r(),a(2,"button",12),C("click",function(){f(t);let i=u();return x(i.saveEditing())}),g(3,"lucide-icon",3),r(),a(4,"button",13),C("click",function(){f(t);let i=u();return x(i.cancelEditing())}),g(5,"lucide-icon",3),r()()}if(e&2){let t=u();d(),O("ngModel",t.editingName),d(2),p("img",t.Check)("size",16),d(2),p("img",t.X)("size",16)}}function _t(e,o){e&1&&(a(0,"span",14),l(1,"\u7BA1\u7406\u54E1"),r())}function Ct(e,o){e&1&&(a(0,"span",15),l(1,"\u8D0A\u52A9\u6703\u54E1"),r())}function ft(e,o){e&1&&(a(0,"span",16),l(1,"\u514D\u8CBB\u6703\u54E1"),r())}function xt(e,o){if(e&1&&(a(0,"div",10),l(1),a(2,"span"),c(3,_t,2,0,"span",14)(4,Ct,2,0,"span",15)(5,ft,2,0,"span",16),r()()),e&2){let t=u();d(),D(" ",t.userDisplayName()," "),d(2),m(t.isAdmin()?3:t.isPremium()?4:5)}}function gt(e,o){if(e&1&&(a(0,"div",5),g(1,"lucide-icon",6),a(2,"div")(3,"div",8),l(4,"Email"),r(),a(5,"div",17),l(6),r()()()),e&2){let t=u();d(),p("img",t.Mail)("size",20),d(5),v(t.userEmail())}}function ht(e,o){if(e&1&&(a(0,"div",5),g(1,"lucide-icon",6),a(2,"div")(3,"div",8),l(4,"\u8A3B\u518A\u6642\u9593"),r(),a(5,"div",17),l(6),r()()()),e&2){let t=u();d(),p("img",t.Clock)("size",20),d(5),v(t.formattedCreatedAt())}}function vt(e,o){if(e&1&&(a(0,"div",20),l(1," \u6703\u54E1\u5373\u5C07\u5230\u671F "),r(),a(2,"div",17),l(3),r()),e&2){let t=u(3);d(3),fe(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil(),"\uFF08\u5269\u9918 ",t.daysUntilExpiry()," \u5929\uFF09 ")}}function bt(e,o){if(e&1&&(a(0,"div",21),l(1,"\u6703\u54E1\u5DF2\u5230\u671F"),r(),a(2,"div",17),l(3),r()),e&2){let t=u(3);d(3),D(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil()," ")}}function Et(e,o){if(e&1&&(a(0,"div",18),g(1,"lucide-icon",19),a(2,"div"),c(3,vt,4,2)(4,bt,4,1),r()()),e&2){let t=u(2);p("ngClass",Me(5,ct,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),d(),p("img",t.Calendar)("size",20)("ngClass",Me(8,mt,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),d(2),m(t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0?3:4)}}function yt(e,o){if(e&1&&(a(0,"span",8),l(1),r()),e&2){let t=u(3);d(),D(" (\u5269\u9918 ",t.daysUntilExpiry()," \u5929) ")}}function St(e,o){if(e&1&&(a(0,"div",5),g(1,"lucide-icon",6),a(2,"div")(3,"div",8),l(4,"\u6703\u54E1\u5230\u671F\u65E5"),r(),a(5,"div",17),l(6),c(7,yt,2,1,"span",8),r()()()),e&2){let t=u(2);d(),p("img",t.Calendar)("size",20),d(5),D(" ",t.formattedPremiumUntil()," "),d(),m(t.daysUntilExpiry()!==null?7:-1)}}function Dt(e,o){if(e&1&&c(0,Et,5,11,"div",18)(1,St,8,4,"div",5),e&2){let t=u();m(t.showExpiryWarning()?0:1)}}var et=(()=>{let o=class o{constructor(){this.userDisplayName=S.required(),this.userEmail=S(null),this.isPremium=S(!1),this.isAdmin=S(!1),this.formattedCreatedAt=S(null),this.formattedPremiumUntil=S(null),this.daysUntilExpiry=S(null),this.showExpiryWarning=S(!1),this.displayNameChange=A(),this.isEditing=E(!1),this.editingName=E(""),this.Crown=ie,this.User=Ae,this.Mail=Xe,this.Calendar=We,this.Clock=Se,this.Pencil=He,this.Check=ye,this.X=Ke}startEditing(){this.editingName.set(this.userDisplayName()),this.isEditing.set(!0)}cancelEditing(){this.isEditing.set(!1),this.editingName.set("")}saveEditing(){let n=this.editingName().trim();n&&n!==this.userDisplayName()&&this.displayNameChange.emit(n),this.isEditing.set(!1)}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-user-profile"]],inputs:{userDisplayName:[1,"userDisplayName"],userEmail:[1,"userEmail"],isPremium:[1,"isPremium"],isAdmin:[1,"isAdmin"],formattedCreatedAt:[1,"formattedCreatedAt"],formattedPremiumUntil:[1,"formattedPremiumUntil"],daysUntilExpiry:[1,"daysUntilExpiry"],showExpiryWarning:[1,"showExpiryWarning"]},outputs:{displayNameChange:"displayNameChange"},decls:16,vars:8,consts:[[1,"card","bg-base-100","shadow-sm","mb-6"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4","mt-4"],[1,"flex","items-center","gap-3"],[1,"text-base-content/70",3,"img","size"],[1,"flex-1"],[1,"text-sm","text-base-content/70"],[1,"flex","items-center","gap-2","mt-1"],[1,"font-medium","flex","items-center","gap-2"],["type","text","maxlength","50",1,"input","input-bordered","input-sm","flex-1","max-w-xs",3,"ngModelChange","keyup.enter","keyup.escape","ngModel"],["title","\u4FDD\u5B58",1,"btn","btn-success","btn-sm","btn-square",3,"click"],["title","\u53D6\u6D88",1,"btn","btn-ghost","btn-sm","btn-square",3,"click"],[1,"badge","badge-soft","badge-error","badge-sm"],[1,"badge","badge-soft","badge-warning","badge-sm"],[1,"badge","badge-soft","badge-sm"],[1,"font-medium"],[1,"flex","items-center","gap-3","p-3","rounded-lg","border",3,"ngClass"],[3,"img","size","ngClass"],[1,"text-sm","text-warning","font-semibold"],[1,"text-sm","text-error","font-semibold"]],template:function(i,s){i&1&&(a(0,"div",0)(1,"div",1)(2,"h2",2),g(3,"lucide-icon",3),l(4," \u6703\u54E1\u8CC7\u8A0A "),r(),a(5,"div",4)(6,"div",5),g(7,"lucide-icon",6),a(8,"div",7)(9,"div",8),l(10,"\u4F7F\u7528\u8005\u540D\u7A31"),r(),c(11,pt,6,5,"div",9)(12,xt,6,2,"div",10),r()(),c(13,gt,7,3,"div",5),c(14,ht,7,3,"div",5),c(15,Dt,2,1),r()()()),i&2&&(d(3),p("img",s.User)("size",24),d(4),p("img",s.User)("size",20),d(4),m(s.isEditing()?11:12),d(2),m(s.userEmail()?13:-1),d(),m(s.formattedCreatedAt()?14:-1),d(),m(s.formattedPremiumUntil()?15:-1))},dependencies:[U,ge,te,Y,Z,Ee,ee,M,T],encapsulation:2});let e=o;return e})();var tt=(()=>{let o=class o{constructor(){this.toastService=w(Q),this.submitDonation=A(),this.donationProof=E(null),this.donationNote=E(""),this.Crown=ie,this.Upload=Ge}handleDonationProof(n){if(n.length===0)return;let i=n[0],s=new FileReader;s.onload=()=>{let _=s.result;this.donationProof.set(_)},s.onerror=()=>{this.toastService.error("\u6A94\u6848\u8B80\u53D6\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66")},s.readAsDataURL(i)}onSubmit(){let n=!!this.donationProof(),i=!!this.donationNote().trim();if(!n&&!i){this.toastService.error("\u8ACB\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u6216\u586B\u5BEB\u5099\u8A3B");return}this.submitDonation.emit({proof:this.donationProof()||"",note:this.donationNote()}),this.donationProof.set(null),this.donationNote.set("")}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-donation-form"]],outputs:{submitDonation:"submitDonation"},decls:27,vars:11,consts:[[1,"card","bg-base-100","shadow-xl"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"text-base-content/70"],[1,"divider"],[1,"form-control"],[1,"label"],[1,"label-text","font-medium"],[3,"fileSelected","label","supportedFormats","accept","previewUrl"],[1,"form-control","mt-4"],["placeholder","\u8ACB\u8F38\u5165\u5099\u8A3B\uFF0C\u4F8B\u5982\uFF1A\u8F49\u5E33\u5E33\u865F\u5F8C\u4E94\u78BC\u3001\u8D0A\u52A9\u65E5\u671F\u7B49...","maxlength","500",1,"textarea","textarea-bordered","h-24","w-full",3,"ngModelChange","ngModel"],[1,"label","flex","justify-between"],[1,"label-text-alt"],[1,"card-actions","justify-end","mt-4"],["type","button",1,"btn","btn-warning","gap-2",3,"click","disabled"]],template:function(i,s){i&1&&(a(0,"div",0)(1,"div",1)(2,"h2",2),g(3,"lucide-icon",3),l(4," \u5347\u7D1A\u70BA\u8D0A\u52A9\u6703\u54E1 "),r(),a(5,"p",4),l(6," \u611F\u8B1D\u60A8\u7684\u652F\u6301\uFF01\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u5F8C\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\u4E26\u5347\u7D1A\u60A8\u7684\u6703\u54E1\u7B49\u7D1A\u3002 "),r(),g(7,"div",5),a(8,"div",6)(9,"label",7)(10,"span",8),l(11,"\u8D0A\u52A9\u6191\u8B49"),r()(),a(12,"app-file-upload",9),C("fileSelected",function(b){return s.handleDonationProof(b)}),r()(),a(13,"div",10)(14,"label",7)(15,"span",8),l(16,"\u5099\u8A3B"),r()(),a(17,"textarea",11),z("ngModelChange",function(b){return j(s.donationNote,b)||(s.donationNote=b),b}),r(),a(18,"label",12)(19,"span",13),l(20,"\u63D0\u4F9B\u66F4\u591A\u8CC7\u8A0A\u6709\u52A9\u65BC\u6211\u5011\u66F4\u5FEB\u5B8C\u6210\u5BE9\u6838"),r(),a(21,"span",13),l(22),r()()(),a(23,"div",14)(24,"button",15),C("click",function(){return s.onSubmit()}),g(25,"lucide-icon",3),l(26," \u63D0\u4EA4\u8D0A\u52A9\u7533\u8ACB "),r()()()()),i&2&&(d(3),p("img",s.Crown)("size",24),d(9),p("label","\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\uFF08\u8F49\u5E33\u622A\u5716\u6216\u6536\u64DA\uFF09")("supportedFormats","\u652F\u63F4 PNG\u3001JPG\u3001GIF")("accept","image/gif, image/jpeg, image/png")("previewUrl",s.donationProof()),d(5),O("ngModel",s.donationNote),d(5),D("",s.donationNote().length," / 500"),d(2),p("disabled",!s.donationProof()&&!s.donationNote().trim()),d(),p("img",s.Upload)("size",18))},dependencies:[U,te,Y,Z,Ee,ee,M,T,Qe],encapsulation:2});let e=o;return e})();function it(e){return{free:"\u514D\u8CBB\u6703\u54E1",premium:"\u8D0A\u52A9\u6703\u54E1",admin:"\u7BA1\u7406\u54E1"}[e]||e}function nt(e){return{free:"badge-ghost",premium:"badge-warning",admin:"badge-error"}[e]||"badge-ghost"}function ot(e){return e?(e instanceof Date?e:e.toDate()).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}):"-"}function at(e){if(!e)return null;let o=new Date,n=(e instanceof Date?e:e.toDate()).getTime()-o.getTime();return Math.ceil(n/(1e3*60*60*24))}var At=(e,o)=>o.uid;function wt(e,o){e&1&&g(0,"span",6)}function Ft(e,o){e&1&&(a(0,"div",7),g(1,"span",10),r())}function Ut(e,o){if(e&1&&(a(0,"div",8),g(1,"lucide-icon",11),a(2,"p"),l(3,"\u76EE\u524D\u6C92\u6709\u4F7F\u7528\u8005\u8CC7\u6599"),r()()),e&2){let t=u();d(),p("img",t.Users)("size",48)}}function Tt(e,o){if(e&1&&g(0,"img",16),e&2){let t=u().$implicit;p("src",t.photoURL,P)("alt",t.displayName)}}function Mt(e,o){if(e&1&&(a(0,"span",24),g(1,"lucide-icon",4),l(2," \u8D0A\u52A9\u6703\u54E1 "),r()),e&2){let t=u(4);d(),p("img",t.Crown)("size",12)}}function Pt(e,o){if(e&1&&g(0,"lucide-icon",4),e&2){let t=u(5);p("img",t.Shield)("size",12)}}function qt(e,o){if(e&1&&g(0,"lucide-icon",4),e&2){let t=u(5);p("img",t.Crown)("size",12)}}function Nt(e,o){if(e&1&&(a(0,"span",24),c(1,Pt,1,2,"lucide-icon",4)(2,qt,1,2,"lucide-icon",4),l(3),r()),e&2){let t=u(),n=u(3);Be(n.getRoleBadgeClass(t.role)),d(),m(t.role==="admin"?1:t.role==="premium"?2:-1),d(2),D(" ",n.getRoleDisplayName(t.role)," ")}}function Bt(e,o){if(e&1&&c(0,Mt,3,2,"span",24)(1,Nt,4,4,"span",25),e&2){let t=o,n=u(3);m(t.role==="premium"&&t.premiumUntil&&n.getDaysUntilExpiry(t.premiumUntil)!==null&&n.getDaysUntilExpiry(t.premiumUntil)<=0?0:1)}}function kt(e,o){if(e&1&&(a(0,"span",19),l(1),r()),e&2){let t=u(3);d(),v(t.getRoleDisplayName("free"))}}function Rt(e,o){if(e&1&&(a(0,"div",27),l(1),r()),e&2){let t=o;I("text-error",t<7)("text-warning",t>=7&&t<30),d(),D(" (\u5269\u9918 ",t," \u5929) ")}}function Lt(e,o){if(e&1&&(a(0,"div")(1,"div"),l(2),r(),c(3,Rt,2,5,"div",26),r()),e&2){let t,n=o,i=u(3);d(2),v(i.formatDate(n)),d(),m((t=i.getDaysUntilExpiry(n))?3:-1,t)}}function Vt(e,o){e&1&&(a(0,"span",20),l(1,"-"),r())}function It(e,o){if(e&1){let t=y();a(0,"tr")(1,"td")(2,"div",13)(3,"div",14)(4,"div",15),c(5,Tt,1,2,"img",16),r()(),a(6,"div")(7,"div",17),l(8),r(),a(9,"div",18),l(10),r()()()(),a(11,"td"),l(12),r(),a(13,"td"),c(14,Bt,2,1)(15,kt,2,1,"span",19),r(),a(16,"td"),c(17,Lt,4,2,"div")(18,Vt,2,0,"span",20),r(),a(19,"td"),l(20),r(),a(21,"td")(22,"div",21)(23,"button",22),C("click",function(){let i=f(t).$implicit,s=u(2);return x(s.editUser.emit(i))}),l(24," \u7DE8\u8F2F "),r(),a(25,"button",23),C("click",function(){let i=f(t).$implicit,s=u(2);return x(s.deleteUser.emit(i))}),l(26," \u522A\u9664 "),r()()()()}if(e&2){let t,n,i=o.$implicit,s=u(2);d(5),m(i.photoURL?5:-1),d(3),D(" ",i.displayName||"\u672A\u547D\u540D"," "),d(2),D(" ",i.uid.substring(0,8),"... "),d(2),v(i.email||"-"),d(2),m((t=i.platforms.quotation)?14:15,t),d(3),m((n=i.platforms.quotation==null?null:i.platforms.quotation.premiumUntil)?17:18,n),d(3),v(s.formatDate(i.createdAt))}}function Ot(e,o){if(e&1&&(a(0,"div",9)(1,"table",12)(2,"thead")(3,"tr")(4,"th"),l(5,"\u4F7F\u7528\u8005"),r(),a(6,"th"),l(7,"Email"),r(),a(8,"th"),l(9,"\u89D2\u8272"),r(),a(10,"th"),l(11,"\u8D0A\u52A9\u5230\u671F\u65E5"),r(),a(12,"th"),l(13,"\u8A3B\u518A\u6642\u9593"),r(),a(14,"th"),l(15,"\u64CD\u4F5C"),r()()(),a(16,"tbody"),L(17,It,27,7,"tr",null,At),r()()()),e&2){let t=u();d(17),V(t.users())}}var rt=(()=>{let o=class o{constructor(){this.users=S.required(),this.loading=S(!1),this.refresh=A(),this.editUser=A(),this.deleteUser=A(),this.Users=Je,this.Crown=ie,this.Shield=De,this.getRoleDisplayName=it,this.getRoleBadgeClass=nt,this.formatDate=ot,this.getDaysUntilExpiry=at}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-user-list"]],inputs:{users:[1,"users"],loading:[1,"loading"]},outputs:{refresh:"refresh",editUser:"editUser",deleteUser:"deleteUser"},decls:12,vars:5,consts:[[1,"card","bg-base-100","shadow-xl"],[1,"card-body"],[1,"flex","items-center","justify-between","mb-4"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],["type","button",1,"btn","btn-sm","btn-primary",3,"click","disabled"],[1,"loading","loading-spinner","loading-sm"],[1,"flex","justify-center","py-8"],[1,"text-center","py-8","text-base-content/60"],[1,"overflow-x-auto"],[1,"loading","loading-spinner","loading-lg"],[1,"mx-auto","mb-2","opacity-30",3,"img","size"],[1,"table","table-zebra"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-10","h-10","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"text-xs","text-base-content/60"],[1,"badge","badge-soft"],[1,"text-base-content/40"],[1,"flex","gap-2"],["type","button",1,"btn","btn-sm","btn-ghost",3,"click"],["type","button",1,"btn","btn-sm","btn-error","btn-outline",3,"click"],[1,"badge","badge-soft","gap-1"],[1,"badge","badge-soft","gap-1",3,"class"],[1,"text-xs",3,"text-error","text-warning"],[1,"text-xs"]],template:function(i,s){i&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"h2",3),g(4,"lucide-icon",4),l(5," \u4F7F\u7528\u8005\u7BA1\u7406 "),r(),a(6,"button",5),C("click",function(){return s.refresh.emit()}),c(7,wt,1,0,"span",6),l(8," \u91CD\u65B0\u6574\u7406 "),r()(),c(9,Ft,2,0,"div",7)(10,Ut,4,2,"div",8)(11,Ot,19,0,"div",9),r()()),i&2&&(d(4),p("img",s.Users)("size",24),d(2),p("disabled",s.loading()),d(),m(s.loading()?7:-1),d(2),m(s.loading()?9:s.users().length===0?10:11))},dependencies:[U,M,T],encapsulation:2});let e=o;return e})();function jt(e,o){if(e&1&&g(0,"img",5),e&2){let t=u();p("src",t.user().photoURL,P)("alt",t.user().displayName)}}function zt(e,o){if(e&1){let t=y();a(0,"div",8)(1,"label",9)(2,"span",10),l(3,"\u8D0A\u52A9\u5230\u671F\u65E5"),r()(),a(4,"input",18),z("ngModelChange",function(i){f(t);let s=u();return j(s.premiumUntilDate,i)||(s.premiumUntilDate=i),x(i)}),r(),a(5,"label",9)(6,"span",19),l(7,"\u8A2D\u5B9A\u8D0A\u52A9\u6703\u54E1\u7684\u6709\u6548\u671F\u9650"),r()()()}if(e&2){let t=u();d(4),O("ngModel",t.premiumUntilDate)}}var st=(()=>{let o=class o{constructor(){this.user=S.required(),this.save=A(),this.cancel=A(),this.selectedRole=E("free"),this.premiumUntilDate=E(""),xe(()=>{let i=this.user().platforms.quotation;if(this.selectedRole.set(i?.role||"free"),i?.premiumUntil){let s=i.premiumUntil.toDate();this.premiumUntilDate.set(s.toISOString().split("T")[0])}else this.premiumUntilDate.set("")})}handleCancel(){this.cancel.emit()}handleSave(){let n={role:this.selectedRole()};this.selectedRole()==="premium"&&this.premiumUntilDate()?n.premiumUntil=Le.fromDate(new Date(this.premiumUntilDate())):n.premiumUntil=null,this.save.emit(n)}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-user-edit-form"]],inputs:{user:[1,"user"]},outputs:{save:"save",cancel:"cancel"},decls:29,vars:5,consts:[[1,"font-bold","text-lg","mb-4"],[1,"mb-4","p-4","bg-base-200","rounded-lg"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-12","h-12","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"text-sm","text-base-content/60"],[1,"form-control","mb-4"],[1,"label"],[1,"label-text","font-medium"],[1,"select","select-bordered",3,"ngModelChange","ngModel"],["value","free"],["value","premium"],["value","admin"],[1,"flex","justify-end","gap-2","mt-6"],["type","button",1,"btn","btn-ghost",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","date",1,"input","input-bordered",3,"ngModelChange","ngModel"],[1,"label-text-alt"]],template:function(i,s){i&1&&(a(0,"h3",0),l(1,"\u7DE8\u8F2F\u4F7F\u7528\u8005\u6B0A\u9650"),r(),a(2,"div",1)(3,"div",2)(4,"div",3)(5,"div",4),c(6,jt,1,2,"img",5),r()(),a(7,"div")(8,"div",6),l(9),r(),a(10,"div",7),l(11),r()()()(),a(12,"div",8)(13,"label",9)(14,"span",10),l(15,"\u89D2\u8272"),r()(),a(16,"select",11),z("ngModelChange",function(b){return j(s.selectedRole,b)||(s.selectedRole=b),b}),a(17,"option",12),l(18,"\u514D\u8CBB\u6703\u54E1"),r(),a(19,"option",13),l(20,"\u8D0A\u52A9\u6703\u54E1"),r(),a(21,"option",14),l(22,"\u7BA1\u7406\u54E1"),r()()(),c(23,zt,8,1,"div",8),a(24,"div",15)(25,"button",16),C("click",function(){return s.handleCancel()}),l(26," \u53D6\u6D88 "),r(),a(27,"button",17),C("click",function(){return s.handleSave()}),l(28," \u5132\u5B58 "),r()()),i&2&&(d(6),m(s.user().photoURL?6:-1),d(3),v(s.user().displayName||"\u672A\u547D\u540D"),d(2),v(s.user().email),d(5),O("ngModel",s.selectedRole),d(7),m(s.selectedRole()==="premium"?23:-1))},dependencies:[U,te,je,ze,Y,Oe,Z,ee],encapsulation:2});let e=o;return e})();function Wt(e,o){if(e&1){let t=y();_e(0,"dialog",0)(1,"div",1)(2,"h3",2),l(3),Ce(),qe(4,"img",3),_e(5,"div",4)(6,"button",5),Te("click",function(){f(t);let i=u();return x(i.onClose())}),l(7,"\u95DC\u9589"),Ce()()(),_e(8,"div",6),Te("click",function(i){f(t);let s=u();return x(s.onBackdropClick(i))}),Ce()()}if(e&2){let t=u();d(3),v(t.title()),d(),Ne("src",t.proofUrl(),P)}}var lt=(()=>{let o=class o{constructor(){this.isOpen=S(!1),this.proofUrl=S(""),this.title=S("\u8D0A\u52A9\u6191\u8B49"),this.close=A()}onClose(){this.close.emit()}onBackdropClick(n){n.target===n.currentTarget&&this.onClose()}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-proof-modal"]],inputs:{isOpen:[1,"isOpen"],proofUrl:[1,"proofUrl"],title:[1,"title"]},outputs:{close:"close"},decls:1,vars:1,consts:[[1,"modal","modal-open"],[1,"modal-box"],[1,"font-bold","text-lg","mb-4"],["alt","\u6191\u8B49","loading","lazy",1,"w-full","rounded-lg",3,"src"],[1,"modal-action"],[1,"btn",3,"click"],[1,"modal-backdrop",3,"click"]],template:function(i,s){i&1&&c(0,Wt,9,2,"dialog",0),i&2&&m(s.isOpen()?0:-1)},dependencies:[U],encapsulation:2});let e=o;return e})();var Fe=(()=>{let o=class o{constructor(){this.firestoreService=w(K),this.db=Ve(),this.COLLECTION_NAME="donations"}createOrUpdateRequest(n,i,s,_,b,k=!1){return h(this,null,function*(){try{let R=H(this.db,this.COLLECTION_NAME),Ue=G(R,q("uid","==",n)),de=yield J(Ue),ue=B();if(de.empty)yield Ie(R,{uid:n,userDisplayName:i,userEmail:s,proof:_,note:b,status:"pending",createdAt:ue,updatedAt:ue});else{let ce=de.docs[0],me=ce.data();if(me.status==="pending")throw new Error("\u60A8\u7684\u7533\u8ACB\u6B63\u5728\u5BE9\u6838\u4E2D\uFF0C\u8ACB\u8010\u5FC3\u7B49\u5019");if(me.status==="approved"){if(k)throw new Error("\u60A8\u5DF2\u7D93\u662F\u8D0A\u52A9\u6703\u54E1\u4E86");yield N(W(this.db,this.COLLECTION_NAME,ce.id),{proof:_,note:b,status:"pending",updatedAt:ue})}else(me.status==="rejected"||me.status==="expired")&&(yield N(W(this.db,this.COLLECTION_NAME,ce.id),{proof:_,note:b,status:"pending",updatedAt:ue}))}}catch(R){throw console.error("Failed to create or update donation request:",R),R}})}getPendingRequests(){return h(this,null,function*(){try{let n=H(this.db,this.COLLECTION_NAME),i=G(n,q("status","==","pending"),ve("createdAt","desc"));return(yield J(i)).docs.map(_=>pe({id:_.id},_.data()))}catch(n){throw console.error("Failed to get pending requests:",n),n}})}getMyRequests(n){return h(this,null,function*(){try{let i=H(this.db,this.COLLECTION_NAME),s=G(i,q("uid","==",n),q("status","in",["pending","rejected","expired"]),ve("createdAt","desc"));return(yield J(s)).docs.map(b=>pe({id:b.id},b.data()))}catch(i){throw console.error("Failed to get my requests:",i),i}})}withdrawRequest(n,i){return h(this,null,function*(){try{let s=W(this.db,this.COLLECTION_NAME,n);yield N(s,{status:"rejected",reviewedBy:i,reviewedAt:B(),updatedAt:B()})}catch(s){throw console.error("Failed to withdraw request:",s),s}})}getProcessedRequests(){return h(this,null,function*(){try{let n=H(this.db,this.COLLECTION_NAME),i=G(n,q("status","in",["approved","rejected"]),ve("updatedAt","desc"));return(yield J(i)).docs.map(_=>pe({id:_.id},_.data()))}catch(n){throw console.error("Failed to get processed requests:",n),n}})}resetRequestStatus(n){return h(this,null,function*(){try{let i=W(this.db,this.COLLECTION_NAME,n);yield N(i,{status:"pending",updatedAt:B()})}catch(i){throw console.error("Failed to reset request status:",i),i}})}approveRequest(n,i,s){return h(this,null,function*(){try{let _=W(this.db,this.COLLECTION_NAME,n),b=B();yield N(_,{status:"approved",reviewedBy:i,reviewedAt:b,updatedAt:b});let k=new Date;k.setMonth(k.getMonth()+1),yield this.firestoreService.updateUserRole(s,"premium",k)}catch(_){throw console.error("Failed to approve request:",_),_}})}rejectRequest(n,i){return h(this,null,function*(){try{let s=W(this.db,this.COLLECTION_NAME,n),_=B();yield N(s,{status:"rejected",reviewedBy:i,reviewedAt:_,updatedAt:_})}catch(s){throw console.error("Failed to reject request:",s),s}})}markAsExpired(n){return h(this,null,function*(){try{let i=H(this.db,this.COLLECTION_NAME),s=G(i,q("uid","==",n),q("status","==","approved")),_=yield J(s);if(!_.empty){let b=_.docs[0].ref;yield N(b,{status:"expired",updatedAt:B()})}}catch(i){throw console.error("Failed to mark request as expired:",i),i}})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275prov=Pe({token:o,factory:o.\u0275fac,providedIn:"root"});let e=o;return e})();var dt=(e,o)=>o.id;function $t(e,o){if(e&1&&(a(0,"span",8),l(1),r()),e&2){let t=u();d(),v(t.pendingRequests().length)}}function Xt(e,o){if(e&1){let t=y();a(0,"app-user-list",12),C("editUser",function(i){f(t);let s=u();return x(s.startEdit(i))})("deleteUser",function(i){f(t);let s=u();return x(s.confirmDelete(i))}),r()}if(e&2){let t=u();p("users",t.users())("loading",t.loading())}}function Ht(e,o){if(e&1&&(a(0,"span",8),l(1),r()),e&2){let t=u(2);d(),v(t.pendingRequests().length)}}function Gt(e,o){e&1&&(a(0,"div",14),g(1,"span",16),r())}function Jt(e,o){if(e&1){let t=y();a(0,"tr")(1,"td"),l(2),re(3,"date"),r(),a(4,"td")(5,"div",18),l(6),r(),a(7,"div",19),l(8),r()(),a(9,"td")(10,"button",20),C("click",function(){let i=f(t).$implicit,s=u(4);return x(s.openProofModal(i.proof))}),l(11," \u67E5\u770B\u6191\u8B49 "),r()(),a(12,"td",21),l(13),r(),a(14,"td")(15,"div",22)(16,"button",23),C("click",function(){let i=f(t).$implicit,s=u(4);return x(s.approveRequest(i))}),l(17," \u6838\u51C6 "),r(),a(18,"button",24),C("click",function(){let i=f(t).$implicit,s=u(4);return x(s.rejectRequest(i))}),l(19," \u62D2\u7D55 "),r()()()()}if(e&2){let t=o.$implicit;d(2),D(" ",se(3,4,t.createdAt.toDate(),"yyyy/MM/dd HH:mm")," "),d(4),v(t.userDisplayName),d(2),D(" ",t.userEmail," "),d(5),v(t.note||"-")}}function Kt(e,o){e&1&&(a(0,"tr")(1,"td",25),l(2," \u76EE\u524D\u6C92\u6709\u5F85\u5BE9\u6838\u7684\u7533\u8ACB "),r()())}function Qt(e,o){if(e&1&&(a(0,"div",15)(1,"table",17)(2,"thead")(3,"tr")(4,"th"),l(5,"\u7533\u8ACB\u6642\u9593"),r(),a(6,"th"),l(7,"\u4F7F\u7528\u8005"),r(),a(8,"th"),l(9,"\u6191\u8B49"),r(),a(10,"th"),l(11,"\u5099\u8A3B"),r(),a(12,"th"),l(13,"\u64CD\u4F5C"),r()()(),a(14,"tbody"),L(15,Jt,20,7,"tr",null,dt),c(17,Kt,3,0,"tr"),r()()()),e&2){let t=u(3);d(15),V(t.pendingRequests()),d(2),m(t.pendingRequests().length===0?17:-1)}}function Yt(e,o){if(e&1&&c(0,Gt,2,0,"div",14)(1,Qt,18,1,"div",15),e&2){let t=u(2);m(t.donationLoading()?0:1)}}function Zt(e,o){e&1&&(a(0,"div",14),g(1,"span",16),r())}function ei(e,o){e&1&&(a(0,"span",26),l(1,"\u5DF2\u6838\u51C6"),r())}function ti(e,o){e&1&&(a(0,"span",27),l(1,"\u5DF2\u904E\u671F"),r())}function ii(e,o){e&1&&(a(0,"span",28),l(1,"\u5DF2\u53D6\u6D88"),r())}function ni(e,o){e&1&&(a(0,"span",29),l(1,"\u5DF2\u62D2\u7D55"),r())}function oi(e,o){if(e&1){let t=y();a(0,"button",31),C("click",function(){f(t);let i=u().$implicit,s=u(4);return x(s.resetRequest(i))}),l(1," \u91CD\u65B0\u5BE9\u6838 "),r()}}function ai(e,o){e&1&&(a(0,"span",19),l(1,"-"),r())}function ri(e,o){if(e&1){let t=y();a(0,"tr")(1,"td"),l(2),re(3,"date"),r(),a(4,"td")(5,"div",18),l(6),r(),a(7,"div",19),l(8),r()(),a(9,"td"),c(10,ei,2,0,"span",26)(11,ti,2,0,"span",27)(12,ii,2,0,"span",28)(13,ni,2,0,"span",29),r(),a(14,"td")(15,"button",20),C("click",function(){let i=f(t).$implicit,s=u(4);return x(s.openProofModal(i.proof))}),l(16," \u67E5\u770B\u6191\u8B49 "),r()(),a(17,"td",21),l(18),r(),a(19,"td"),c(20,oi,2,0,"button",30)(21,ai,2,0,"span",19),r()()}if(e&2){let t=o.$implicit;d(2),D(" ",se(3,6,t.updatedAt.toDate(),"yyyy/MM/dd HH:mm")," "),d(4),v(t.userDisplayName),d(2),D(" ",t.userEmail," "),d(2),m(t.status==="approved"?10:t.status==="expired"?11:t.reviewedBy===t.uid?12:13),d(8),v(t.note||"-"),d(2),m(t.status==="rejected"&&t.reviewedBy!==t.uid?20:21)}}function si(e,o){e&1&&(a(0,"tr")(1,"td",32),l(2," \u76EE\u524D\u6C92\u6709\u5DF2\u8655\u7406\u7684\u7533\u8ACB "),r()())}function li(e,o){if(e&1&&(a(0,"div",15)(1,"table",17)(2,"thead")(3,"tr")(4,"th"),l(5,"\u5BE9\u6838\u6642\u9593"),r(),a(6,"th"),l(7,"\u4F7F\u7528\u8005"),r(),a(8,"th"),l(9,"\u72C0\u614B"),r(),a(10,"th"),l(11,"\u6191\u8B49"),r(),a(12,"th"),l(13,"\u5099\u8A3B"),r(),a(14,"th"),l(15,"\u64CD\u4F5C"),r()()(),a(16,"tbody"),L(17,ri,22,9,"tr",null,dt),c(19,si,3,0,"tr"),r()()()),e&2){let t=u(3);d(17),V(t.processedRequests()),d(2),m(t.processedRequests().length===0?19:-1)}}function di(e,o){if(e&1&&c(0,Zt,2,0,"div",14)(1,li,20,1,"div",15),e&2){let t=u(2);m(t.donationLoading()?0:1)}}function ui(e,o){if(e&1){let t=y();a(0,"div",13)(1,"a",7),C("click",function(){f(t);let i=u();return x(i.switchDonationTab("pending"))}),l(2," \u5F85\u5BE9\u6838 "),c(3,Ht,2,1,"span",8),r(),a(4,"a",7),C("click",function(){f(t);let i=u();return x(i.switchDonationTab("history"))}),l(5," \u5DF2\u8655\u7406 "),r()(),c(6,Yt,2,1)(7,di,2,1)}if(e&2){let t=u();d(),I("tab-active",t.donationTab()==="pending"),d(2),m(t.pendingRequests().length>0?3:-1),d(),I("tab-active",t.donationTab()==="history"),d(2),m(t.donationTab()==="pending"?6:7)}}function ci(e,o){if(e&1){let t=y();a(0,"dialog",10)(1,"div",33)(2,"app-user-edit-form",34),C("save",function(i){f(t);let s=u();return x(s.handleSave(i))})("cancel",function(){f(t);let i=u();return x(i.cancelEdit())}),r()(),a(3,"form",35)(4,"button",36),C("click",function(){f(t);let i=u();return x(i.cancelEdit())}),l(5,"close"),r()()()}if(e&2){let t=u();d(2),p("user",t.editingUser())}}var ut=(()=>{let o=class o{constructor(){this.firestoreService=w(K),this.donationService=w(Fe),this.toastService=w(Q),this.authService=w(be),this.users=S.required(),this.loading=S(!1),this.refreshUsers=A(),this.editingUser=E(null),this.pendingRequests=E([]),this.processedRequests=E([]),this.activeTab=E("users"),this.donationTab=E("pending"),this.donationLoading=E(!1),this.isProofModalOpen=E(!1),this.selectedProofUrl=E(""),this.Shield=De}startEdit(n){this.editingUser.set(n)}cancelEdit(){this.editingUser.set(null)}handleSave(n){return h(this,null,function*(){let i=this.editingUser();if(i)try{yield this.firestoreService.updateUserRole(i.uid,n.role,n.premiumUntil?n.premiumUntil.toDate():null),this.toastService.success("\u4F7F\u7528\u8005\u6B0A\u9650\u5DF2\u66F4\u65B0"),this.refreshUsers.emit(),this.cancelEdit()}catch(s){console.error("Failed to update user:",s),this.toastService.error("\u66F4\u65B0\u4F7F\u7528\u8005\u6B0A\u9650\u5931\u6557")}})}confirmDelete(n){let i=n.displayName||n.email||"Unknown User";confirm(`\u78BA\u5B9A\u8981\u522A\u9664\u4F7F\u7528\u8005\u300C${i}\u300D\u55CE\uFF1F

\u6B64\u64CD\u4F5C\u7121\u6CD5\u5FA9\u539F\uFF01`)&&this.handleDelete(n)}handleDelete(n){return h(this,null,function*(){try{yield this.firestoreService.deleteUser(n.uid),this.toastService.success("\u4F7F\u7528\u8005\u5DF2\u522A\u9664"),this.refreshUsers.emit()}catch(i){console.error("Failed to delete user:",i),this.toastService.error("\u522A\u9664\u4F7F\u7528\u8005\u5931\u6557")}})}switchTab(n){this.activeTab.set(n),n==="donations"&&this.loadPendingRequests()}switchDonationTab(n){this.donationTab.set(n),n==="pending"?this.loadPendingRequests():this.loadProcessedRequests()}loadPendingRequests(){return h(this,null,function*(){this.donationLoading.set(!0);try{let n=yield this.donationService.getPendingRequests();this.pendingRequests.set(n)}catch(n){console.error("Failed to load pending requests:",n),this.toastService.error("\u8F09\u5165\u7533\u8ACB\u5931\u6557")}finally{this.donationLoading.set(!1)}})}loadProcessedRequests(){return h(this,null,function*(){this.donationLoading.set(!0);try{let n=yield this.donationService.getProcessedRequests();this.processedRequests.set(n)}catch(n){console.error("Failed to load processed requests:",n),this.toastService.error("\u8F09\u5165\u6B77\u53F2\u7D00\u9304\u5931\u6557")}finally{this.donationLoading.set(!1)}})}openProofModal(n){this.selectedProofUrl.set(n),this.isProofModalOpen.set(!0)}closeProofModal(){this.isProofModalOpen.set(!1),this.selectedProofUrl.set("")}approveRequest(n){return h(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u6838\u51C6 ${n.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{let i=this.authService.currentUser();if(!i)return;yield this.donationService.approveRequest(n.id,i.uid,n.uid),this.toastService.success("\u5DF2\u6838\u51C6\u7533\u8ACB"),yield this.loadPendingRequests(),this.refreshUsers.emit()}catch(i){console.error("Failed to approve request:",i),this.toastService.error("\u6838\u51C6\u5931\u6557")}})}rejectRequest(n){return h(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u62D2\u7D55 ${n.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{let i=this.authService.currentUser();if(!i)return;yield this.donationService.rejectRequest(n.id,i.uid),this.toastService.success("\u5DF2\u62D2\u7D55\u7533\u8ACB"),yield this.loadPendingRequests()}catch(i){console.error("Failed to reject request:",i),this.toastService.error("\u62D2\u7D55\u5931\u6557")}})}resetRequest(n){return h(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u91CD\u65B0\u5BE9\u6838 ${n.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{yield this.donationService.resetRequestStatus(n.id),this.toastService.success("\u5DF2\u91CD\u65B0\u958B\u653E\u5BE9\u6838"),yield this.loadProcessedRequests()}catch(i){console.error("Failed to reset request:",i),this.toastService.error("\u91CD\u65B0\u5BE9\u6838\u5931\u6557")}})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-admin-panel"]],inputs:{users:[1,"users"],loading:[1,"loading"]},outputs:{refreshUsers:"refreshUsers"},decls:17,vars:11,consts:[[1,"card","bg-base-100","shadow-xl"],[1,"card-body"],[1,"flex","items-center","justify-between","mb-6"],[1,"flex","items-center","gap-2"],[1,"text-primary",3,"img","size"],[1,"card-title"],[1,"tabs","tabs-boxed"],[1,"tab",3,"click"],[1,"badge","badge-sm","badge-error","ml-1"],[3,"users","loading"],[1,"modal","modal-open"],[3,"close","isOpen","proofUrl"],[3,"editUser","deleteUser","users","loading"],[1,"tabs","tabs-boxed","mb-4"],[1,"flex","justify-center","items-center","py-12"],[1,"overflow-x-auto"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"table"],[1,"font-bold"],[1,"text-xs","opacity-50"],[1,"btn","btn-ghost","btn-xs",3,"click"],[1,"max-w-xs","truncate"],[1,"join"],[1,"btn","btn-success","btn-xs","join-item",3,"click"],[1,"btn","btn-error","btn-xs","join-item",3,"click"],["colspan","5",1,"text-center","py-8","text-base-content/50"],[1,"badge","badge-success"],[1,"badge","badge-warning"],[1,"badge","badge-ghost"],[1,"badge","badge-error"],[1,"btn","btn-warning","btn-xs"],[1,"btn","btn-warning","btn-xs",3,"click"],["colspan","6",1,"text-center","py-8","text-base-content/50"],[1,"modal-box"],[3,"save","cancel","user"],["method","dialog",1,"modal-backdrop"],[3,"click"]],template:function(i,s){i&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),g(4,"lucide-icon",4),a(5,"h2",5),l(6,"\u7BA1\u7406\u54E1\u9762\u677F"),r()(),a(7,"div",6)(8,"a",7),C("click",function(){return s.switchTab("users")}),l(9," \u4F7F\u7528\u8005\u7BA1\u7406 "),r(),a(10,"a",7),C("click",function(){return s.switchTab("donations")}),l(11," \u8D0A\u52A9\u5BE9\u6838 "),c(12,$t,2,1,"span",8),r()()(),c(13,Xt,1,2,"app-user-list",9)(14,ui,8,6),r()(),c(15,ci,6,1,"dialog",10),a(16,"app-proof-modal",11),C("close",function(){return s.closeProofModal()}),r()),i&2&&(d(4),p("img",s.Shield)("size",24),d(4),I("tab-active",s.activeTab()==="users"),d(2),I("tab-active",s.activeTab()==="donations"),d(2),m(s.pendingRequests().length>0?12:-1),d(),m(s.activeTab()==="users"?13:14),d(2),m(s.editingUser()?15:-1),d(),p("isOpen",s.isProofModalOpen())("proofUrl",s.selectedProofUrl()))},dependencies:[U,M,T,rt,st,lt,he],encapsulation:2});let e=o;return e})();var mi=(e,o,t,n)=>({request:e,requestId:o,status:"pending",icon:t,iconColor:"text-info",borderColor:"border-info",titleColor:"text-info",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u6B63\u5728\u5BE9\u6838\u4E2D",timeLabel:"\u63D0\u4EA4\u6642\u9593",time:n,message:"\u8ACB\u8010\u5FC3\u7B49\u5019\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u8655\u7406\u60A8\u7684\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"pendingProofPreview"}),pi=(e,o,t,n)=>({request:e,requestId:o,status:"cancelled",icon:t,iconColor:"text-base-content/50",borderColor:"border-base-content/20",titleColor:"text-base-content/70",title:"\u60A8\u5DF2\u53D6\u6D88\u7533\u8ACB",timeLabel:"\u53D6\u6D88\u6642\u9593",time:n,message:"\u60A8\u53EF\u4EE5\u96A8\u6642\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"cancelledProofPreview"}),_i=(e,o,t,n)=>({request:e,requestId:o,status:"rejected",icon:t,iconColor:"text-error",borderColor:"border-error",titleColor:"text-error",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u5DF2\u88AB\u62D2\u7D55",timeLabel:"\u5BE9\u6838\u6642\u9593",time:n,message:"\u60A8\u53EF\u4EE5\u4FEE\u6539\u6191\u8B49\u6216\u5099\u8A3B\u5F8C\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"rejectedProofPreview"}),Ci=(e,o,t,n)=>({request:e,requestId:o,status:"expired",icon:t,iconColor:"text-warning",borderColor:"border-warning",titleColor:"text-warning",title:"\u60A8\u7684\u8D0A\u52A9\u5DF2\u5230\u671F",timeLabel:"\u5230\u671F\u6642\u9593",time:n,message:"\u611F\u8B1D\u60A8\u904E\u53BB\u7684\u652F\u6301\uFF01\u60A8\u53EF\u4EE5\u91CD\u65B0\u7533\u8ACB\u7E8C\u7D04\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u7684\u8D0A\u52A9\u8CC7\u6599",modalId:"expiredProofPreview"}),fi=(e,o)=>o.id;function xi(e,o){if(e&1&&(a(0,"div",2)(1,"div",3),g(2,"lucide-icon",4),a(3,"h2",5),l(4,"\u8ACB\u5148\u767B\u5165"),r(),a(5,"p"),l(6,"\u767B\u5165\u5F8C\u5373\u53EF\u67E5\u770B\u6703\u54E1\u8CC7\u8A0A"),r()()()),e&2){let t=u();d(2),p("img",t.User)("size",48)}}function gi(e,o){e&1&&ne(0)}function hi(e,o){if(e&1&&X(0,gi,1,0,"ng-container",11),e&2){let t=u().$implicit,n=u(3),i=oe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ae(2,mi,t,t.id,n.Clock,t.createdAt))}}function vi(e,o){e&1&&ne(0)}function bi(e,o){if(e&1&&X(0,vi,1,0,"ng-container",11),e&2){let t=u(2).$implicit,n=u(3),i=oe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ae(2,pi,t,t.id,n.XCircle,t.updatedAt))}}function Ei(e,o){e&1&&ne(0)}function yi(e,o){if(e&1&&X(0,Ei,1,0,"ng-container",11),e&2){let t=u(2).$implicit,n=u(3),i=oe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ae(2,_i,t,t.id,n.XCircle,t.updatedAt))}}function Si(e,o){if(e&1&&c(0,bi,1,7,"ng-container")(1,yi,1,7,"ng-container"),e&2){let t,n=u().$implicit,i=u(3);m(n.reviewedBy===((t=i.authService.currentUser())==null?null:t.uid)?0:1)}}function Di(e,o){e&1&&ne(0)}function Ai(e,o){if(e&1&&X(0,Di,1,0,"ng-container",11),e&2){let t=u().$implicit,n=u(3),i=oe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ae(2,Ci,t,t.id,n.Clock,t.updatedAt))}}function wi(e,o){if(e&1&&c(0,hi,1,7,"ng-container")(1,Si,2,1)(2,Ai,1,7,"ng-container"),e&2){let t=o.$implicit;m(t.status==="pending"?0:t.status==="rejected"?1:t.status==="expired"?2:-1)}}function Fi(e,o){if(e&1&&L(0,wi,3,1,null,null,fi),e&2){let t=u(2);V(t.myDonationRequests())}}function Ui(e,o){if(e&1){let t=y();a(0,"div",8)(1,"app-donation-form",12),C("submitDonation",function(i){f(t);let s=u(2);return x(s.handleDonationSubmit(i))}),r()()}}function Ti(e,o){if(e&1&&(a(0,"div",9),g(1,"lucide-icon",13),a(2,"div")(3,"h3",14),l(4,"\u611F\u8B1D\u60A8\u7684\u8D0A\u52A9\uFF01"),r(),a(5,"div",15),l(6,"\u60A8\u5DF2\u7D93\u662F\u8D0A\u52A9\u6703\u54E1\uFF0C\u4EAB\u6709\u6240\u6709\u9032\u968E\u529F\u80FD\u3002"),r()()()),e&2){let t=u(2);d(),p("img",t.Check)("size",24)}}function Mi(e,o){if(e&1){let t=y();a(0,"app-admin-panel",16),C("refreshUsers",function(){f(t);let i=u(2);return x(i.loadUsers())}),r()}if(e&2){let t=u(2);p("users",t.users())("loading",t.loading())}}function Pi(e,o){if(e&1){let t=y();a(0,"h1",6),l(1,"\u6703\u54E1\u4E2D\u5FC3"),r(),a(2,"app-user-profile",7),C("displayNameChange",function(i){f(t);let s=u();return x(s.handleDisplayNameChange(i))}),r(),c(3,Fi,2,0),c(4,Ui,2,0,"div",8),c(5,Ti,7,2,"div",9),c(6,Mi,1,2,"app-admin-panel",10)}if(e&2){let t=u();d(2),p("userDisplayName",t.authService.userDisplayName())("userEmail",t.authService.userEmail())("isPremium",t.authService.isPremium())("isAdmin",t.authService.isAdmin())("formattedCreatedAt",t.formattedCreatedAt())("formattedPremiumUntil",t.formattedPremiumUntil())("daysUntilExpiry",t.daysUntilExpiry())("showExpiryWarning",t.showExpiryWarning()??!1),d(),m(!t.authService.isPremium()&&!t.authService.isAdmin()&&t.myDonationRequests().length>0?3:-1),d(),m(!t.authService.isPremium()&&!t.authService.isAdmin()?4:-1),d(),m(t.authService.isPremium()?5:-1),d(),m(t.authService.isAdmin()?6:-1)}}function qi(e,o){if(e&1&&(l(0),re(1,"date")),e&2){let t=u(),n=t.timeLabel,i=t.time;fe(" ",n,"\uFF1A",se(1,2,i.toDate(),"yyyy/MM/dd HH:mm")," ")}}function Ni(e,o){if(e&1){let t=y();a(0,"div",25)(1,"button",34),C("click",function(){f(t);let i=u().requestId,s=u();return x(s.handleWithdraw(i))}),l(2," \u64A4\u56DE\u7533\u8ACB "),r()()}}function Bi(e,o){if(e&1){let t=y();a(0,"div")(1,"label",37)(2,"span",38),l(3,"\u8D0A\u52A9\u6191\u8B49"),r()(),a(4,"img",39),C("click",function(){f(t);let i=u(2).modalId,s=u();return x(s.openProofModal(i))}),r()()}if(e&2){let t=u(2).request;d(4),p("src",t.proof,P)}}function ki(e,o){if(e&1&&(a(0,"div")(1,"label",37)(2,"span",38),l(3,"\u5099\u8A3B"),r()(),a(4,"div",40)(5,"p",41),l(6),r()()()),e&2){let t=u(2).request;d(6),v(t.note)}}function Ri(e,o){if(e&1&&(a(0,"div",35),l(1),r(),a(2,"div",36),c(3,Bi,5,1,"div"),c(4,ki,7,1,"div"),r()),e&2){let t=u(),n=t.request,i=t.sectionTitle;d(),v(i),d(2),m(n.proof?3:-1),d(),m(n.note?4:-1)}}function Li(e,o){if(e&1&&(a(0,"div",17)(1,"div",18)(2,"div",19),g(3,"lucide-icon",20),a(4,"div",21)(5,"h3",22),l(6),r(),a(7,"p",23),c(8,qi,2,5),r(),a(9,"p",24),l(10),r(),c(11,Ni,3,0,"div",25),r()(),c(12,Ri,5,3),r()(),a(13,"dialog",26)(14,"div",27)(15,"h3",28),l(16,"\u8D0A\u52A9\u6191\u8B49"),r(),g(17,"img",29),a(18,"div",30)(19,"form",31)(20,"button",32),l(21,"\u95DC\u9589"),r()()()(),a(22,"form",33)(23,"button"),l(24,"close"),r()()()),e&2){let t=o.request,n=o.status,i=o.icon,s=o.iconColor,_=o.borderColor,b=o.titleColor,k=o.title,R=o.time,Ue=o.message,de=o.modalId;p("ngClass",_),d(3),p("img",i)("size",32)("ngClass",s),d(2),p("ngClass",b),d(),v(k),d(2),m(R?8:-1),d(2),v(Ue),d(),m(n==="pending"?11:-1),d(),m(n!=="cancelled"?12:-1),d(),p("id",de),d(4),p("src",t.proof,P)}}var Hn=(()=>{let o=class o{constructor(){this.authService=w(be),this.toastService=w(Q),this.firestoreService=w(K),this.donationService=w(Fe),this.User=Ae,this.Check=ye,this.Clock=Se,this.XCircle=$e,this.users=E([]),this.loading=E(!1),this.myDonationRequests=E([]),this.formattedCreatedAt=le(()=>{let n=this.authService.userData()?.createdAt;return n?this.formatDate(n):null}),this.formattedPremiumUntil=le(()=>{let n=this.authService.userData()?.platforms.quotation?.premiumUntil;return n?this.formatDate(n):null}),this.daysUntilExpiry=le(()=>{let n=this.authService.userData()?.platforms.quotation?.premiumUntil;if(!n)return null;let i=new Date,s=n.toDate().getTime()-i.getTime();return Math.ceil(s/(1e3*60*60*24))}),this.showExpiryWarning=le(()=>{let n=this.daysUntilExpiry();return this.authService.userData()?.platforms.quotation?.premiumUntil&&n!==null&&n<=7}),xe(()=>{let n=this.authService.userData(),i=this.authService.isAdmin(),s=this.authService.isPremium();n&&i&&this.users().length===0&&this.loadUsers(),n&&!s&&!i&&(this.checkAndMarkExpiredRequest(n),this.loadMyRequests())})}checkAndMarkExpiredRequest(n){return h(this,null,function*(){let i=n?.platforms?.quotation;if(i?.premiumUntil&&i.premiumUntil.toDate()<new Date&&i.role==="free")try{yield this.donationService.markAsExpired(n.uid)}catch(s){console.error("Failed to mark request as expired:",s)}})}handleDonationSubmit(n){return h(this,null,function*(){let i=this.authService.currentUser(),s=this.authService.userData();if(!i||!s){this.toastService.error("\u8ACB\u5148\u767B\u5165");return}try{yield this.donationService.createOrUpdateRequest(i.uid,s.displayName||i.email||"Unknown",s.email||"No Email",n.proof,n.note,this.authService.isPremium()),this.toastService.success("\u8D0A\u52A9\u7533\u8ACB\u5DF2\u9001\u51FA\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\uFF01"),yield this.loadMyRequests()}catch(_){console.error("Failed to submit donation request:",_),this.toastService.error("\u7533\u8ACB\u9001\u51FA\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}})}handleDisplayNameChange(n){return h(this,null,function*(){try{yield this.authService.updateDisplayName(n)}catch(i){console.error("Failed to update display name:",i),this.toastService.error(i.message||"\u540D\u7A31\u66F4\u65B0\u5931\u6557")}})}formatDate(n){return(n instanceof Date?n:n.toDate()).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"})}loadUsers(){return h(this,null,function*(){this.loading.set(!0);try{let n=yield this.firestoreService.getAllUsers(100);this.users.set(n)}catch(n){console.error("loadUsers: Failed!",n),this.toastService.error("\u8F09\u5165\u4F7F\u7528\u8005\u5217\u8868\u5931\u6557\uFF1A"+(n.message||"\u672A\u77E5\u932F\u8AA4"))}finally{this.loading.set(!1)}})}openProofModal(n){let i=document.getElementById(n);i&&i.showModal()}handleWithdraw(n){return h(this,null,function*(){if(!confirm("\u78BA\u5B9A\u8981\u64A4\u56DE\u7533\u8ACB\u55CE\uFF1F\u64A4\u56DE\u5F8C\u60A8\u53EF\u4EE5\u91CD\u65B0\u63D0\u4EA4\u3002"))return;let i=this.authService.currentUser();if(i)try{yield this.donationService.withdrawRequest(n,i.uid),this.toastService.success("\u5DF2\u64A4\u56DE\u7533\u8ACB"),yield this.loadMyRequests()}catch(s){console.error("Failed to withdraw request:",s),this.toastService.error("\u64A4\u56DE\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}})}loadMyRequests(){return h(this,null,function*(){let n=this.authService.currentUser();if(n)try{let i=yield this.donationService.getMyRequests(n.uid);this.myDonationRequests.set(i)}catch(i){console.error("loadMyRequests: Failed!",i)}})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=F({type:o,selectors:[["app-member"]],decls:5,vars:1,consts:[["requestStatusCard",""],[1,"mx-auto","px-4","py-8"],[1,"card","bg-base-100","shadow-sm"],[1,"card-body","text-center"],[1,"mx-auto","text-base-content/50",3,"img","size"],[1,"card-title","justify-center"],[1,"text-3xl","font-bold","mb-6"],[3,"displayNameChange","userDisplayName","userEmail","isPremium","isAdmin","formattedCreatedAt","formattedPremiumUntil","daysUntilExpiry","showExpiryWarning"],["id","donation-form"],[1,"alert","alert-success","alert-soft"],[3,"users","loading"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[3,"submitDonation"],[3,"img","size"],[1,"font-bold"],[1,"text-sm"],[3,"refreshUsers","users","loading"],[1,"card","bg-base-100","shadow-sm","border-2","mb-6",3,"ngClass"],[1,"card-body"],[1,"flex","items-start","gap-4"],[1,"flex-shrink-0",3,"img","size","ngClass"],[1,"flex-1"],[1,"card-title",3,"ngClass"],[1,"text-sm","opacity-70","mt-1"],[1,"text-sm","mt-2"],[1,"mt-4"],[1,"modal",3,"id"],[1,"modal-box","max-w-4xl"],[1,"font-bold","text-lg","mb-4"],["alt","\u6191\u8B49",1,"w-full","rounded-lg",3,"src"],[1,"modal-action"],["method","dialog"],[1,"btn"],["method","dialog",1,"modal-backdrop"],[1,"btn","btn-outline","btn-warning","btn-sm",3,"click"],[1,"divider"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"label"],[1,"label-text","font-semibold"],["alt","\u8D0A\u52A9\u6191\u8B49",1,"max-w-3xs","w-full","rounded-lg","border","border-base-300","cursor-pointer","hover:opacity-80","transition",3,"click","src"],[1,"p-4","bg-base-200","rounded-lg"],[1,"text-sm","whitespace-pre-wrap"]],template:function(i,s){i&1&&(a(0,"div",1),c(1,xi,7,2,"div",2)(2,Pi,7,12),r(),X(3,Li,25,12,"ng-template",null,0,ke)),i&2&&(d(),m(s.authService.isAuthenticated()?2:1))},dependencies:[U,ge,Re,M,T,et,tt,ut,he],encapsulation:2});let e=o;return e})();export{Hn as MemberComponent};
