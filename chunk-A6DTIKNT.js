import{a as gt,b,c as ce,d as pe,e as Ve,f as Oe,g as O,h as z}from"./chunk-J7TIPUY3.js";import{a as ft}from"./chunk-TNYAEZNZ.js";import{A as te,B as ie,C as pt,D as ne,E as V,F as Le,G as oe,H as $,I as _t,J as Ct,K as H,L as Ie,M as X,N as me,e as ae,g as le,i as se,o as Ze,p as et,q as tt,t as Ne,v as de,y as mt,z as ct}from"./chunk-EFQITCNS.js";import{$ as g,$a as J,Ab as Je,Ac as ue,Bb as s,Cb as E,Db as A,Eb as Fe,Gb as Y,Ha as T,Hb as Z,Ib as ee,M as R,Ma as re,Mb as Xe,Nb as ge,O as j,Ob as xe,Oc as ot,Qb as he,R as De,Rb as Ke,Tc as rt,Ub as S,Vb as Te,W as v,Xa as m,Xb as I,Ya as c,Yb as F,Yc as at,Zc as lt,_c as ke,aa as x,ab as K,bb as p,c as k,cb as r,cd as st,db as l,eb as C,ed as Re,fb as Ae,fd as dt,gb as Ue,gd as ut,ha as w,hb as Qe,hd as q,ic as Pe,id as B,k as M,kb as Ce,kc as Ye,lb as y,lc as Me,mb as Ge,nb as f,nc as P,ob as He,pb as u,uc as it,va as L,vc as qe,ya as d,yb as fe,yc as nt,zb as W,zc as Be}from"./chunk-4R6RTNNY.js";import{a as we,h as D}from"./chunk-FJYW2LMB.js";var Nt=(e,n)=>({"border-warning bg-warning/10":e,"border-error bg-error/10":n}),qt=(e,n)=>({"text-warning":e,"text-error":n});function Bt(e,n){if(e&1){let t=y();r(0,"div",9)(1,"input",11),ee("ngModelChange",function(i){g(t);let a=u();return Z(a.editingName,i)||(a.editingName=i),x(i)}),f("keyup.enter",function(){g(t);let i=u();return x(i.saveEditing())})("keyup.escape",function(){g(t);let i=u();return x(i.cancelEditing())}),l(),r(2,"button",12),f("click",function(){g(t);let i=u();return x(i.saveEditing())}),C(3,"lucide-icon",3),l(),r(4,"button",13),f("click",function(){g(t);let i=u();return x(i.cancelEditing())}),C(5,"lucide-icon",3),l()()}if(e&2){let t=u();d(),Y("ngModel",t.editingName),d(2),p("img",t.Check)("size",16),d(2),p("img",t.X)("size",16)}}function kt(e,n){e&1&&(r(0,"span",14),s(1,"\u7BA1\u7406\u54E1"),l())}function Rt(e,n){e&1&&(r(0,"span",15),s(1,"\u8D0A\u52A9\u6703\u54E1"),l())}function Lt(e,n){e&1&&(r(0,"span",16),s(1,"\u514D\u8CBB\u6703\u54E1"),l())}function It(e,n){if(e&1&&(r(0,"div",10),s(1),r(2,"span"),m(3,kt,2,0,"span",14)(4,Rt,2,0,"span",15)(5,Lt,2,0,"span",16),l()()),e&2){let t=u();d(),A(" ",t.userDisplayName()," "),d(2),c(t.isAdmin()?3:t.isPremium()?4:5)}}function Vt(e,n){if(e&1&&(r(0,"div",5),C(1,"lucide-icon",6),r(2,"div")(3,"div",8),s(4,"Email"),l(),r(5,"div",17),s(6),l()()()),e&2){let t=u();d(),p("img",t.Mail)("size",20),d(5),E(t.userEmail())}}function Ot(e,n){if(e&1&&(r(0,"div",5),C(1,"lucide-icon",6),r(2,"div")(3,"div",8),s(4,"\u8A3B\u518A\u6642\u9593"),l(),r(5,"div",17),s(6),l()()()),e&2){let t=u();d(),p("img",t.Clock)("size",20),d(5),E(t.formattedCreatedAt())}}function zt(e,n){if(e&1&&(r(0,"div",20),s(1," \u6703\u54E1\u5373\u5C07\u5230\u671F "),l(),r(2,"div",17),s(3),l()),e&2){let t=u(3);d(3),Fe(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil(),"\uFF08\u5269\u9918 ",t.daysUntilExpiry()," \u5929\uFF09 ")}}function jt(e,n){if(e&1&&(r(0,"div",21),s(1,"\u6703\u54E1\u5DF2\u5230\u671F"),l(),r(2,"div",17),s(3),l()),e&2){let t=u(3);d(3),A(" \u5230\u671F\u65E5\uFF1A",t.formattedPremiumUntil()," ")}}function Wt(e,n){if(e&1&&(r(0,"div",18),C(1,"lucide-icon",19),r(2,"div"),m(3,zt,4,2)(4,jt,4,1),l()()),e&2){let t=u(2);p("ngClass",Xe(5,Nt,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),d(),p("img",t.Calendar)("size",20)("ngClass",Xe(8,qt,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0,t.daysUntilExpiry()!==null&&t.daysUntilExpiry()<=0)),d(2),c(t.daysUntilExpiry()!==null&&t.daysUntilExpiry()>0?3:4)}}function $t(e,n){if(e&1&&(r(0,"span",8),s(1),l()),e&2){let t=u(3);d(),A(" (\u5269\u9918 ",t.daysUntilExpiry()," \u5929) ")}}function Ht(e,n){if(e&1&&(r(0,"div",5),C(1,"lucide-icon",6),r(2,"div")(3,"div",8),s(4,"\u6703\u54E1\u5230\u671F\u65E5"),l(),r(5,"div",17),s(6),m(7,$t,2,1,"span",8),l()()()),e&2){let t=u(2);d(),p("img",t.Calendar)("size",20),d(5),A(" ",t.formattedPremiumUntil()," "),d(),c(t.daysUntilExpiry()!==null?7:-1)}}function Xt(e,n){if(e&1&&m(0,Wt,5,11,"div",18)(1,Ht,8,4,"div",5),e&2){let t=u();c(t.showExpiryWarning()?0:1)}}var bt=(()=>{let n=class n{constructor(){this.userDisplayName=F.required(),this.userEmail=F(null),this.isPremium=F(!1),this.isAdmin=F(!1),this.formattedCreatedAt=F(null),this.formattedPremiumUntil=F(null),this.daysUntilExpiry=F(null),this.showExpiryWarning=F(!1),this.displayNameChange=I(),this.isEditing=w(!1),this.editingName=w(""),this.Crown=ue,this.User=Re,this.Mail=ot,this.Calendar=it,this.Clock=Be,this.Pencil=rt,this.Check=qe,this.X=ut}startEditing(){this.editingName.set(this.userDisplayName()),this.isEditing.set(!0)}cancelEditing(){this.isEditing.set(!1),this.editingName.set("")}saveEditing(){let o=this.editingName().trim();o&&o!==this.userDisplayName()&&this.displayNameChange.emit(o),this.isEditing.set(!1)}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-profile"]],inputs:{userDisplayName:[1,"userDisplayName"],userEmail:[1,"userEmail"],isPremium:[1,"isPremium"],isAdmin:[1,"isAdmin"],formattedCreatedAt:[1,"formattedCreatedAt"],formattedPremiumUntil:[1,"formattedPremiumUntil"],daysUntilExpiry:[1,"daysUntilExpiry"],showExpiryWarning:[1,"showExpiryWarning"]},outputs:{displayNameChange:"displayNameChange"},decls:16,vars:8,consts:[[1,"card","bg-base-100","shadow-sm","mb-6"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4","mt-4"],[1,"flex","items-center","gap-3"],[1,"text-base-content/70",3,"img","size"],[1,"flex-1"],[1,"text-sm","text-base-content/70"],[1,"flex","items-center","gap-2","mt-1"],[1,"font-medium","flex","items-center","gap-2"],["type","text","maxlength","50",1,"input","input-bordered","input-sm","flex-1","max-w-xs",3,"ngModelChange","keyup.enter","keyup.escape","ngModel"],["title","\u4FDD\u5B58",1,"btn","btn-success","btn-sm","btn-square",3,"click"],["title","\u53D6\u6D88",1,"btn","btn-ghost","btn-sm","btn-square",3,"click"],[1,"badge","badge-soft","badge-error","badge-sm"],[1,"badge","badge-soft","badge-warning","badge-sm"],[1,"badge","badge-soft","badge-sm"],[1,"font-medium"],[1,"flex","items-center","gap-3","p-3","rounded-lg","border",3,"ngClass"],[3,"img","size","ngClass"],[1,"text-sm","text-warning","font-semibold"],[1,"text-sm","text-error","font-semibold"]],template:function(i,a){i&1&&(r(0,"div",0)(1,"div",1)(2,"h2",2),C(3,"lucide-icon",3),s(4," \u6703\u54E1\u8CC7\u8A0A "),l(),r(5,"div",4)(6,"div",5),C(7,"lucide-icon",6),r(8,"div",7)(9,"div",8),s(10,"\u4F7F\u7528\u8005\u540D\u7A31"),l(),m(11,Bt,6,5,"div",9)(12,It,6,2,"div",10),l()(),m(13,Vt,7,3,"div",5),m(14,Ot,7,3,"div",5),m(15,Xt,2,1),l()()()),i&2&&(d(3),p("img",a.User)("size",24),d(4),p("img",a.User)("size",20),d(4),c(a.isEditing()?11:12),d(2),c(a.userEmail()?13:-1),d(),c(a.formattedCreatedAt()?14:-1),d(),c(a.formattedPremiumUntil()?15:-1))},dependencies:[P,Pe,de,ae,le,Ne,se,B,q],encapsulation:2});let e=n;return e})();var vt=(()=>{let n=class n{constructor(){this.toastService=v(X),this.submitDonation=I(),this.donationProof=w(null),this.donationNote=w(""),this.Crown=ue,this.Upload=st}handleDonationProof(o){if(o.length===0)return;let i=o[0],a=new FileReader;a.onload=()=>{let _=a.result;this.donationProof.set(_)},a.onerror=()=>{this.toastService.error("\u6A94\u6848\u8B80\u53D6\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66")},a.readAsDataURL(i)}onSubmit(){let o=!!this.donationProof(),i=!!this.donationNote().trim();if(!o&&!i){this.toastService.error("\u8ACB\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u6216\u586B\u5BEB\u5099\u8A3B");return}this.submitDonation.emit({proof:this.donationProof()||"",note:this.donationNote()}),this.donationProof.set(null),this.donationNote.set("")}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-donation-form"]],outputs:{submitDonation:"submitDonation"},decls:27,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],[1,"text-base-content/70"],[1,"divider"],[1,"form-control"],[1,"label"],[1,"label-text","font-medium"],[3,"fileSelected","label","supportedFormats","accept","previewUrl"],[1,"form-control","mt-4"],["placeholder","\u8ACB\u8F38\u5165\u5099\u8A3B\uFF0C\u4F8B\u5982\uFF1A\u8F49\u5E33\u5E33\u865F\u5F8C\u4E94\u78BC\u3001\u8D0A\u52A9\u65E5\u671F\u7B49...","maxlength","500",1,"textarea","textarea-bordered","h-24","w-full",3,"ngModelChange","ngModel"],[1,"label","flex","justify-between"],[1,"label-text-alt"],[1,"card-actions","justify-end","mt-4"],["type","button",1,"btn","btn-warning","gap-2",3,"click","disabled"]],template:function(i,a){i&1&&(r(0,"div",0)(1,"div",1)(2,"h2",2),C(3,"lucide-icon",3),s(4," \u5347\u7D1A\u70BA\u8D0A\u52A9\u6703\u54E1 "),l(),r(5,"p",4),s(6," \u611F\u8B1D\u60A8\u7684\u652F\u6301\uFF01\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\u5F8C\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\u4E26\u5347\u7D1A\u60A8\u7684\u6703\u54E1\u7B49\u7D1A\u3002 "),l(),C(7,"div",5),r(8,"div",6)(9,"label",7)(10,"span",8),s(11,"\u8D0A\u52A9\u6191\u8B49"),l()(),r(12,"app-file-upload",9),f("fileSelected",function(h){return a.handleDonationProof(h)}),l()(),r(13,"div",10)(14,"label",7)(15,"span",8),s(16,"\u5099\u8A3B"),l()(),r(17,"textarea",11),ee("ngModelChange",function(h){return Z(a.donationNote,h)||(a.donationNote=h),h}),l(),r(18,"label",12)(19,"span",13),s(20,"\u63D0\u4F9B\u66F4\u591A\u8CC7\u8A0A\u6709\u52A9\u65BC\u6211\u5011\u66F4\u5FEB\u5B8C\u6210\u5BE9\u6838"),l(),r(21,"span",13),s(22),l()()(),r(23,"div",14)(24,"button",15),f("click",function(){return a.onSubmit()}),C(25,"lucide-icon",3),s(26," \u63D0\u4EA4\u8D0A\u52A9\u7533\u8ACB "),l()()()()),i&2&&(d(3),p("img",a.Crown)("size",24),d(9),p("label","\u4E0A\u50B3\u8D0A\u52A9\u6191\u8B49\uFF08\u8F49\u5E33\u622A\u5716\u6216\u6536\u64DA\uFF09")("supportedFormats","\u652F\u63F4 PNG\u3001JPG\u3001GIF")("accept","image/gif, image/jpeg, image/png")("previewUrl",a.donationProof()),d(5),Y("ngModel",a.donationNote),d(5),A("",a.donationNote().length," / 500"),d(2),p("disabled",!a.donationProof()&&!a.donationNote().trim()),d(),p("img",a.Upload)("size",18))},dependencies:[P,de,ae,le,Ne,se,B,q,ft],encapsulation:2});let e=n;return e})();var Qt={users:[],searchQuery:"",loading:!1,updating:!1,error:null},je=ce({providedIn:"root"},Oe(Qt),pe(({users:e,searchQuery:n})=>({totalUsers:S(()=>e().length),hasUsers:S(()=>e().length>0),filteredUsers:S(()=>{let t=n().toLowerCase().trim();return t?e().filter(o=>o.displayName?.toLowerCase().includes(t)||o.email?.toLowerCase().includes(t)):e()})})),Ve((e,n=v(Ie),t=v(X))=>({loadUsers:O(k(j(()=>b(e,{loading:!0,error:null})),R(o=>M(n.getAllUsers(o||void 0)).pipe(z({next:i=>b(e,{users:i,loading:!1}),error:i=>{b(e,{error:i.message||"\u8F09\u5165\u4F7F\u7528\u8005\u5217\u8868\u5931\u6557",loading:!1}),t.error("\u8F09\u5165\u4F7F\u7528\u8005\u5217\u8868\u5931\u6557")}}))))),updateUserRole:O(k(j(()=>b(e,{updating:!0,error:null})),R(({uid:o,role:i,premiumUntil:a})=>M(n.updateUserRole(o,i,a)).pipe(z({next:()=>{b(e,{updating:!1}),t.success("\u4F7F\u7528\u8005\u6B0A\u9650\u5DF2\u66F4\u65B0"),M(n.getAllUsers()).subscribe({next:_=>b(e,{users:_})})},error:_=>{b(e,{error:_.message||"\u66F4\u65B0\u4F7F\u7528\u8005\u6B0A\u9650\u5931\u6557",updating:!1}),t.error("\u66F4\u65B0\u4F7F\u7528\u8005\u6B0A\u9650\u5931\u6557")}}))))),deleteUser:O(k(j(()=>b(e,{updating:!0,error:null})),R(o=>M(n.deleteUser(o)).pipe(z({next:()=>{let i=e.users().filter(a=>a.uid!==o);b(e,{users:i,updating:!1}),t.success("\u4F7F\u7528\u8005\u5DF2\u522A\u9664")},error:i=>{b(e,{error:i.message||"\u522A\u9664\u4F7F\u7528\u8005\u5931\u6557",updating:!1}),t.error("\u522A\u9664\u4F7F\u7528\u8005\u5931\u6557")}}))))),clearError(){b(e,{error:null})},setSearchQuery(o){b(e,{searchQuery:o})}})));function Gt(e,n){if(e&1&&C(0,"img",5),e&2){let t=u();p("src",t.user().photoURL,L)("alt",t.user().displayName)}}function Jt(e,n){if(e&1){let t=y();r(0,"div",8)(1,"label",9)(2,"span",10),s(3,"\u8D0A\u52A9\u5230\u671F\u65E5"),l()(),r(4,"input",18),ee("ngModelChange",function(i){g(t);let a=u();return Z(a.premiumUntilDate,i)||(a.premiumUntilDate=i),x(i)}),l(),r(5,"label",9)(6,"span",19),s(7,"\u8A2D\u5B9A\u8D0A\u52A9\u6703\u54E1\u7684\u6709\u6548\u671F\u9650"),l()()()}if(e&2){let t=u();d(4),Y("ngModel",t.premiumUntilDate)}}var We=(()=>{let n=class n{constructor(){this.user=F.required(),this.save=I(),this.cancel=I(),this.selectedRole=w("free"),this.premiumUntilDate=w(""),Te(()=>{let i=this.user().platforms.quotation;if(this.selectedRole.set(i?.role||"free"),i?.premiumUntil){let a=i.premiumUntil.toDate();this.premiumUntilDate.set(a.toISOString().split("T")[0])}else this.premiumUntilDate.set("")})}handleCancel(){this.cancel.emit()}handleSave(){let o={role:this.selectedRole()};this.selectedRole()==="premium"&&this.premiumUntilDate()?o.premiumUntil=ct.fromDate(new Date(this.premiumUntilDate())):o.premiumUntil=null,this.save.emit(o)}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-edit-form"]],inputs:{user:[1,"user"]},outputs:{save:"save",cancel:"cancel"},decls:29,vars:5,consts:[[1,"font-bold","text-lg","mb-4"],[1,"mb-4","p-4","bg-base-200","rounded-lg"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-12","h-12","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"text-sm","text-base-content/60"],[1,"form-control","mb-4"],[1,"label"],[1,"label-text","font-medium"],[1,"select","select-bordered",3,"ngModelChange","ngModel"],["value","free"],["value","premium"],["value","admin"],[1,"flex","justify-end","gap-2","mt-6"],["type","button",1,"btn","btn-ghost",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","date",1,"input","input-bordered",3,"ngModelChange","ngModel"],[1,"label-text-alt"]],template:function(i,a){i&1&&(r(0,"h3",0),s(1,"\u7DE8\u8F2F\u4F7F\u7528\u8005\u6B0A\u9650"),l(),r(2,"div",1)(3,"div",2)(4,"div",3)(5,"div",4),m(6,Gt,1,2,"img",5),l()(),r(7,"div")(8,"div",6),s(9),l(),r(10,"div",7),s(11),l()()()(),r(12,"div",8)(13,"label",9)(14,"span",10),s(15,"\u89D2\u8272"),l()(),r(16,"select",11),ee("ngModelChange",function(h){return Z(a.selectedRole,h)||(a.selectedRole=h),h}),r(17,"option",12),s(18,"\u514D\u8CBB\u6703\u54E1"),l(),r(19,"option",13),s(20,"\u8D0A\u52A9\u6703\u54E1"),l(),r(21,"option",14),s(22,"\u7BA1\u7406\u54E1"),l()()(),m(23,Jt,8,1,"div",8),r(24,"div",15)(25,"button",16),f("click",function(){return a.handleCancel()}),s(26," \u53D6\u6D88 "),l(),r(27,"button",17),f("click",function(){return a.handleSave()}),s(28," \u5132\u5B58 "),l()()),i&2&&(d(6),c(a.user().photoURL?6:-1),d(3),E(a.user().displayName||"\u672A\u547D\u540D"),d(2),E(a.user().email),d(5),Y("ngModel",a.selectedRole),d(7),c(a.selectedRole()==="premium"?23:-1))},dependencies:[P,de,et,tt,ae,Ze,le,se],encapsulation:2});let e=n;return e})();function Et(e){return{free:"\u514D\u8CBB\u6703\u54E1",premium:"\u8D0A\u52A9\u6703\u54E1",admin:"\u7BA1\u7406\u54E1"}[e]||e}function yt(e){return{free:"badge-ghost",premium:"badge-warning",admin:"badge-error"}[e]||"badge-ghost"}function _e(e){if(!e)return"-";let n=e instanceof Date?e:e.toDate();return n.toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})+" "+n.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!1})}function be(e,n=new Date){if(!e)return null;let o=(e instanceof Date?e:e.toDate()).getTime()-n.getTime();return Math.ceil(o/(1e3*60*60*24))}function Kt(e){let n=e.platforms.quotation,t=n?.role||"free",o=n?.premiumUntil,i=be(o);return{user:e,displayName:e.displayName||"Unknown",email:e.email||"No Email",uidShort:e.uid.substring(0,8),role:t,roleDisplayName:Et(t),roleBadgeClass:yt(t),premiumUntilFormatted:o?_e(o):null,daysUntilExpiry:i,isExpired:t==="premium"&&i!==null&&i<0,createdAtFormatted:e.createdAt?_e(e.createdAt):"-"}}function St(e){return e.map(Kt)}var Yt=(e,n)=>n.user.uid;function Zt(e,n){e&1&&C(0,"span",7)}function ei(e,n){if(e&1&&C(0,"lucide-icon",5),e&2){let t=u();p("img",t.RefreshCw)("size",16)}}function ti(e,n){e&1&&(r(0,"div",11),C(1,"span",14),l())}function ii(e,n){if(e&1&&(r(0,"div",12),C(1,"lucide-icon",15),r(2,"p"),s(3,"\u76EE\u524D\u6C92\u6709\u4F7F\u7528\u8005\u8CC7\u6599"),l()()),e&2){let t=u();d(),p("img",t.Users)("size",48)}}function ni(e,n){if(e&1&&C(0,"img",24),e&2){let t=u().$implicit;p("src",t.user.photoURL,L)("alt",t.displayName)}}function oi(e,n){if(e&1&&(r(0,"span",26),C(1,"lucide-icon",5),s(2," \u8D0A\u52A9\u6703\u54E1\uFF08\u5DF2\u904E\u671F\uFF09 "),l()),e&2){let t=u(3);d(),p("img",t.Crown)("size",12)}}function ri(e,n){if(e&1&&C(0,"lucide-icon",5),e&2){let t=u(4);p("img",t.Shield)("size",12)}}function ai(e,n){if(e&1&&C(0,"lucide-icon",5),e&2){let t=u(4);p("img",t.Crown)("size",12)}}function li(e,n){if(e&1&&(r(0,"span",26),m(1,ri,1,2,"lucide-icon",5)(2,ai,1,2,"lucide-icon",5),s(3),l()),e&2){let t=u().$implicit;Je(t.roleBadgeClass),d(),c(t.role==="admin"?1:t.role==="premium"?2:-1),d(2),A(" ",t.roleDisplayName," ")}}function si(e,n){if(e&1&&(r(0,"div",33),s(1),l()),e&2){let t=u(2).$implicit;W("text-error",t.daysUntilExpiry<7)("text-warning",t.daysUntilExpiry>=7&&t.daysUntilExpiry<30),d(),A(" (\u5269\u9918 ",t.daysUntilExpiry," \u5929) ")}}function di(e,n){if(e&1&&(r(0,"div")(1,"div"),s(2),l(),m(3,si,2,5,"div",32),l()),e&2){let t=u().$implicit;d(2),E(t.premiumUntilFormatted),d(),c(t.daysUntilExpiry!==null&&t.daysUntilExpiry>0?3:-1)}}function ui(e,n){e&1&&(r(0,"span",28),s(1,"-"),l())}function mi(e,n){if(e&1){let t=y();r(0,"button",34),f("click",function(){g(t);let i=u().$implicit,a=u(2);return x(a.confirmDelete(i.user))}),s(1," \u522A\u9664 "),l()}}function ci(e,n){if(e&1){let t=y();r(0,"tr")(1,"td")(2,"div",21)(3,"div",22)(4,"div",23),m(5,ni,1,2,"img",24),l()(),r(6,"div")(7,"div",25),s(8),l()()()(),r(9,"td"),s(10),l(),r(11,"td"),m(12,oi,3,2,"span",26)(13,li,4,4,"span",27),l(),r(14,"td"),m(15,di,4,2,"div")(16,ui,2,0,"span",28),l(),r(17,"td"),s(18),l(),r(19,"td")(20,"div",29)(21,"button",30),f("click",function(){let i=g(t).$implicit,a=u(2);return x(a.startEdit(i.user))}),s(22," \u7DE8\u8F2F "),l(),m(23,mi,2,0,"button",31),l()()()}if(e&2){let t=n.$implicit;d(5),c(t.user.photoURL?5:-1),d(3),A(" ",t.displayName," "),d(2),E(t.email),d(2),c(t.isExpired?12:13),d(3),c(t.premiumUntilFormatted?15:16),d(3),E(t.createdAtFormatted),d(5),c(t.role==="free"?23:-1)}}function pi(e,n){if(e&1){let t=y();r(0,"div",16)(1,"table",17)(2,"thead")(3,"tr")(4,"th"),s(5,"\u4F7F\u7528\u8005"),l(),r(6,"th"),s(7,"Email"),l(),r(8,"th",18),s(9,"\u89D2\u8272"),l(),r(10,"th",19),s(11,"\u8D0A\u52A9\u5230\u671F\u65E5"),l(),r(12,"th",19),s(13,"\u8A3B\u518A\u6642\u9593"),l(),r(14,"th",19),s(15,"\u64CD\u4F5C"),l()()(),r(16,"tbody"),J(17,ci,24,7,"tr",null,Yt),l()()(),r(19,"app-pagination",20),f("pageChange",function(i){g(t);let a=u();return x(a.onPageChange(i))})("pageSizeChange",function(i){g(t);let a=u();return x(a.onPageSizeChange(i))}),l()}if(e&2){let t=u();d(17),K(t.paginatedUsersDisplay()),d(2),p("totalItems",t.totalUsers())("pageSize",t.pageSize())("currentPage",t.currentPage())}}function _i(e,n){if(e&1){let t=y();r(0,"dialog",13)(1,"div",35)(2,"app-user-edit-form",36),f("save",function(i){g(t);let a=u();return x(a.handleSave(i))})("cancel",function(){g(t);let i=u();return x(i.cancelEdit())}),l()(),r(3,"form",37),f("click",function(){g(t);let i=u();return x(i.cancelEdit())}),r(4,"button"),s(5,"close"),l()()()}if(e&2){let t=u();d(2),p("user",t.editingUser())}}var wt=(()=>{let n=class n{constructor(){this.usersStore=v(je),this.Users=dt,this.Crown=ue,this.Shield=ke,this.Search=lt,this.RefreshCw=at,this.currentPage=w(1),this.pageSize=w(10),this.editingUser=w(null),this.totalUsers=S(()=>this.usersStore.filteredUsers().length),this.hasUsers=S(()=>this.usersStore.users().length>0),this.paginatedUsersDisplay=S(()=>{let o=this.usersStore.filteredUsers(),i=this.currentPage(),a=this.pageSize(),_=(i-1)*a,h=_+a;return St(o.slice(_,h))})}ngOnInit(){this.usersStore.hasUsers()||this.usersStore.loadUsers()}onRefresh(){this.usersStore.loadUsers()}onPageChange(o){this.currentPage.set(o)}onPageSizeChange(o){this.pageSize.set(o),this.currentPage.set(1)}onSearchChange(o){this.usersStore.setSearchQuery(o),this.currentPage.set(1)}startEdit(o){this.editingUser.set(o)}cancelEdit(){this.editingUser.set(null)}handleSave(o){let i=this.editingUser();i&&(this.usersStore.updateUserRole({uid:i.uid,role:o.role,premiumUntil:o.premiumUntil?.toDate()??null}),this.cancelEdit())}confirmDelete(o){let i=o.displayName||o.email||o.uid;confirm(`\u78BA\u5B9A\u8981\u522A\u9664\u4F7F\u7528\u8005\u300C${i}\u300D\u55CE\uFF1F\u6B64\u64CD\u4F5C\u7121\u6CD5\u5FA9\u539F\u3002`)&&this.usersStore.deleteUser(o.uid)}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-user-list"]],decls:17,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"flex","flex-wrap","items-center","justify-between","gap-3","mb-4"],[1,"flex","items-center","gap-2"],[1,"card-title","flex","items-center","gap-2"],[3,"img","size"],["type","button","title","\u91CD\u65B0\u6574\u7406",1,"btn","btn-sm","btn-ghost","btn-square",3,"click","disabled"],[1,"loading","loading-spinner","loading-sm"],[1,"input","input-sm","input-bordered","flex","items-center","gap-2"],[1,"opacity-50",3,"img","size"],["type","search","placeholder","\u641C\u5C0B\u540D\u7A31\u6216 Email...",1,"grow",3,"input","value"],[1,"flex","justify-center","py-8"],[1,"text-center","py-8","text-base-content/60"],[1,"modal","modal-open"],[1,"loading","loading-spinner","loading-lg"],[1,"mx-auto","mb-2","opacity-30",3,"img","size"],[1,"overflow-x-auto"],[1,"table","table-zebra"],[1,"w-28"],[1,"w-32"],[3,"pageChange","pageSizeChange","totalItems","pageSize","currentPage"],[1,"flex","items-center","gap-3"],[1,"avatar"],[1,"w-10","h-10","rounded-full","bg-primary","text-primary-content"],["referrerpolicy","no-referrer",1,"object-cover",3,"src","alt"],[1,"font-medium"],[1,"badge","badge-soft","gap-1","whitespace-nowrap"],[1,"badge","badge-soft","gap-1","whitespace-nowrap",3,"class"],[1,"text-base-content/40"],[1,"join"],["type","button",1,"btn","btn-sm","btn-ghost","join-item",3,"click"],["type","button",1,"btn","btn-sm","btn-ghost","text-error","join-item"],[1,"text-xs",3,"text-error","text-warning"],[1,"text-xs"],["type","button",1,"btn","btn-sm","btn-ghost","text-error","join-item",3,"click"],[1,"modal-box"],[3,"save","cancel","user"],["method","dialog",1,"modal-backdrop",3,"click"]],template:function(i,a){i&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"h2",4),C(5,"lucide-icon",5),s(6," \u4F7F\u7528\u8005\u7BA1\u7406 "),l(),r(7,"button",6),f("click",function(){return a.onRefresh()}),m(8,Zt,1,0,"span",7)(9,ei,1,2,"lucide-icon",5),l()(),r(10,"label",8),C(11,"lucide-icon",9),r(12,"input",10),f("input",function(h){return a.onSearchChange(h.target.value)}),l()()(),m(13,ti,2,0,"div",11)(14,ii,4,2,"div",12)(15,pi,20,3),l()(),m(16,_i,6,1,"dialog",13)),i&2&&(d(5),p("img",a.Users)("size",24),d(2),W("btn-disabled",a.usersStore.loading()),p("disabled",a.usersStore.loading()),d(),c(a.usersStore.loading()?8:9),d(3),p("img",a.Search)("size",16),d(),p("value",a.usersStore.searchQuery()),d(),c(a.usersStore.loading()?13:a.hasUsers()?15:14),d(3),c(a.editingUser()?16:-1))},dependencies:[P,B,q,gt,We],encapsulation:2});let e=n;return e})();function Ci(e,n){if(e&1){let t=y();Ae(0,"dialog",0)(1,"div",1)(2,"h3",2),s(3),Ue(),Qe(4,"img",3),Ae(5,"div",4)(6,"button",5),He("click",function(){g(t);let i=u();return x(i.onClose())}),s(7,"\u95DC\u9589"),Ue()()(),Ae(8,"div",6),He("click",function(i){g(t);let a=u();return x(a.onBackdropClick(i))}),Ue()()}if(e&2){let t=u();d(3),E(t.title()),d(),Ge("src",t.proofUrl(),L)}}var Dt=(()=>{let n=class n{constructor(){this.isOpen=F(!1),this.proofUrl=F(""),this.title=F("\u8D0A\u52A9\u6191\u8B49"),this.close=I()}onClose(){this.close.emit()}onBackdropClick(o){o.target===o.currentTarget&&this.onClose()}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-proof-modal"]],inputs:{isOpen:[1,"isOpen"],proofUrl:[1,"proofUrl"],title:[1,"title"]},outputs:{close:"close"},decls:1,vars:1,consts:[[1,"modal","modal-open"],[1,"modal-box"],[1,"font-bold","text-lg","mb-4"],["alt","\u6191\u8B49","loading","lazy",1,"w-full","rounded-lg",3,"src"],[1,"modal-action"],[1,"btn",3,"click"],[1,"modal-backdrop",3,"click"]],template:function(i,a){i&1&&m(0,Ci,9,2,"dialog",0),i&2&&c(a.isOpen()?0:-1)},dependencies:[P],encapsulation:2});let e=n;return e})();var At=(()=>{let n=class n{constructor(){this.NOTIFICATION_URL=mt.googleSheets.notificationUrl}sendSponsorApprovalEmail(o,i){return D(this,null,function*(){if(!this.NOTIFICATION_URL){console.warn("GAS Web App URL not configured, skipping email notification");return}try{let a=yield fetch(this.NOTIFICATION_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"sendApprovalEmail",email:o,userName:i})});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);console.log("Sponsor approval email sent successfully")}catch(a){console.error("Failed to send sponsor approval email:",a)}})}};n.\u0275fac=function(i){return new(i||n)},n.\u0275prov=De({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var $e=(()=>{let n=class n{constructor(){this.firestoreService=v(Ie),this.notificationService=v(At),this.db=pt(),this.COLLECTION_NAME="donations"}createOrUpdateRequest(o,i,a,_,h,N=!1){return D(this,null,function*(){try{let U=te(this.db,this.COLLECTION_NAME),G=ne(U,V("uid","==",o)),ve=yield oe(G),Ee=H();if(ve.empty)yield Ct(U,{uid:o,userDisplayName:i,userEmail:a,proof:_,note:h,status:"pending",createdAt:Ee,updatedAt:Ee});else{let ye=ve.docs[0],Se=ye.data();if(Se.status==="pending")throw new Error("\u60A8\u7684\u7533\u8ACB\u6B63\u5728\u5BE9\u6838\u4E2D\uFF0C\u8ACB\u8010\u5FC3\u7B49\u5019");if(Se.status==="approved"){if(N)throw new Error("\u60A8\u5DF2\u7D93\u662F\u8D0A\u52A9\u6703\u54E1\u4E86");yield $(ie(this.db,this.COLLECTION_NAME,ye.id),{proof:_,note:h,status:"pending",updatedAt:Ee})}else(Se.status==="rejected"||Se.status==="expired")&&(yield $(ie(this.db,this.COLLECTION_NAME,ye.id),{proof:_,note:h,status:"pending",updatedAt:Ee}))}}catch(U){throw console.error("Failed to create or update donation request:",U),U}})}getPendingRequests(){return D(this,null,function*(){try{let o=te(this.db,this.COLLECTION_NAME),i=ne(o,V("status","==","pending"),Le("createdAt","desc"));return(yield oe(i)).docs.map(_=>we({id:_.id},_.data()))}catch(o){throw console.error("Failed to get pending requests:",o),o}})}getMyRequests(o){return D(this,null,function*(){try{let i=te(this.db,this.COLLECTION_NAME),a=ne(i,V("uid","==",o),V("status","in",["pending","rejected","expired"]),Le("createdAt","desc"));return(yield oe(a)).docs.map(h=>we({id:h.id},h.data()))}catch(i){throw console.error("Failed to get my requests:",i),i}})}withdrawRequest(o,i){return D(this,null,function*(){try{let a=ie(this.db,this.COLLECTION_NAME,o);yield $(a,{status:"rejected",reviewedBy:i,reviewedAt:H(),updatedAt:H()})}catch(a){throw console.error("Failed to withdraw request:",a),a}})}getProcessedRequests(){return D(this,null,function*(){try{let o=te(this.db,this.COLLECTION_NAME),i=ne(o,V("status","in",["approved","rejected"]),Le("updatedAt","desc"));return(yield oe(i)).docs.map(_=>we({id:_.id},_.data()))}catch(o){throw console.error("Failed to get processed requests:",o),o}})}resetRequestStatus(o){return D(this,null,function*(){try{let i=ie(this.db,this.COLLECTION_NAME,o);yield $(i,{status:"pending",updatedAt:H()})}catch(i){throw console.error("Failed to reset request status:",i),i}})}approveRequest(o,i,a,_,h){return D(this,null,function*(){try{let N=ie(this.db,this.COLLECTION_NAME,o),U=H();yield $(N,{status:"approved",reviewedBy:i,reviewedAt:U,updatedAt:U});let G=new Date;G.setMonth(G.getMonth()+1),yield this.firestoreService.updateUserRole(a,"premium",G),yield this.notificationService.sendSponsorApprovalEmail(_,h)}catch(N){throw console.error("Failed to approve request:",N),N}})}rejectRequest(o,i){return D(this,null,function*(){try{let a=ie(this.db,this.COLLECTION_NAME,o),_=H();yield $(a,{status:"rejected",reviewedBy:i,reviewedAt:_,updatedAt:_})}catch(a){throw console.error("Failed to reject request:",a),a}})}markAsExpired(o){return D(this,null,function*(){try{let i=te(this.db,this.COLLECTION_NAME),a=ne(i,V("uid","==",o),V("status","==","approved")),_=yield oe(a);if(!_.empty){let h=_.docs[0].ref;yield $(h,{status:"expired",updatedAt:H()})}}catch(i){throw console.error("Failed to mark request as expired:",i),i}})}deleteUserDonations(o){return D(this,null,function*(){try{let i=te(this.db,this.COLLECTION_NAME),a=ne(i,V("uid","==",o)),h=(yield oe(a)).docs.map(N=>_t(N.ref));yield Promise.all(h)}catch(i){throw console.error("Failed to delete user donations:",i),i}})}};n.\u0275fac=function(i){return new(i||n)},n.\u0275prov=De({token:n,factory:n.\u0275fac,providedIn:"root"});let e=n;return e})();var Ut=(e,n)=>n.id;function fi(e,n){if(e&1&&(r(0,"span",8),s(1),l()),e&2){let t=u();d(),E(t.pendingRequests().length)}}function gi(e,n){e&1&&C(0,"app-user-list")}function xi(e,n){if(e&1&&(r(0,"span",8),s(1),l()),e&2){let t=u(2);d(),E(t.pendingRequests().length)}}function hi(e,n){e&1&&(r(0,"div",12),C(1,"span",14),l())}function bi(e,n){if(e&1){let t=y();r(0,"tr")(1,"td"),s(2),xe(3,"date"),l(),r(4,"td")(5,"div",16),s(6),l(),r(7,"div",17),s(8),l()(),r(9,"td")(10,"button",18),f("click",function(){let i=g(t).$implicit,a=u(4);return x(a.openProofModal(i.proof))}),s(11," \u67E5\u770B\u6191\u8B49 "),l()(),r(12,"td",19),s(13),l(),r(14,"td")(15,"div",20)(16,"button",21),f("click",function(){let i=g(t).$implicit,a=u(4);return x(a.approveRequest(i))}),s(17," \u6838\u51C6 "),l(),r(18,"button",22),f("click",function(){let i=g(t).$implicit,a=u(4);return x(a.rejectRequest(i))}),s(19," \u62D2\u7D55 "),l()()()()}if(e&2){let t=n.$implicit;d(2),A(" ",he(3,4,t.createdAt.toDate(),"yyyy/MM/dd HH:mm")," "),d(4),E(t.userDisplayName),d(2),A(" ",t.userEmail," "),d(5),E(t.note||"-")}}function vi(e,n){e&1&&(r(0,"tr")(1,"td",23),s(2," \u76EE\u524D\u6C92\u6709\u5F85\u5BE9\u6838\u7684\u7533\u8ACB "),l()())}function Ei(e,n){if(e&1&&(r(0,"div",13)(1,"table",15)(2,"thead")(3,"tr")(4,"th"),s(5,"\u7533\u8ACB\u6642\u9593"),l(),r(6,"th"),s(7,"\u4F7F\u7528\u8005"),l(),r(8,"th"),s(9,"\u6191\u8B49"),l(),r(10,"th"),s(11,"\u5099\u8A3B"),l(),r(12,"th"),s(13,"\u64CD\u4F5C"),l()()(),r(14,"tbody"),J(15,bi,20,7,"tr",null,Ut),m(17,vi,3,0,"tr"),l()()()),e&2){let t=u(3);d(15),K(t.pendingRequests()),d(2),c(t.pendingRequests().length===0?17:-1)}}function yi(e,n){if(e&1&&m(0,hi,2,0,"div",12)(1,Ei,18,1,"div",13),e&2){let t=u(2);c(t.donationLoading()?0:1)}}function Si(e,n){e&1&&(r(0,"div",12),C(1,"span",14),l())}function wi(e,n){e&1&&(r(0,"span",24),s(1,"\u5DF2\u6838\u51C6"),l())}function Di(e,n){e&1&&(r(0,"span",25),s(1,"\u5DF2\u904E\u671F"),l())}function Ai(e,n){e&1&&(r(0,"span",26),s(1,"\u5DF2\u53D6\u6D88"),l())}function Ui(e,n){e&1&&(r(0,"span",27),s(1,"\u5DF2\u62D2\u7D55"),l())}function Fi(e,n){if(e&1){let t=y();r(0,"button",30),f("click",function(){g(t);let i=u().$implicit,a=u(4);return x(a.startEditFromRequest(i))}),s(1," \u7DE8\u8F2F "),l()}}function Ti(e,n){if(e&1){let t=y();r(0,"button",31),f("click",function(){g(t);let i=u().$implicit,a=u(4);return x(a.resetRequest(i))}),s(1," \u91CD\u65B0\u5BE9\u6838 "),l()}}function Pi(e,n){e&1&&(r(0,"span",17),s(1,"-"),l())}function Mi(e,n){if(e&1){let t=y();r(0,"tr")(1,"td"),s(2),xe(3,"date"),l(),r(4,"td")(5,"div",16),s(6),l(),r(7,"div",17),s(8),l()(),r(9,"td"),m(10,wi,2,0,"span",24)(11,Di,2,0,"span",25)(12,Ai,2,0,"span",26)(13,Ui,2,0,"span",27),l(),r(14,"td")(15,"button",18),f("click",function(){let i=g(t).$implicit,a=u(4);return x(a.openProofModal(i.proof))}),s(16," \u67E5\u770B\u6191\u8B49 "),l()(),r(17,"td",19),s(18),l(),r(19,"td"),m(20,Fi,2,0,"button",28)(21,Ti,2,0,"button",29)(22,Pi,2,0,"span",17),l()()}if(e&2){let t=n.$implicit;d(2),A(" ",he(3,6,t.updatedAt.toDate(),"yyyy/MM/dd HH:mm")," "),d(4),E(t.userDisplayName),d(2),A(" ",t.userEmail," "),d(2),c(t.status==="approved"?10:t.status==="expired"?11:t.reviewedBy===t.uid?12:13),d(8),E(t.note||"-"),d(2),c(t.status==="approved"?20:t.status==="rejected"&&t.reviewedBy!==t.uid?21:22)}}function Ni(e,n){e&1&&(r(0,"tr")(1,"td",32),s(2," \u76EE\u524D\u6C92\u6709\u5DF2\u8655\u7406\u7684\u7533\u8ACB "),l()())}function qi(e,n){if(e&1&&(r(0,"div",13)(1,"table",15)(2,"thead")(3,"tr")(4,"th"),s(5,"\u5BE9\u6838\u6642\u9593"),l(),r(6,"th"),s(7,"\u4F7F\u7528\u8005"),l(),r(8,"th"),s(9,"\u72C0\u614B"),l(),r(10,"th"),s(11,"\u6191\u8B49"),l(),r(12,"th"),s(13,"\u5099\u8A3B"),l(),r(14,"th"),s(15,"\u64CD\u4F5C"),l()()(),r(16,"tbody"),J(17,Mi,23,9,"tr",null,Ut),m(19,Ni,3,0,"tr"),l()()()),e&2){let t=u(3);d(17),K(t.processedRequests()),d(2),c(t.processedRequests().length===0?19:-1)}}function Bi(e,n){if(e&1&&m(0,Si,2,0,"div",12)(1,qi,20,1,"div",13),e&2){let t=u(2);c(t.donationLoading()?0:1)}}function ki(e,n){if(e&1){let t=y();r(0,"div",11)(1,"a",7),f("click",function(){g(t);let i=u();return x(i.switchDonationTab("pending"))}),s(2," \u5F85\u5BE9\u6838 "),m(3,xi,2,1,"span",8),l(),r(4,"a",7),f("click",function(){g(t);let i=u();return x(i.switchDonationTab("history"))}),s(5," \u5DF2\u8655\u7406 "),l()(),m(6,yi,2,1)(7,Bi,2,1)}if(e&2){let t=u();d(),W("tab-active",t.donationTab()==="pending"),d(2),c(t.pendingRequests().length>0?3:-1),d(),W("tab-active",t.donationTab()==="history"),d(2),c(t.donationTab()==="pending"?6:7)}}function Ri(e,n){if(e&1){let t=y();r(0,"dialog",10)(1,"div",33)(2,"app-user-edit-form",34),f("save",function(i){g(t);let a=u();return x(a.handleSaveEdit(i))})("cancel",function(){g(t);let i=u();return x(i.cancelEdit())}),l()(),r(3,"form",35),f("click",function(){g(t);let i=u();return x(i.cancelEdit())}),r(4,"button"),s(5,"close"),l()()()}if(e&2){let t=u();d(2),p("user",t.editingUser())}}var Ft=(()=>{let n=class n{constructor(){this.donationService=v($e),this.toastService=v(X),this.authService=v(me),this.usersStore=v(je),this.pendingRequests=w([]),this.processedRequests=w([]),this.activeTab=w("users"),this.donationTab=w("pending"),this.donationLoading=w(!1),this.isProofModalOpen=w(!1),this.selectedProofUrl=w(""),this.editingUser=w(null),this.Shield=ke}switchTab(o){this.activeTab.set(o),o==="donations"&&this.loadPendingRequests()}switchDonationTab(o){this.donationTab.set(o),o==="pending"?this.loadPendingRequests():this.loadProcessedRequests()}loadPendingRequests(){return D(this,null,function*(){this.donationLoading.set(!0);try{let o=yield this.donationService.getPendingRequests();this.pendingRequests.set(o)}catch(o){console.error("Failed to load pending requests:",o),this.toastService.error("\u8F09\u5165\u7533\u8ACB\u5931\u6557")}finally{this.donationLoading.set(!1)}})}loadProcessedRequests(){return D(this,null,function*(){this.donationLoading.set(!0);try{let o=yield this.donationService.getProcessedRequests();this.processedRequests.set(o)}catch(o){console.error("Failed to load processed requests:",o),this.toastService.error("\u8F09\u5165\u6B77\u53F2\u7D00\u9304\u5931\u6557")}finally{this.donationLoading.set(!1)}})}openProofModal(o){this.selectedProofUrl.set(o),this.isProofModalOpen.set(!0)}closeProofModal(){this.isProofModalOpen.set(!1),this.selectedProofUrl.set("")}approveRequest(o){return D(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u6838\u51C6 ${o.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{let i=this.authService.currentUser();if(!i)return;yield this.donationService.approveRequest(o.id,i.uid,o.uid,o.userEmail,o.userDisplayName),this.toastService.success("\u5DF2\u6838\u51C6\u7533\u8ACB"),yield this.loadPendingRequests(),this.usersStore.loadUsers()}catch(i){console.error("Failed to approve request:",i),this.toastService.error("\u6838\u51C6\u5931\u6557")}})}rejectRequest(o){return D(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u62D2\u7D55 ${o.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{let i=this.authService.currentUser();if(!i)return;yield this.donationService.rejectRequest(o.id,i.uid),this.toastService.success("\u5DF2\u62D2\u7D55\u7533\u8ACB"),yield this.loadPendingRequests()}catch(i){console.error("Failed to reject request:",i),this.toastService.error("\u62D2\u7D55\u5931\u6557")}})}resetRequest(o){return D(this,null,function*(){if(confirm(`\u78BA\u5B9A\u8981\u91CD\u65B0\u5BE9\u6838 ${o.userDisplayName} \u7684\u7533\u8ACB\u55CE\uFF1F`))try{yield this.donationService.resetRequestStatus(o.id),this.toastService.success("\u5DF2\u91CD\u65B0\u958B\u653E\u5BE9\u6838"),yield this.loadProcessedRequests()}catch(i){console.error("Failed to reset request:",i),this.toastService.error("\u91CD\u65B0\u5BE9\u6838\u5931\u6557")}})}startEditFromRequest(o){let a=this.usersStore.users().find(_=>_.uid===o.uid);a?this.editingUser.set(a):(this.usersStore.loadUsers(),this.toastService.info("\u8F09\u5165\u4F7F\u7528\u8005\u8CC7\u6599\u4E2D..."))}handleSaveEdit(o){let i=this.editingUser();i&&(this.usersStore.updateUserRole({uid:i.uid,role:o.role,premiumUntil:o.premiumUntil?.toDate()??null}),this.cancelEdit(),this.loadProcessedRequests())}cancelEdit(){this.editingUser.set(null)}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-admin-panel"]],decls:17,vars:11,consts:[[1,"card","bg-base-100","shadow-sm"],[1,"card-body"],[1,"flex","items-center","justify-between","mb-6"],[1,"flex","items-center","gap-2"],[1,"text-primary",3,"img","size"],[1,"card-title"],[1,"tabs","tabs-boxed"],[1,"tab",3,"click"],[1,"badge","badge-sm","badge-error","ml-1"],[3,"close","isOpen","proofUrl"],[1,"modal","modal-open"],[1,"tabs","tabs-boxed","mb-4"],[1,"flex","justify-center","items-center","py-12"],[1,"overflow-x-auto"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"table"],[1,"font-bold"],[1,"text-xs","opacity-50"],[1,"btn","btn-ghost","btn-xs","whitespace-nowrap",3,"click"],[1,"max-w-xs","truncate"],[1,"join"],[1,"btn","btn-success","btn-xs","join-item",3,"click"],[1,"btn","btn-error","btn-xs","join-item",3,"click"],["colspan","5",1,"text-center","py-8","text-base-content/50"],[1,"badge","badge-success","whitespace-nowrap"],[1,"badge","badge-warning","whitespace-nowrap"],[1,"badge","badge-ghost","whitespace-nowrap"],[1,"badge","badge-error","whitespace-nowrap"],[1,"btn","btn-ghost","btn-xs"],[1,"btn","btn-warning","btn-xs"],[1,"btn","btn-ghost","btn-xs",3,"click"],[1,"btn","btn-warning","btn-xs",3,"click"],["colspan","6",1,"text-center","py-8","text-base-content/50"],[1,"modal-box"],[3,"save","cancel","user"],["method","dialog",1,"modal-backdrop",3,"click"]],template:function(i,a){i&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),C(4,"lucide-icon",4),r(5,"h2",5),s(6,"\u7BA1\u7406\u54E1\u9762\u677F"),l()(),r(7,"div",6)(8,"a",7),f("click",function(){return a.switchTab("users")}),s(9," \u4F7F\u7528\u8005\u7BA1\u7406 "),l(),r(10,"a",7),f("click",function(){return a.switchTab("donations")}),s(11," \u8D0A\u52A9\u5BE9\u6838 "),m(12,fi,2,1,"span",8),l()()(),m(13,gi,1,0,"app-user-list")(14,ki,8,6),l()(),r(15,"app-proof-modal",9),f("close",function(){return a.closeProofModal()}),l(),m(16,Ri,6,1,"dialog",10)),i&2&&(d(4),p("img",a.Shield)("size",24),d(4),W("tab-active",a.activeTab()==="users"),d(2),W("tab-active",a.activeTab()==="donations"),d(2),c(a.pendingRequests().length>0?12:-1),d(),c(a.activeTab()==="users"?13:14),d(2),p("isOpen",a.isProofModalOpen())("proofUrl",a.selectedProofUrl()),d(),c(a.editingUser()?16:-1))},dependencies:[P,B,q,wt,Dt,We,Me],encapsulation:2});let e=n;return e})();var Tt={myRequests:[],loading:!1,submitting:!1,error:null},Pt=ce({providedIn:"root"},Oe(Tt),pe(({myRequests:e})=>({hasPendingRequest:S(()=>e().some(n=>n.status==="pending")),pendingRequest:S(()=>e().find(n=>n.status==="pending")),hasRequests:S(()=>e().length>0)})),Ve((e,n=v($e),t=v(X))=>({loadMyRequests:O(k(j(()=>b(e,{loading:!0,error:null})),R(o=>M(n.getMyRequests(o)).pipe(z({next:i=>b(e,{myRequests:i,loading:!1}),error:i=>{b(e,{error:i.message||"\u8F09\u5165\u7533\u8ACB\u5931\u6557",loading:!1})}}))))),submitRequest:O(k(j(()=>b(e,{submitting:!0,error:null})),R(({uid:o,displayName:i,email:a,proof:_,note:h,isPremium:N})=>M(n.createOrUpdateRequest(o,i,a,_,h,N)).pipe(z({next:()=>{b(e,{submitting:!1}),t.success("\u8D0A\u52A9\u7533\u8ACB\u5DF2\u9001\u51FA\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u5BE9\u6838\uFF01"),M(n.getMyRequests(o)).subscribe({next:U=>b(e,{myRequests:U})})},error:U=>{b(e,{error:U.message||"\u7533\u8ACB\u9001\u51FA\u5931\u6557",submitting:!1}),t.error(U.message||"\u7533\u8ACB\u9001\u51FA\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}}))))),withdrawRequest:O(k(j(()=>b(e,{submitting:!0,error:null})),R(({requestId:o,uid:i})=>M(n.withdrawRequest(o,i)).pipe(z({next:()=>{b(e,{submitting:!1}),t.success("\u5DF2\u64A4\u56DE\u7533\u8ACB"),M(n.getMyRequests(i)).subscribe({next:a=>b(e,{myRequests:a})})},error:a=>{b(e,{error:a.message||"\u64A4\u56DE\u5931\u6557",submitting:!1}),t.error("\u64A4\u56DE\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66")}}))))),markAsExpired:O(k(R(({uid:o,premiumUntil:i,role:a})=>i<new Date&&a==="free"?M(n.markAsExpired(o)).pipe(z({next:()=>{},error:_=>{console.error("Failed to mark as expired:",_)}})):M(Promise.resolve())))),initForUser(o,i){if(i)return;this.loadMyRequests(o.uid);let a=o.platforms?.quotation;a?.premiumUntil&&this.markAsExpired({uid:o.uid,premiumUntil:a.premiumUntil.toDate(),role:a.role||"free"})},clearError(){b(e,{error:null})},reset(){b(e,Tt)}})));var Mt=ce({providedIn:"root"},pe(()=>{let e=v(me);return{userData:S(()=>e.userData()),userDisplayName:S(()=>e.userDisplayName()),userEmail:S(()=>e.userEmail()),isPremium:S(()=>e.isPremium()),isAdmin:S(()=>e.isAdmin()),formattedCreatedAt:S(()=>{let n=e.userData()?.createdAt;return n?_e(n):null}),formattedPremiumUntil:S(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;return n?_e(n):null}),daysUntilExpiry:S(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;return be(n)}),showExpiryWarning:S(()=>{let n=e.userData()?.platforms.quotation?.premiumUntil;if(!n)return!1;let t=be(n);return t!==null&&t<=7}),currentRole:S(()=>e.userData()?.platforms.quotation?.role||"free")}}));var Li=(e,n,t,o)=>({request:e,requestId:n,status:"pending",icon:t,iconColor:"text-info",borderColor:"border-info",titleColor:"text-info",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u6B63\u5728\u5BE9\u6838\u4E2D",timeLabel:"\u63D0\u4EA4\u6642\u9593",time:o,message:"\u8ACB\u8010\u5FC3\u7B49\u5019\uFF0C\u6211\u5011\u6703\u5118\u5FEB\u8655\u7406\u60A8\u7684\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"pendingProofPreview"}),Ii=(e,n,t,o)=>({request:e,requestId:n,status:"cancelled",icon:t,iconColor:"text-base-content/50",borderColor:"border-base-content/20",titleColor:"text-base-content/70",title:"\u60A8\u5DF2\u53D6\u6D88\u7533\u8ACB",timeLabel:"\u53D6\u6D88\u6642\u9593",time:o,message:"\u60A8\u53EF\u4EE5\u96A8\u6642\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"cancelledProofPreview"}),Vi=(e,n,t,o)=>({request:e,requestId:n,status:"rejected",icon:t,iconColor:"text-error",borderColor:"border-error",titleColor:"text-error",title:"\u60A8\u7684\u8D0A\u52A9\u7533\u8ACB\u5DF2\u88AB\u62D2\u7D55",timeLabel:"\u5BE9\u6838\u6642\u9593",time:o,message:"\u60A8\u53EF\u4EE5\u4FEE\u6539\u6191\u8B49\u6216\u5099\u8A3B\u5F8C\u91CD\u65B0\u63D0\u4EA4\u7533\u8ACB\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u63D0\u4EA4\u7684\u8CC7\u6599",modalId:"rejectedProofPreview"}),Oi=(e,n,t,o)=>({request:e,requestId:n,status:"expired",icon:t,iconColor:"text-warning",borderColor:"border-warning",titleColor:"text-warning",title:"\u60A8\u7684\u8D0A\u52A9\u5DF2\u5230\u671F",timeLabel:"\u5230\u671F\u6642\u9593",time:o,message:"\u611F\u8B1D\u60A8\u904E\u53BB\u7684\u652F\u6301\uFF01\u60A8\u53EF\u4EE5\u91CD\u65B0\u7533\u8ACB\u7E8C\u7D04\u3002",sectionTitle:"\u60A8\u4E4B\u524D\u7684\u8D0A\u52A9\u8CC7\u6599",modalId:"expiredProofPreview"}),zi=(e,n)=>n.id;function ji(e,n){if(e&1&&(r(0,"div",2)(1,"div",3),C(2,"lucide-icon",4),r(3,"h2",5),s(4,"\u8ACB\u5148\u767B\u5165"),l(),r(5,"p"),s(6,"\u767B\u5165\u5F8C\u5373\u53EF\u67E5\u770B\u6703\u54E1\u8CC7\u8A0A"),l()()()),e&2){let t=u();d(2),p("img",t.User)("size",48)}}function Wi(e,n){e&1&&Ce(0)}function $i(e,n){if(e&1&&re(0,Wi,1,0,"ng-container",10),e&2){let t=u().$implicit,o=u(3),i=fe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ge(2,Li,t,t.id,o.Clock,t.createdAt))}}function Hi(e,n){e&1&&Ce(0)}function Xi(e,n){if(e&1&&re(0,Hi,1,0,"ng-container",10),e&2){let t=u(2).$implicit,o=u(3),i=fe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ge(2,Ii,t,t.id,o.CircleX,t.updatedAt))}}function Qi(e,n){e&1&&Ce(0)}function Gi(e,n){if(e&1&&re(0,Qi,1,0,"ng-container",10),e&2){let t=u(2).$implicit,o=u(3),i=fe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ge(2,Vi,t,t.id,o.CircleX,t.updatedAt))}}function Ji(e,n){if(e&1&&m(0,Xi,1,7,"ng-container")(1,Gi,1,7,"ng-container"),e&2){let t,o=u().$implicit,i=u(3);c(o.reviewedBy===((t=i.authService.currentUser())==null?null:t.uid)?0:1)}}function Ki(e,n){e&1&&Ce(0)}function Yi(e,n){if(e&1&&re(0,Ki,1,0,"ng-container",10),e&2){let t=u().$implicit,o=u(3),i=fe(4);p("ngTemplateOutlet",i)("ngTemplateOutletContext",ge(2,Oi,t,t.id,o.Clock,t.updatedAt))}}function Zi(e,n){if(e&1&&m(0,$i,1,7,"ng-container")(1,Ji,2,1)(2,Yi,1,7,"ng-container"),e&2){let t=n.$implicit;c(t.status==="pending"?0:t.status==="rejected"?1:t.status==="expired"?2:-1)}}function en(e,n){if(e&1&&J(0,Zi,3,1,null,null,zi),e&2){let t=u(2);K(t.donationsStore.myRequests())}}function tn(e,n){if(e&1){let t=y();r(0,"div",8)(1,"app-donation-form",11),f("submitDonation",function(i){g(t);let a=u(2);return x(a.handleDonationSubmit(i))}),l()()}}function nn(e,n){if(e&1&&(r(0,"div",9),C(1,"lucide-icon",12),r(2,"div")(3,"h3",13),s(4,"\u611F\u8B1D\u60A8\u7684\u8D0A\u52A9\uFF01"),l(),r(5,"div",14),s(6,"\u60A8\u5DF2\u7D93\u662F\u8D0A\u52A9\u6703\u54E1\uFF0C\u4EAB\u6709\u6240\u6709\u9032\u968E\u529F\u80FD\u3002"),l()()()),e&2){let t=u(2);d(),p("img",t.Check)("size",24)}}function on(e,n){e&1&&C(0,"app-admin-panel")}function rn(e,n){if(e&1){let t=y();r(0,"h1",6),s(1,"\u6703\u54E1\u4E2D\u5FC3"),l(),r(2,"app-user-profile",7),f("displayNameChange",function(i){g(t);let a=u();return x(a.handleDisplayNameChange(i))}),l(),m(3,en,2,0),m(4,tn,2,0,"div",8),m(5,nn,7,2,"div",9),m(6,on,1,0,"app-admin-panel")}if(e&2){let t=u();d(2),p("userDisplayName",t.profileStore.userDisplayName())("userEmail",t.profileStore.userEmail())("isPremium",t.profileStore.isPremium())("isAdmin",t.profileStore.isAdmin())("formattedCreatedAt",t.profileStore.formattedCreatedAt())("formattedPremiumUntil",t.profileStore.formattedPremiumUntil())("daysUntilExpiry",t.profileStore.daysUntilExpiry())("showExpiryWarning",t.profileStore.showExpiryWarning()),d(),c(!t.profileStore.isPremium()&&!t.profileStore.isAdmin()&&t.donationsStore.myRequests().length>0?3:-1),d(),c(!t.profileStore.isPremium()&&!t.profileStore.isAdmin()?4:-1),d(),c(t.profileStore.isPremium()?5:-1),d(),c(t.profileStore.isAdmin()?6:-1)}}function an(e,n){if(e&1&&(s(0),xe(1,"date")),e&2){let t=u(),o=t.timeLabel,i=t.time;Fe(" ",o,"\uFF1A",he(1,2,i.toDate(),"yyyy/MM/dd HH:mm")," ")}}function ln(e,n){if(e&1){let t=y();r(0,"div",23)(1,"button",32),f("click",function(){g(t);let i=u().requestId,a=u();return x(a.handleWithdraw(i))}),s(2," \u64A4\u56DE\u7533\u8ACB "),l()()}}function sn(e,n){if(e&1){let t=y();r(0,"div")(1,"label",35)(2,"span",36),s(3,"\u8D0A\u52A9\u6191\u8B49"),l()(),r(4,"img",37),f("click",function(){g(t);let i=u(2).modalId,a=u();return x(a.openProofModal(i))}),l()()}if(e&2){let t=u(2).request;d(4),p("src",t.proof,L)}}function dn(e,n){if(e&1&&(r(0,"div")(1,"label",35)(2,"span",36),s(3,"\u5099\u8A3B"),l()(),r(4,"div",38)(5,"p",39),s(6),l()()()),e&2){let t=u(2).request;d(6),E(t.note)}}function un(e,n){if(e&1&&(r(0,"div",33),s(1),l(),r(2,"div",34),m(3,sn,5,1,"div"),m(4,dn,7,1,"div"),l()),e&2){let t=u(),o=t.request,i=t.sectionTitle;d(),E(i),d(2),c(o.proof?3:-1),d(),c(o.note?4:-1)}}function mn(e,n){if(e&1&&(r(0,"div",15)(1,"div",16)(2,"div",17),C(3,"lucide-icon",18),r(4,"div",19)(5,"h3",20),s(6),l(),r(7,"p",21),m(8,an,2,5),l(),r(9,"p",22),s(10),l(),m(11,ln,3,0,"div",23),l()(),m(12,un,5,3),l()(),r(13,"dialog",24)(14,"div",25)(15,"h3",26),s(16,"\u8D0A\u52A9\u6191\u8B49"),l(),C(17,"img",27),r(18,"div",28)(19,"form",29)(20,"button",30),s(21,"\u95DC\u9589"),l()()()(),r(22,"form",31)(23,"button"),s(24,"close"),l()()()),e&2){let t=n.request,o=n.status,i=n.icon,a=n.iconColor,_=n.borderColor,h=n.titleColor,N=n.title,U=n.time,G=n.message,ve=n.modalId;p("ngClass",_),d(3),p("img",i)("size",32)("ngClass",a),d(2),p("ngClass",h),d(),E(N),d(2),c(U?8:-1),d(2),E(G),d(),c(o==="pending"?11:-1),d(),c(o!=="cancelled"?12:-1),d(),p("id",ve),d(4),p("src",t.proof,L)}}var Ko=(()=>{let n=class n{constructor(){this.authService=v(me),this.donationsStore=v(Pt),this.profileStore=v(Mt),this.User=Re,this.Check=qe,this.Clock=Be,this.CircleX=nt,Te(()=>{let o=this.profileStore.userData(),i=this.profileStore.isPremium(),a=this.profileStore.isAdmin();o&&!a&&this.donationsStore.initForUser(o,i)})}handleDonationSubmit(o){let i=this.authService.currentUser(),a=this.profileStore.userData();!i||!a||this.donationsStore.submitRequest({uid:i.uid,displayName:a.displayName||i.email||"Unknown",email:a.email||"No Email",proof:o.proof,note:o.note,isPremium:this.profileStore.isPremium()})}handleDisplayNameChange(o){return D(this,null,function*(){try{yield this.authService.updateDisplayName(o)}catch(i){console.error("Failed to update display name:",i)}})}handleWithdraw(o){if(!confirm("\u78BA\u5B9A\u8981\u64A4\u56DE\u7533\u8ACB\u55CE\uFF1F\u64A4\u56DE\u5F8C\u60A8\u53EF\u4EE5\u91CD\u65B0\u63D0\u4EA4\u3002"))return;let i=this.authService.currentUser();i&&this.donationsStore.withdrawRequest({requestId:o,uid:i.uid})}openProofModal(o){let i=document.getElementById(o);i&&i.showModal()}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=T({type:n,selectors:[["app-member"]],decls:5,vars:1,consts:[["requestStatusCard",""],[1,"mx-auto","px-4","py-8"],[1,"card","bg-base-100","shadow-sm"],[1,"card-body","text-center"],[1,"mx-auto","text-base-content/50",3,"img","size"],[1,"card-title","justify-center"],[1,"text-3xl","font-bold","mb-6"],[3,"displayNameChange","userDisplayName","userEmail","isPremium","isAdmin","formattedCreatedAt","formattedPremiumUntil","daysUntilExpiry","showExpiryWarning"],["id","donation-form"],[1,"alert","alert-success","alert-soft"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[3,"submitDonation"],[3,"img","size"],[1,"font-bold"],[1,"text-sm"],[1,"card","bg-base-100","shadow-sm","border-2","mb-6",3,"ngClass"],[1,"card-body"],[1,"flex","items-start","gap-4"],[1,"flex-shrink-0",3,"img","size","ngClass"],[1,"flex-1"],[1,"card-title",3,"ngClass"],[1,"text-sm","opacity-70","mt-1"],[1,"text-sm","mt-2"],[1,"mt-4"],[1,"modal",3,"id"],[1,"modal-box","max-w-4xl"],[1,"font-bold","text-lg","mb-4"],["alt","\u6191\u8B49",1,"w-full","rounded-lg",3,"src"],[1,"modal-action"],["method","dialog"],[1,"btn"],["method","dialog",1,"modal-backdrop"],[1,"btn","btn-outline","btn-warning","btn-sm",3,"click"],[1,"divider"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"label"],[1,"label-text","font-semibold"],["alt","\u8D0A\u52A9\u6191\u8B49",1,"max-w-3xs","w-full","rounded-lg","border","border-base-300","cursor-pointer","hover:opacity-80","transition",3,"click","src"],[1,"p-4","bg-base-200","rounded-lg"],[1,"text-sm","whitespace-pre-wrap"]],template:function(i,a){i&1&&(r(0,"div",1),m(1,ji,7,2,"div",2)(2,rn,7,12),l(),re(3,mn,25,12,"ng-template",null,0,Ke)),i&2&&(d(),c(a.authService.isAuthenticated()?2:1))},dependencies:[P,Pe,Ye,B,q,bt,vt,Ft,Me],encapsulation:2});let e=n;return e})();export{Ko as MemberComponent};
