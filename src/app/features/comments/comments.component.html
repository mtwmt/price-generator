<div class="comments-container max-w-4xl mx-auto p-4">
  <!-- æ¨™é¡Œèˆ‡æ’åº -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold">ğŸ’¬ ç•™è¨€è¨è«–</h2>

    <!-- æ’åºæŒ‰éˆ• (Giscus é¢¨æ ¼) -->
    <div class="flex items-center gap-2 text-sm">
      <button
        class="btn btn-ghost btn-sm"
        [class.btn-active]="sortOrder() === 'oldest'"
        (click)="store.setSortOrder('oldest'); loadComments()"
        [disabled]="store.loading()"
      >
        æœ€èˆŠ
      </button>
      <button
        class="btn btn-ghost btn-sm"
        [class.btn-active]="sortOrder() === 'newest'"
        (click)="store.setSortOrder('newest'); loadComments()"
        [disabled]="store.loading()"
      >
        æœ€æ–°
      </button>
    </div>
  </div>

  <!-- éŒ¯èª¤è¨Šæ¯ -->
  @if (store.error()) {
    <div class="alert alert-error mb-4">
      <span>{{ store.error() }}</span>
    </div>
  }

  <!-- æ–°å¢ç•™è¨€å€ -->
  @if (isAuthenticated()) {
    <div class="card bg-base-200 shadow-sm mb-6">
      <div class="card-body">
        <div class="flex items-start gap-3">
          <!-- ä½¿ç”¨è€…é ­åƒ -->
          @if (userPhotoURL()) {
            <div class="avatar">
              <div class="w-10 h-10 rounded-full">
                <img [src]="userPhotoURL()!" [alt]="userDisplayName()" />
              </div>
            </div>
          } @else {
            <div class="avatar placeholder">
              <div
                class="bg-neutral text-neutral-content w-10 h-10 rounded-full"
              >
                <span class="text-lg">{{ userDisplayName().charAt(0) }}</span>
              </div>
            </div>
          }

          <!-- è¼¸å…¥æ¡† -->
          <div class="flex-1">
            <textarea
              class="textarea textarea-bordered w-full"
              placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
              rows="3"
              [(ngModel)]="newCommentBody"
              [disabled]="store.loading()"
            ></textarea>
            <div class="flex justify-end mt-2">
              <button
                class="btn btn-primary btn-sm"
                (click)="postComment()"
                [disabled]="!newCommentBody().trim() || store.loading()"
              >
                @if (store.loading()) {
                  <span class="loading loading-spinner loading-xs"></span>
                }
                ç™¼å¸ƒç•™è¨€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="alert mb-6 flex justify-between items-center">
      <span
        >è«‹å…ˆ<button
          class="btn mx-2 btn-primary gap-2"
          (click)="loginWithGoogle()"
        >
          ç™»å…¥</button
        >æ‰èƒ½ç™¼è¡¨ç•™è¨€</span
      >
    </div>
  }

  <!-- è¼‰å…¥ä¸­ -->
  @if (store.loading() && store.comments().length === 0) {
    <div class="flex justify-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  <!-- ç•™è¨€åˆ—è¡¨ -->
  @if (store.comments().length > 0) {
    <div class="space-y-4">
      @for (comment of sortedComments; track comment.id) {
        <div class="comment-item">
          <!-- ä¸»ç•™è¨€ -->
          <div class="card bg-base-100 shadow-sm">
            <div class="card-body p-4">
              <div class="flex items-start gap-3">
                <!-- é ­åƒ -->
                @if (comment.authorAvatarUrl) {
                  <div class="avatar flex-shrink-0">
                    <div class="w-10 h-10 rounded-full">
                      <img
                        [src]="comment.authorAvatarUrl"
                        [alt]="comment.authorLogin"
                      />
                    </div>
                  </div>
                } @else {
                  <div class="avatar placeholder flex-shrink-0">
                    <div
                      class="bg-neutral text-neutral-content w-10 h-10 rounded-full"
                    >
                      <span class="text-lg">{{
                        comment.authorLogin.charAt(0)
                      }}</span>
                    </div>
                  </div>
                }

                <!-- å…§å®¹ -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold">{{ comment.authorLogin }}</span>
                    <span class="text-sm text-base-content/60">{{
                      comment.createdAt | timeAgo
                    }}</span>
                    @if (comment.isPinned) {
                      <span
                        class="badge badge-sm badge-soft badge-info gap-1"
                        title="ç½®é ‚ç•™è¨€"
                      >
                        <lucide-icon [img]="Pin" [size]="10" />
                        ç½®é ‚
                      </span>
                    }
                  </div>
                  <div
                    class="prose prose-sm max-w-none"
                    [innerHTML]="comment.bodyHTML | safeHtml"
                  ></div>

                  <!-- æ“ä½œæŒ‰éˆ• -->
                  <div class="flex items-center gap-2 mt-3 flex-wrap">
                    <!-- å·²æœ‰çš„åæ‡‰ -->
                    @for (
                      reaction of getActiveReactions(comment);
                      track reaction.type
                    ) {
                      <button
                        class="btn btn-ghost btn-xs gap-1"
                        (click)="toggleReaction(comment.id, reaction.type)"
                        [disabled]="store.loading() || !isAuthenticated()"
                        [title]="isAuthenticated() ? '' : 'è«‹å…ˆç™»å…¥'"
                      >
                        {{ reaction.emoji }}
                        {{ getReactionCount(comment, reaction.type) }}
                      </button>
                    }

                    <!-- æ–°å¢åæ‡‰æŒ‰éˆ• (dropdown) -->
                    @if (isAuthenticated()) {
                      <ng-container
                        *ngTemplateOutlet="
                          reactionPicker;
                          context: { commentId: comment.id }
                        "
                      ></ng-container>
                    }

                    <div class="divider divider-horizontal mx-0"></div>

                    @if (isAuthenticated()) {
                      <button
                        class="btn btn-ghost btn-xs"
                        (click)="startReply(comment.id)"
                        [disabled]="store.loading()"
                      >
                        ğŸ’¬ å›è¦†
                      </button>
                    }

                    @if (isAdmin()) {
                      <button
                        class="btn btn-ghost btn-xs"
                        [class.text-warning]="comment.isPinned"
                        (click)="togglePin(comment.id)"
                        [disabled]="store.loading()"
                        [title]="comment.isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚ç•™è¨€'"
                      >
                        <lucide-icon
                          [img]="comment.isPinned ? PinOff : Pin"
                          [size]="14"
                        />
                      </button>
                      <button
                        class="btn btn-ghost btn-xs text-error"
                        (click)="deleteComment(comment.id)"
                        [disabled]="store.loading()"
                      >
                        ğŸ—‘ï¸ åˆªé™¤
                      </button>
                    }
                  </div>

                  <!-- å›è¦†åˆ—è¡¨ (Giscus é¢¨æ ¼) -->
                  @if (comment.replies && comment.replies.length > 0) {
                    <div class="mt-4 space-y-4">
                      @for (reply of comment.replies; track reply.id) {
                        <div class="flex gap-3 pl-4 border-l-2 border-base-300">
                          @if (reply.authorAvatarUrl) {
                            <div class="avatar flex-shrink-0">
                              <div class="w-8 h-8 rounded-full">
                                <img
                                  [src]="reply.authorAvatarUrl"
                                  [alt]="reply.authorLogin"
                                />
                              </div>
                            </div>
                          } @else {
                            <div class="avatar placeholder flex-shrink-0">
                              <div
                                class="bg-neutral text-neutral-content w-8 h-8 rounded-full"
                              >
                                <span class="text-sm">{{
                                  reply.authorLogin.charAt(0)
                                }}</span>
                              </div>
                            </div>
                          }

                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="font-semibold text-sm">{{
                                reply.authorLogin
                              }}</span>
                              <span class="text-xs text-base-content/60">{{
                                reply.createdAt | timeAgo
                              }}</span>
                            </div>
                            <div
                              class="prose prose-sm max-w-none text-sm mb-2"
                              [innerHTML]="reply.bodyHTML | safeHtml"
                            ></div>

                            <div class="flex items-center gap-2">
                              <!-- å·²æœ‰çš„åæ‡‰ -->
                              @for (
                                reaction of getActiveReactions(reply);
                                track reaction.type
                              ) {
                                <button
                                  class="btn btn-ghost btn-xs gap-1"
                                  (click)="
                                    toggleReaction(reply.id, reaction.type)
                                  "
                                  [disabled]="
                                    store.loading() || !isAuthenticated()
                                  "
                                  [title]="isAuthenticated() ? '' : 'è«‹å…ˆç™»å…¥'"
                                >
                                  {{ reaction.emoji }}
                                  {{ getReactionCount(reply, reaction.type) }}
                                </button>
                              }

                              <!-- æ–°å¢åæ‡‰æŒ‰éˆ• (dropdown) -->
                              @if (isAuthenticated()) {
                                <ng-container
                                  *ngTemplateOutlet="
                                    reactionPicker;
                                    context: { commentId: reply.id }
                                  "
                                ></ng-container>
                              }
                              @if (isAdmin()) {
                                <button
                                  class="btn btn-ghost btn-xs text-error"
                                  (click)="deleteComment(reply.id)"
                                  [disabled]="store.loading()"
                                >
                                  ğŸ—‘ï¸ åˆªé™¤
                                </button>
                              }
                            </div>
                          </div>
                        </div>
                      }

                      <!-- åŠ å…¥å›è¦†æŒ‰éˆ• -->
                      @if (isAuthenticated() && replyingTo() !== comment.id) {
                        <button
                          class="btn btn-ghost btn-sm"
                          (click)="startReply(comment.id)"
                          [disabled]="store.loading()"
                        >
                          â• åŠ å…¥å›è¦†...
                        </button>
                      }
                    </div>
                  }

                  <!-- å›è¦†è¼¸å…¥æ¡† (åœ¨æ‰€æœ‰å›è¦†ä¸‹æ–¹) -->
                  @if (replyingTo() === comment.id) {
                    <div class="mt-4 pl-4 border-l-2 border-primary">
                      <textarea
                        class="textarea textarea-bordered textarea-sm w-full"
                        placeholder="è¼¸å…¥å›è¦†..."
                        rows="2"
                        [(ngModel)]="replyBody"
                        [disabled]="store.loading()"
                      ></textarea>
                      <div class="flex justify-end gap-2 mt-2">
                        <button
                          class="btn btn-ghost btn-sm"
                          (click)="cancelReply()"
                          [disabled]="store.loading()"
                        >
                          å–æ¶ˆ
                        </button>
                        <button
                          class="btn btn-primary btn-sm"
                          (click)="postReply(comment.id)"
                          [disabled]="!replyBody().trim() || store.loading()"
                        >
                          é€å‡ºå›è¦†
                        </button>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- åˆ†é  -->
    @if (totalComments() > pageSize) {
      <div class="flex justify-center mt-6">
        <app-pagination
          [totalItems]="totalComments()"
          [pageSize]="pageSize"
          [currentPage]="currentPage()"
          [showPageSizeSelector]="false"
          [showInfo]="false"
          size="sm"
          (pageChange)="onPageChange($event)"
        />
      </div>
    }
  } @else if (!store.loading()) {
    <div class="text-center py-8 text-base-content/60">
      <p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€,æˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§!</p>
    </div>
  }
</div>

<!-- åæ‡‰é¸æ“‡å™¨ Template -->
<ng-template #reactionPicker let-commentId="commentId">
  <details class="dropdown" #reactionDropdown>
    <summary class="btn btn-ghost btn-xs">
      <lucide-icon [img]="Smile" [size]="16"></lucide-icon>
    </summary>
    <ul
      class="dropdown-content menu flex-row p-2 shadow-sm bg-base-100 rounded-box w-40 z-[1]"
    >
      <li class="menu-title w-full">
        <span>é¸æ“‡æ‚¨çš„åæ‡‰</span>
      </li>
      @for (reaction of availableReactions; track reaction.type) {
        <li class="w-1/3">
          <a (click)="selectReaction(commentId, reaction.type)">
            {{ reaction.emoji }}
          </a>
        </li>
      }
    </ul>
  </details>
</ng-template>
