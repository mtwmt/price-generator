"use strict";

(function () {
  var $modal = document.querySelector('#modal');
  var $preview = document.querySelector('#preview');
  var $form = document.querySelector('form#form');
  var $inputs = document.querySelectorAll('input, textarea, select'); // common fn

  var _common = common(),
      setAmount = _common.setAmount,
      setTotal = _common.setTotal; // validate


  var _verify = verify(),
      constraints = _verify.constraints,
      setItemFormValidate = _verify.setItemFormValidate,
      showErrorsForInput = _verify.showErrorsForInput,
      handleFormSubmit = _verify.handleFormSubmit; // modal view


  var _modalView = modalView(),
      createModal = _modalView.createModal;

  var delItem = function delItem(row) {
    row.querySelector('.delItem').addEventListener('click', function (e) {
      e.preventDefault();

      if (document.querySelectorAll('[data-item]').length > 1) {
        this.parentElement.parentElement.remove();
        setTotal();
      }

      setItemFormValidate();
    });
  };

  var updateItemRow = function updateItemRow(row) {
    row.querySelectorAll('input').forEach(function (e, i) {
      e.addEventListener('change', function (ev) {
        setAmount(row);
        setTotal();
        var errors = validate($form, constraints) || {};
        showErrorsForInput(e, errors[e.name]);
      });
    });
    delItem(row);
  };
  /**
   * formData
   * @returns 表單資料
   */


  var formData = function formData() {
    var _$form$querySelector;

    var logoFile = (_$form$querySelector = $form.querySelector('[name=logo]')) === null || _$form$querySelector === void 0 ? void 0 : _$form$querySelector.files[0];
    var getLogo = !!logoFile ? URL.createObjectURL(logoFile) : null;
    var data = {
      logo: getLogo,
      company: $form.querySelector('[name=company]').value,
      taxID: $form.querySelector('[name=taxID]').value,
      name: $form.querySelector('[name=name]').value,
      phone: $form.querySelector('[name=phone]').value,
      email: $form.querySelector('[name=email]').value,
      startDate: $form.querySelector('[name=startDate]').value,
      endDate: $form.querySelector('[name=endDate]').value,
      desc: $form.querySelector('[name=desc]').value,
      total: $form.querySelector('#total-price').textContent,
      items: []
    };
    $form.querySelectorAll('[data-item]').forEach(function (e, index) {
      data.items.push({
        category: e.querySelector("[name*=category").value,
        item: e.querySelector("[name*=item").value,
        price: e.querySelector("[name*=price").value,
        count: e.querySelector("[name*=count").value,
        unit: e.querySelector("[name*=unit").value,
        amount: e.querySelector("[name*=amount]").value
      });
    });
    return data;
  };

  var exportTemplate = function exportTemplate(tmp) {
    var data = formData();
    var modalBody = tmp.querySelector('.modal-main');
    modalBody.insertAdjacentHTML('beforeend', createModal(data));
  };

  var resetExportTemplate = function resetExportTemplate(tmp) {
    tmp.querySelector('.modal-main').textContent = '';
  }; //======== document init ========


  $form.querySelectorAll('[data-item]').forEach(function (e) {
    updateItemRow(e);
    setItemFormValidate();
  });
  $inputs.forEach(function (e, i) {
    e.addEventListener('change', function (ev) {
      var errors = validate($form, constraints) || {};
      showErrorsForInput(e, errors[e.name]);
    });
  }); // add item row

  $form.querySelector('#addItem').addEventListener('click', function (e) {
    e.preventDefault();
    var row = $form.querySelector('[data-item]');
    var newRow = row.cloneNode(true);
    newRow.querySelectorAll('input').forEach(function (e) {
      e.value = e.defaultValue;
      e.classList.remove('is-invalid');
      e.parentNode.querySelectorAll('.invalid-feedback').forEach(function (el) {
        el.remove();
      });
    });
    $form.querySelector('[data-items]').append(newRow);
    updateItemRow(newRow);
    setItemFormValidate();
  }); // on preview

  $preview.addEventListener('show.bs.modal', function (e) {
    exportTemplate(this);
  });
  $preview.addEventListener('hidden.bs.modal', function (e) {
    e.preventDefault();
    resetExportTemplate(this);
  }); // on Submit

  $modal.addEventListener('show.bs.modal', function (e) {
    if (!handleFormSubmit($form)) {
      e.preventDefault();
      resetExportTemplate(this);
    } else {
      exportTemplate(this);
    }
  });
  $modal.addEventListener('hidden.bs.modal', function (e) {
    e.preventDefault();
    resetExportTemplate(this);
  }); // =========== Export ============

  $modal.querySelector('#exportImage').addEventListener('click', function () {
    var preview = $modal.querySelector('.modal-content'); // export Image

    html2canvas(preview).then(function (canvas) {
      document.body.appendChild(canvas);
      var $a = document.createElement('a');
      $a.href = canvas.toDataURL('image/jpeg').replace('image/jpeg', 'image/octet-stream');
      $a.download = ''.concat(new Date().toLocaleString('roc', {
        hour12: false
      }), '_quotation.jpg');
      $a.click();
    });
  }); // =========== Print ==============

  $modal.querySelector('#print').addEventListener('click', function () {
    var jsPDF = window.jspdf.jsPDF;
    var print = $modal.querySelector('.modal-content'); // export pdf

    html2canvas(print).then(function (canvas) {
      var pdfImage = canvas.toDataURL();
      var doc = new jsPDF();
      doc.addImage(pdfImage, 'JPEG', 10, 10, 0, 0);
      doc.save(new Date().toLocaleString('roc', {
        hour12: false
      }) + '_quotation.pdf');
    });
  });
})();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiJG1vZGFsIiwiZG9jdW1lbnQiLCJxdWVyeVNlbGVjdG9yIiwiJHByZXZpZXciLCIkZm9ybSIsIiRpbnB1dHMiLCJxdWVyeVNlbGVjdG9yQWxsIiwiY29tbW9uIiwic2V0QW1vdW50Iiwic2V0VG90YWwiLCJ2ZXJpZnkiLCJjb25zdHJhaW50cyIsInNldEl0ZW1Gb3JtVmFsaWRhdGUiLCJzaG93RXJyb3JzRm9ySW5wdXQiLCJoYW5kbGVGb3JtU3VibWl0IiwibW9kYWxWaWV3IiwiY3JlYXRlTW9kYWwiLCJkZWxJdGVtIiwicm93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImxlbmd0aCIsInBhcmVudEVsZW1lbnQiLCJyZW1vdmUiLCJ1cGRhdGVJdGVtUm93IiwiZm9yRWFjaCIsImkiLCJldiIsImVycm9ycyIsInZhbGlkYXRlIiwibmFtZSIsImZvcm1EYXRhIiwibG9nb0ZpbGUiLCJmaWxlcyIsImdldExvZ28iLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJkYXRhIiwibG9nbyIsImNvbXBhbnkiLCJ2YWx1ZSIsInRheElEIiwicGhvbmUiLCJlbWFpbCIsInN0YXJ0RGF0ZSIsImVuZERhdGUiLCJkZXNjIiwidG90YWwiLCJ0ZXh0Q29udGVudCIsIml0ZW1zIiwiaW5kZXgiLCJwdXNoIiwiY2F0ZWdvcnkiLCJpdGVtIiwicHJpY2UiLCJjb3VudCIsInVuaXQiLCJhbW91bnQiLCJleHBvcnRUZW1wbGF0ZSIsInRtcCIsIm1vZGFsQm9keSIsImluc2VydEFkamFjZW50SFRNTCIsInJlc2V0RXhwb3J0VGVtcGxhdGUiLCJuZXdSb3ciLCJjbG9uZU5vZGUiLCJkZWZhdWx0VmFsdWUiLCJjbGFzc0xpc3QiLCJwYXJlbnROb2RlIiwiZWwiLCJhcHBlbmQiLCJwcmV2aWV3IiwiaHRtbDJjYW52YXMiLCJ0aGVuIiwiY2FudmFzIiwiYm9keSIsImFwcGVuZENoaWxkIiwiJGEiLCJjcmVhdGVFbGVtZW50IiwiaHJlZiIsInRvRGF0YVVSTCIsInJlcGxhY2UiLCJkb3dubG9hZCIsImNvbmNhdCIsIkRhdGUiLCJ0b0xvY2FsZVN0cmluZyIsImhvdXIxMiIsImNsaWNrIiwianNQREYiLCJ3aW5kb3ciLCJqc3BkZiIsInByaW50IiwicGRmSW1hZ2UiLCJkb2MiLCJhZGRJbWFnZSIsInNhdmUiXSwibWFwcGluZ3MiOiI7O0FBQUEsQ0FBQyxZQUFZO0FBQ1gsTUFBTUEsTUFBTSxHQUFHQyxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsUUFBdkIsQ0FBZjtBQUNBLE1BQU1DLFFBQVEsR0FBR0YsUUFBUSxDQUFDQyxhQUFULENBQXVCLFVBQXZCLENBQWpCO0FBQ0EsTUFBTUUsS0FBSyxHQUFHSCxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsV0FBdkIsQ0FBZDtBQUNBLE1BQU1HLE9BQU8sR0FBR0osUUFBUSxDQUFDSyxnQkFBVCxDQUEwQix5QkFBMUIsQ0FBaEIsQ0FKVyxDQU1YOztBQU5XLGdCQU9xQkMsTUFBTSxFQVAzQjtBQUFBLE1BT0hDLFNBUEcsV0FPSEEsU0FQRztBQUFBLE1BT1FDLFFBUFIsV0FPUUEsUUFQUixFQVNYOzs7QUFUVyxnQkFlUEMsTUFBTSxFQWZDO0FBQUEsTUFXVEMsV0FYUyxXQVdUQSxXQVhTO0FBQUEsTUFZVEMsbUJBWlMsV0FZVEEsbUJBWlM7QUFBQSxNQWFUQyxrQkFiUyxXQWFUQSxrQkFiUztBQUFBLE1BY1RDLGdCQWRTLFdBY1RBLGdCQWRTLEVBaUJYOzs7QUFqQlcsbUJBa0JhQyxTQUFTLEVBbEJ0QjtBQUFBLE1Ba0JIQyxXQWxCRyxjQWtCSEEsV0FsQkc7O0FBb0JYLE1BQU1DLE9BQU8sR0FBRyxTQUFWQSxPQUFVLENBQUNDLEdBQUQsRUFBUztBQUN2QkEsSUFBQUEsR0FBRyxDQUFDaEIsYUFBSixDQUFrQixVQUFsQixFQUE4QmlCLGdCQUE5QixDQUErQyxPQUEvQyxFQUF3RCxVQUFVQyxDQUFWLEVBQWE7QUFDbkVBLE1BQUFBLENBQUMsQ0FBQ0MsY0FBRjs7QUFDQSxVQUFJcEIsUUFBUSxD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QUEwQixLQUExQixFQUFpQztBQUFFQyxRQUFBQSxNQUFNLEVBQUU7QUFBVixPQUFqQyxJQUFzRCxnQkFEeEQ7QUFHRCxLQVBEO0FBUUQsR0FaRDtBQWFELENBaExEIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcclxuICBjb25zdCAkbW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjbW9kYWwnKTtcclxuICBjb25zdCAkcHJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwcmV2aWV3Jyk7XHJcbiAgY29uc3QgJGZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdmb3JtI2Zvcm0nKTtcclxuICBjb25zdCAkaW5wdXRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKTtcclxuXHJcbiAgLy8gY29tbW9uIGZuXHJcbiAgY29uc3QgeyBzZXRBbW91bnQsIHNldFRvdGFsIH0gPSBjb21tb24oKTtcclxuXHJcbiAgLy8gdmFsaWRhdGVcclxuICBjb25zdCB7XHJcbiAgICBjb25zdHJhaW50cyxcclxuICAgIHNldEl0ZW1Gb3JtVmFsaWRhdGUsXHJcbiAgICBzaG93RXJyb3JzRm9ySW5wdXQsXHJcbiAgICBoYW5kbGVGb3JtU3VibWl0LFxyXG4gIH0gPSB2ZXJpZnkoKTtcclxuXHJcbiAgLy8gbW9kYWwgdmlld1xyXG4gIGNvbnN0IHsgY3JlYXRlTW9kYWwgfSA9IG1vZGFsVmlldygpO1xyXG5cclxuICBjb25zdCBkZWxJdGVtID0gKHJvdykgPT4ge1xyXG4gICAgcm93LnF1ZXJ5U2VsZWN0b3IoJy5kZWxJdGVtJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pdGVtXScpLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICB0aGlzLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICBzZXRUb3RhbCgpO1xyXG4gICAgICB9XHJcbiAgICAgIHNldEl0ZW1Gb3JtVmFsaWRhdGUoKTtcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0IHVwZGF0ZUl0ZW1Sb3cgPSAocm93KSA9PiB7XHJcbiAgICByb3cucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQnKS5mb3JFYWNoKChlLCBpKSA9PiB7XHJcbiAgICAgIGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGV2KSA9PiB7XHJcbiAgICAgICAgc2V0QW1vdW50KHJvdyk7XHJcbiAgICAgICAgc2V0VG90YWwoKTtcclxuICAgICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0ZSgkZm9ybSwgY29uc3RyYWludHMpIHx8IHt9O1xyXG4gICAgICAgIHNob3dFcnJvcnNGb3JJbnB1dChlLCBlcnJvcnNbZS5uYW1lXSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBkZWxJdGVtKHJvdyk7XHJcbiAgfTtcclxuXHJcbiAgLyoqXHJcbiAgICogZm9ybURhdGFcclxuICAgKiBAcmV0dXJucyDooajllq7os4fmlplcclxuICAgKi9cclxuICBjb25zdCBmb3JtRGF0YSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IGxvZ29GaWxlID0gJGZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9bG9nb10nKT8uZmlsZXNbMF07XHJcbiAgICBjb25zdCBnZXRMb2dvID0gISFsb2dvRmlsZSA/IFVSTC5jcmVhdGVPYmplY3RVUkwobG9nb0ZpbGUpIDogbnVsbDtcclxuXHJcbiAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICBsb2dvOiBnZXRMb2dvLFxyXG4gICAgICBjb21wYW55OiAkZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1jb21wYW55XScpLnZhbHVlLFxyXG4gICAgICB0YXhJRDogJGZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9dGF4SURdJykudmFsdWUsXHJcbiAgICAgIG5hbWU6ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPW5hbWVdJykudmFsdWUsXHJcbiAgICAgIHBob25lOiAkZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1waG9uZV0nKS52YWx1ZSxcclxuICAgICAgZW1haWw6ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPWVtYWlsXScpLnZhbHVlLFxyXG4gICAgICBzdGFydERhdGU6ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPXN0YXJ0RGF0ZV0nKS52YWx1ZSxcclxuICAgICAgZW5kRGF0ZTogJGZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9ZW5kRGF0ZV0nKS52YWx1ZSxcclxuICAgICAgZGVzYzogJGZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9ZGVzY10nKS52YWx1ZSxcclxuICAgICAgdG90YWw6ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJyN0b3RhbC1wcmljZScpLnRleHRDb250ZW50LFxyXG4gICAgICBpdGVtczogW10sXHJcbiAgICB9O1xyXG5cclxuICAgICRmb3JtLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWl0ZW1dJykuZm9yRWFjaCgoZSwgaW5kZXgpID0+IHtcclxuICAgICAgZGF0YS5pdGVtcy5wdXNoKHtcclxuICAgICAgICBjYXRlZ29yeTogZS5xdWVyeVNlbGVjdG9yKGBbbmFtZSo9Y2F0ZWdvcnlgKS52YWx1ZSxcclxuICAgICAgICBpdGVtOiBlLnF1ZXJ5U2VsZWN0b3IoYFtuYW1lKj1pdGVtYCkudmFsdWUsXHJcbiAgICAgICAgcHJpY2U6IGUucXVlcnlTZWxlY3RvcihgW25hbWUqPXByaWNlYCkudmFsdWUsXHJcbiAgICAgICAgY291bnQ6IGUucXVlcnlTZWxlY3RvcihgW25hbWUqPWNvdW50YCkudmFsdWUsXHJcbiAgICAgICAgdW5pdDogZS5xdWVyeVNlbGVjdG9yKGBbbmFtZSo9dW5pdGApLnZhbHVlLFxyXG4gICAgICAgIGFtb3VudDogZS5xdWVyeVNlbGVjdG9yKGBbbmFtZSo9YW1vdW50XWApLnZhbHVlLFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgZXhwb3J0VGVtcGxhdGUgPSBmdW5jdGlvbih0bXApIHtcclxuICAgIGNvbnN0IGRhdGEgPSBmb3JtRGF0YSgpO1xyXG4gICAgY29uc3QgbW9kYWxCb2R5ID0gdG1wLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC1tYWluJyk7XHJcblxyXG4gICAgbW9kYWxCb2R5Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgY3JlYXRlTW9kYWwoZGF0YSkpO1xyXG4gIH07XHJcbiAgY29uc3QgcmVzZXRFeHBvcnRUZW1wbGF0ZSA9IGZ1bmN0aW9uKHRtcCkge1xyXG4gICAgdG1wLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC1tYWluJykudGV4dENvbnRlbnQgPSAnJztcclxuICB9XHJcblxyXG4gIC8vPT09PT09PT0gZG9jdW1lbnQgaW5pdCA9PT09PT09PVxyXG4gIFxyXG4gICRmb3JtLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWl0ZW1dJykuZm9yRWFjaCgoZSkgPT4ge1xyXG4gICAgdXBkYXRlSXRlbVJvdyhlKTtcclxuICAgIHNldEl0ZW1Gb3JtVmFsaWRhdGUoKTtcclxuICB9KTtcclxuXHJcbiAgJGlucHV0cy5mb3JFYWNoKChlLCBpKSA9PiB7XHJcbiAgICBlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChldikgPT4ge1xyXG4gICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0ZSgkZm9ybSwgY29uc3RyYWludHMpIHx8IHt9O1xyXG4gICAgICBzaG93RXJyb3JzRm9ySW5wdXQoZSwgZXJyb3JzW2UubmFtZV0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIGFkZCBpdGVtIHJvd1xyXG4gICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJyNhZGRJdGVtJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgY29uc3Qgcm93ID0gJGZvcm0ucXVlcnlTZWxlY3RvcignW2RhdGEtaXRlbV0nKTtcclxuICAgIGNvbnN0IG5ld1JvdyA9IHJvdy5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgICBuZXdSb3cucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQnKS5mb3JFYWNoKChlKSA9PiB7XHJcbiAgICAgIGUudmFsdWUgPSBlLmRlZmF1bHRWYWx1ZTtcclxuICAgICAgZS5jbGFzc0xpc3QucmVtb3ZlKCdpcy1pbnZhbGlkJyk7XHJcbiAgICAgIGUucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuaW52YWxpZC1mZWVkYmFjaycpLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgZWwucmVtb3ZlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJGZvcm0ucXVlcnlTZWxlY3RvcignW2RhdGEtaXRlbXNdJykuYXBwZW5kKG5ld1Jvdyk7XHJcbiAgICB1cGRhdGVJdGVtUm93KG5ld1Jvdyk7XHJcbiAgICBzZXRJdGVtRm9ybVZhbGlkYXRlKCk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIG9uIHByZXZpZXdcclxuICAkcHJldmlldy5hZGRFdmVudExpc3RlbmVyKCdzaG93LmJzLm1vZGFsJywgZnVuY3Rpb24gKGUpIHtcclxuICAgIGV4cG9ydFRlbXBsYXRlKHRoaXMpO1xyXG4gIH0pO1xyXG4gICRwcmV2aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ2hpZGRlbi5icy5tb2RhbCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICByZXNldEV4cG9ydFRlbXBsYXRlKHRoaXMpXHJcbiAgfSk7XHJcblxyXG4gIC8vIG9uIFN1Ym1pdFxyXG4gICRtb2RhbC5hZGRFdmVudExpc3RlbmVyKCdzaG93LmJzLm1vZGFsJywgZnVuY3Rpb24gKGUpIHtcclxuICAgIGlmICghaGFuZGxlRm9ybVN1Ym1pdCgkZm9ybSkpIHtcclxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICByZXNldEV4cG9ydFRlbXBsYXRlKHRoaXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZXhwb3J0VGVtcGxhdGUodGhpcyk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gICRtb2RhbC5hZGRFdmVudExpc3RlbmVyKCdoaWRkZW4uYnMubW9kYWwnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgcmVzZXRFeHBvcnRUZW1wbGF0ZSh0aGlzKTtcclxuICB9KTtcclxuXHJcbiAgLy8gPT09PT09PT09PT0gRXhwb3J0ID09PT09PT09PT09PVxyXG4gICRtb2RhbC5xdWVyeVNlbGVjdG9yKCcjZXhwb3J0SW1hZ2UnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IHByZXZpZXcgPSAkbW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsLWNvbnRlbnQnKTtcclxuICAgIC8vIGV4cG9ydCBJbWFnZVxyXG4gICAgaHRtbDJjYW52YXMocHJldmlldykudGhlbihmdW5jdGlvbiAoY2FudmFzKSB7XHJcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcclxuICAgICAgY29uc3QgJGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgICAgICRhLmhyZWYgPSBjYW52YXNcclxuICAgICAgICAudG9EYXRhVVJMKCdpbWFnZS9qcGVnJylcclxuICAgICAgICAucmVwbGFjZSgnaW1hZ2UvanBlZycsICdpbWFnZS9vY3RldC1zdHJlYW0nKTtcclxuICAgICAgJGEuZG93bmxvYWQgPSAnJy5jb25jYXQoXHJcbiAgICAgICAgbmV3IERhdGUoKS50b0xvY2FsZVN0cmluZygncm9jJywgeyBob3VyMTI6IGZhbHNlIH0pLFxyXG4gICAgICAgICdfcXVvdGF0aW9uLmpwZydcclxuICAgICAgKTtcclxuICAgICAgJGEuY2xpY2soKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICAvLyA9PT09PT09PT09PSBQcmludCA9PT09PT09PT09PT09PVxyXG4gICRtb2RhbC5xdWVyeVNlbGVjdG9yKCcjcHJpbnQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IHsganNQREYgfSA9IHdpbmRvdy5qc3BkZjtcclxuICAgIGNvbnN0IHByaW50ID0gJG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC1jb250ZW50Jyk7XHJcbiAgICAvLyBleHBvcnQgcGRmXHJcbiAgICBodG1sMmNhbnZhcyhwcmludCkudGhlbihmdW5jdGlvbiAoY2FudmFzKSB7XHJcbiAgICAgIGNvbnN0IHBkZkltYWdlID0gY2FudmFzLnRvRGF0YVVSTCgpO1xyXG4gICAgICBjb25zdCBkb2MgPSBuZXcganNQREYoKTtcclxuICAgICAgZG9jLmFkZEltYWdlKHBkZkltYWdlLCAnSlBFRycsIDEwLCAxMCwgMCwgMCk7XHJcbiAgICAgIGRvYy5zYXZlKFxyXG4gICAgICAgIG5ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoJ3JvYycsIHsgaG91cjEyOiBmYWxzZSB9KSArICdfcXVvdGF0aW9uLnBkZidcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KSgpO1xyXG4iXSwiZmlsZSI6Im1haW4uanMifQ==
